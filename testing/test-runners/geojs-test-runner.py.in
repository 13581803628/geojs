#!/usr/bin/env python

import sys
import subprocess
import threading

if sys.version_info[0] == 2:
    import SocketServer
    import SimpleHTTPServer
elif sys.version_info[0] == 3:
    import socketserver as SocketServer
    from http import server as SimpleHTTPServer
else:
    raise Exception("Unsupported python version")


HOST = "@TESTING_HOST@"
PORT = @TESTING_PORT@


class Server(SocketServer.TCPServer):
    allow_reuse_address = True


def main():
    status = 1
    server = Server(
        (HOST, PORT),
        SimpleHTTPServer.SimpleHTTPRequestHandler
    )

    server_thread = threading.Thread(target=server.serve_forever)
    server_thread.start()

    try:
        status = subprocess.call(sys.argv[1:])
    finally:
        server.shutdown()
        server_thread.join()

    return status

if __name__ == "__main__":
    sys.exit(main())
