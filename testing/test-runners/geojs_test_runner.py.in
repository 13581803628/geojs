#!/usr/bin/env python

import time
import sys
import subprocess
import threading

if sys.version_info[0] == 2:
    import SocketServer
    import SimpleHTTPServer
elif sys.version_info[0] == 3:
    import socketserver as SocketServer
    from http import server as SimpleHTTPServer
else:
    raise Exception("Unsupported python version")

HTTPHandler = SimpleHTTPServer.SimpleHTTPRequestHandler

from blanket_server import Handler as BlanketHandler


HOST = "@TESTING_HOST@"
PORT = @TESTING_PORT@
server = None


class Handler(BlanketHandler, HTTPHandler):

    def do_GET(self):
        if self.path == '/coverage':
            BlanketHandler.do_GET(self)
        else:
            HTTPHandler.do_GET(self)

    def do_PUT(self):
        if self.path == '/coverage':
            BlanketHandler.do_PUT(self)
        else:
            HTTPHandler.do_PUT(self)


class _Server(SocketServer.ThreadingMixIn, SocketServer.TCPServer):
    allow_reuse_address = True


class TestServer(object):

    @classmethod
    def start(cls, host='localhost', port='8000'):
        cls.server = _Server(
            (host, port),
            Handler
        )
        cls.server_thread = threading.Thread(target=cls.server.serve_forever)
        cls.server_thread.start()

        time.sleep(0.5)

    @classmethod
    def stop(cls):
        cls.server.shutdown()
        cls.server_thread.join(1)


def main():
    status = 1

    testServer = TestServer()
    testServer.start(HOST, PORT)
    try:
        status = subprocess.call(sys.argv[1:])
    finally:
        testServer.stop()

    return status

if __name__ == "__main__":
    sys.exit(main())
