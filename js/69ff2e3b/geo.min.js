var ogs;ogs=window&&void 0!==window.ogs?window.ogs:{},ogs.namespace=function(e){"use strict";var t,i=e.split("."),r=ogs;for("ogs"===i[0]&&(i=i.slice(1)),t=0;t<i.length;t+=1)void 0===r[i[t]]&&(r[i[t]]={}),r=r[i[t]];return r},geo=ogs.namespace("geo"),geo.renderers={},geo.features={},inherit=function(e,t){"use strict";var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.uber=t.prototype,e.prototype.constructor=e},Object.size=function(e){"use strict";var t=0,i=null;for(i in e)e.hasOwnProperty(i)&&(t+=1);return t},geo.registerRenderer=function(e,t){"use strict";void 0===geo.renderers&&(geo.renderers={}),geo.renderers[e]=t},geo.createRenderer=function(e,t,i){"use strict";if(geo.renderers.hasOwnProperty(e)){var r=geo.renderers[e]({layer:t,canvas:i});return r._init(),r}return null},geo.registerFeature=function(e,t,i){"use strict";void 0===geo.features&&(geo.features={}),e in geo.features||(geo.features[e]={}),geo.features[e][t]=i},geo.createFeature=function(e,t,i,r){"use strict";var n=i.api(),o={layer:t,renderer:i};return n in geo.features&&e in geo.features[n]?(void 0!==r&&$.extend(!0,o,r),geo.features[n][e](o)):null},geo.registerLayer=function(e,t){"use strict";void 0===geo.layers&&(geo.layers={}),geo.layers[e]=t},geo.createLayer=function(e,t,i){"use strict";var r={map:t,renderer:"vglRenderer"},n=null;return e in geo.layers?(void 0!==i&&$.extend(!0,r,i),n=geo.layers[e](r),n._init(),n):null},geo.object=function(){"use strict";if(!(this instanceof geo.object))return new geo.object;var e=this,t={};return this.on=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.on(t,r)}),this):(t.hasOwnProperty(i)||(t[i]=[]),t[i].push(r),this)},this.trigger=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.trigger(t,r)}),this):(t.hasOwnProperty(i)&&t[i].forEach(function(e){e(r)}),this)},this.off=function(i,r){if(Array.isArray(i))return i.forEach(function(t){e.off(t,r)}),this;if(r){if(Array.isArray(r))return r.forEach(function(t){e.off(i,t)}),this}else t[i]=[];return t.hasOwnProperty(i)&&(t[i]=t[i].filter(function(e){return e!==r})),this},vgl.object.call(this),this},inherit(geo.object,vgl.object),geo.sceneObject=function(e){"use strict";if(!(this instanceof geo.sceneObject))return new geo.sceneObject;geo.object.call(this,e);var t=this,i=null,r=[],n=this.trigger;return this.parent=function(e){return void 0===e?i:(i=e,this)},this.addChild=function(e){return Array.isArray(e)?(e.forEach(this.addChild),this):(e.parent(this),r.push(e),this)},this.removeChild=function(e){return Array.isArray(e)?(e.forEach(this.removeChild),this):(r=r.filter(function(t){return t!==e}),this)},this.children=function(){return r.slice()},this.trigger=function(e,o){return o=o||{},i&&o._triggeredBy!==i?(o._triggeredBy=t,i.trigger(e,o),this):(n.call(this,e,o),r.forEach(function(i){o._triggeredBy=t,i.trigger(e,o)}),this)},this},inherit(geo.sceneObject,geo.object),geo.timestamp=function(){"use strict";return this instanceof geo.timestamp?void vgl.timestamp.call(this):new geo.timestamp},inherit(geo.timestamp,vgl.timestamp),geo.ellipsoid=function(e,t,i){"use strict";if(!(this instanceof geo.ellipsoid))return new geo.ellipsoid(e,t,i);if(e=vgl.defaultValue(e,0),t=vgl.defaultValue(t,0),i=vgl.defaultValue(i,0),0>e||0>t||0>i)return console.log("[error] Al radii components must be greater than zero");var r=new vec3.fromValues(e,t,i),n=new vec3.fromValues(e*e,t*t,i*i),o=Math.min(e,t,i),a=Math.max(e,t,i);return this.radii=function(){return r},this.radiiSquared=function(){return n},this.maximumRadius=function(){return a},this.minimumRadius=function(){return o},this.computeGeodeticSurfaceNormal=function(e,t){if("undefined"==typeof e||"undefined"==typeof t)throw"[error] Valid latitude and longitude is required";var i=Math.cos(e),r=vec3.create();return r[0]=i*Math.cos(t),r[1]=i*Math.sin(t),r[2]=Math.sin(e),vec3.normalize(r,r),r},this.transformPoint=function(e,t,i){e*=Math.PI/180,t*=Math.PI/180;var r=this.computeGeodeticSurfaceNormal(e,t),o=vec3.create(),a=Math.sqrt(vec3.dot(r,o)),s=vec3.create();return vec3.multiply(o,n,r),vec3.scale(o,o,1/a),vec3.scale(r,r,i),vec3.add(s,r,o),s},this.transformGeometry=function(e){if(!e)throw"[error] Failed to transform to cartesian. Invalid geometry.";var t=e.sourceData(vgl.vertexAttributeKeys.Position),i=t.data(),r=t.attributeNumberOfComponents(vgl.vertexAttributeKeys.Position),o=t.attributeStride(vgl.vertexAttributeKeys.Position),a=t.attributeOffset(vgl.vertexAttributeKeys.Position),s=t.sizeOfAttributeDataType(vgl.vertexAttributeKeys.Position),l=null,u=i.length*(1/r),h=null,d=null,c=0,g=vec3.create(),f=vec3.create();if(o/=s,a/=s,3!==r)throw"[error] Requires positions with three components";for(c=0;u>c;c+=1)l=c*o+a,i[l]=i[l]*(Math.PI/180),i[l+1]=i[l+1]*(Math.PI/180),d=this.computeGeodeticSurfaceNormal(i[l+1],i[l]),vec3.multiply(g,n,d),h=Math.sqrt(vec3.dot(d,g)),vec3.scale(g,g,1/h),vec3.scale(d,d,i[l+2]),vec3.add(f,d,g),i[l]=f[0],i[l+1]=f[1],i[l+2]=f[2]},this},geo.ellipsoid.WGS84=vgl.freezeObject(geo.ellipsoid(6378137,6378137,6356752.314245179)),geo.ellipsoid.UNIT_SPHERE=vgl.freezeObject(geo.ellipsoid(1,1,1)),geo.mercator={r_major:6378137},geo.mercator.r_minor=function(e){"use strict";var t;return e=void 0!==e?e:!1,t=e?6378137:6356752.314245179},geo.mercator.f=function(e){"use strict";return(geo.mercator.r_major-geo.mercator.r_minor(e))/geo.mercator.r_major},geo.mercator.long2tilex=function(e,t){"use strict";var i=(e+180)/360,r=Math.floor(i*Math.pow(2,t));return r},geo.mercator.lat2tiley=function(e,t){"use strict";var i=e*Math.PI/180;return Math.floor((1-i/Math.PI)/2*Math.pow(2,t))},geo.mercator.long2tilex2=function(e,t){"use strict";var i=(e+180)/360,r=i*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.lat2tiley2=function(e,t){"use strict";var i=e*Math.PI/180,r=(1-Math.log(Math.tan(i)+1/Math.cos(i))/Math.PI)/2*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.tilex2long=function(e,t){"use strict";return e/Math.pow(2,t)*360-180},geo.mercator.tiley2lat=function(e,t){"use strict";var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},geo.mercator.y2lat=function(e){"use strict";return 180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2)},geo.mercator.lat2y=function(e){"use strict";return 180/Math.PI*Math.log(Math.tan(Math.PI/4+e*(Math.PI/180)/2))},geo.mercator.deg2rad=function(e){"use strict";var t=e*(Math.PI/180);return t},geo.mercator.rad2deg=function(e){"use strict";var t=e/(Math.PI/180);return t},geo.mercator.ll2m=function(e,t,i){"use strict";t>89.5&&(t=89.5),-89.5>t&&(t=-89.5);var r=this.r_major*this.deg2rad(e),n=this.r_minor(i)/this.r_major,o=1-n*n,a=Math.sqrt(o),s=this.deg2rad(t),l=Math.sin(s),u=a*l,h=.5*a,d=Math.pow((1-u)/(1+u),h),c=Math.tan(.5*(.5*Math.PI-s))/d,g=-this.r_major*Math.log(c),f={x:r,y:g};return f},geo.mercator.m2ll=function(e,t,i){"use strict";var r=this.rad2deg(e/this.r_major),n=this.r_minor(i)/this.r_major,o=Math.sqrt(1-n*n),a=this.rad2deg(this.pjPhi2(Math.exp(-(t/this.r_major)),o)),s={lon:r,lat:a};return s},geo.mercator.pjPhi2=function(e,t){"use strict";var i,r,n=15,o=Math.PI/2,a=1e-10,s=n,l=.5*t,u=o-2*Math.atan(e);do i=t*Math.sin(u),r=o-2*Math.atan(e*Math.pow((1-i)/(1+i),l))-u,u+=r,s-=1;while(Math.abs(r)>a&&s);return u},geo.latlng=function(e,t){"use strict";if(!(this instanceof geo.latlng))return new geo.latlng(e,t);var i=void 0===t?e.lat():e,r=void 0===t?e.lng():t;return this.lat=function(e){return void 0===e?i:void(i=e)},this.lng=function(e){return void 0===e?r:void(r=e)},this.x=function(e){return void 0===e?this.lng():void(r=e)},this.y=function(e){return void 0===e?this.lat():void(i=e)},this},geo.layerOptions=function(){"use strict";return this instanceof geo.layerOptions?(this.opacity=.5,this.showAttribution=!0,this.visible=!0,this.binNumber=vgl.material.RenderBin.Default,this):new geo.layerOptions},geo.newLayerId=function(){"use strict";var e=1;return function(){var t=e;return e+=1,t}}(),geo.layer=function(e){"use strict";if(!(this instanceof geo.layer))return new geo.layer(e);e=e||{},geo.sceneObject.call(this,e);var t=this,i=void 0===e.style?{opacity:.5,color:[.8,.8,.8],visible:!0,bin:100}:e.style,r=void 0===e.id?geo.newLayerId():e.id,n="",o="EPSG:4326",a=null,s=e.source||null,l=void 0===e.map?null:e.map,u=!1,h=0,d=0,c=0,g=0,f=null,p=null,m=null,v=!1,y=void 0===e.renderer?"vglRenderer":e.renderer,w=geo.timestamp(),_=geo.timestamp(),M=geo.timestamp();return this.node=function(){return f},this.id=function(e){return void 0===e?r:(r=geo.newLayerId(),t.modified(),this)},this.name=function(e){return void 0===e?n:(n=e,t.modified(),this)},this.opacity=function(e){return void 0===e?i.opacity:(i.opacity=e,t.modified(),this)},this.visible=function(e){return void 0===e?i.visible:(i.visible=e,t.modified(),this)},this.bin=function(e){return void 0===e?i.bin:(i.bin=e,t.modified(),this)},this.gcs=function(e){return void 0===e?o:(o=e,t.modified(),this)},this.transform=function(e){return geo.transform.transformLayer(e,t,l.baseLayer()),this},this.timeRange=function(e){return void 0===e?a:(a=e,t.modified(),this)},this.source=function(e){return void 0===e?s:(s=e,t.modified(),this)},this.map=function(e){return void 0===e?l:(l=e,l.node().append(f),t.modified(),this)},this.renderer=function(){return m},this.canvas=function(){return p},this.viewport=function(){return[h,d,c,g]},this.dataTime=function(){return w},this.updateTime=function(){return _},this.drawTime=function(){return M},this.query=function(){},this.referenceLayer=function(e){return void 0!==e?(u=e,t.modified(),this):u},this.initialized=function(e){return void 0!==e?(v=e,this):v},this.toLocal=function(e){return e},this.fromLocal=function(e){return e},this._init=function(){return v?this:(f=$(document.createElement("div")),f.attr("id",n),f.css("position","absolute"),l&&l.node().append(f),p?m=geo.createRenderer(y,t,p):(m=geo.createRenderer(y,t),p=m.canvas()),t.addChild(m),v=!0,this)},this._exit=function(){},this._update=function(){},this._resize=function(e,i,r,n){return h=e,d=i,c=r,g=n,f.width(r),f.height(n),t.modified(),t.trigger(geo.event.resize,{x:e,y:i,width:c,height:g}),this},this.width=function(){return c},this.height=function(){return g},this._draw=function(){},this},inherit(geo.layer,geo.sceneObject),geo.featureLayer=function(e){"use strict";if(!(this instanceof geo.featureLayer))return new geo.featureLayer(e);geo.layer.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this.createFeature=function(e,r){var n=geo.createFeature(e,t,this.renderer(),r);return i||(i=[]),i.push(n),this.features(i),this.modified(),n},this.deleteFeature=function(){},this.features=function(e){return this._features(e)},this._features=function(e){return void 0===e?i||[]:(i=e.slice(0),this.dataTime().modified(),this.modified(),void 0)},this._delete=function(e){var t;for(t=0;t<i.length;t+=1)if(i[t]===e)return i[t]._exit(),this.dataTime().modified(),this.modified(),i.splice(t,1);return this},this._init=function(){return this.initialized()?this:(r.call(this),this.on(geo.event.resize,function(e){t.renderer()._resize(e.x,e.y,e.width,e.height),t._update({}),t.renderer()._render()}),this.on(geo.event.pan,function(e){t._update({event:e}),t.renderer()._render()}),this.on(geo.event.zoom,function(e){t.map()&&t.map().zoom(e.curr_zoom),t._update({event:e}),t.renderer()._render()}),this)},this._update=function(e){var r,o=!1;if(!i)return this;if(n.call(this,e),!this.source()&&i&&0===i.length)return void console.log("[info] No valid data source found.");if(this.dataTime().getMTime()>this.updateTime().getMTime()){for(r=0;r<i.length;r+=1)i[r].renderer(this.renderer());o=!0}for(r=0;r<i.length;r+=1)i[r]._update();return this.updateTime().modified(),o&&t.renderer().reset(),this},this._draw=function(){return this.renderer()._render(),this},this.clear=function(){var e;if(!i)return this;for(e=0;e<i.length;e+=1)i[e]._exit();return this.dataTime().modified(),this.modified(),i=[],this},this},inherit(geo.featureLayer,geo.layer),geo.registerLayer("feature",geo.featureLayer),geo.event=function(){"use strict";return this instanceof geo.event?(vgl.event.call(this),this):new geo.event},inherit(geo.event,vgl.event),geo.event.update="geo.update",geo.event.opacityUpdate="geo.opacityUpdate",geo.event.layerAdd="geo.layerAdd",geo.event.layerRemove="geo.layerRemove",geo.event.layerToggle="geo.layerToggle",geo.event.layerSelect="geo.layerSelect",geo.event.layerUnselect="geo.layerUnselect",geo.event.zoom="geo.zoom",geo.event.center="geo.center",geo.event.pan="geo.pan",geo.event.rotate="geo.rotate",geo.event.resize="geo.resize",geo.event.animate="geo.animate",geo.event.query="geo.query",geo.event.draw="geo.draw",geo.event.drawEnd="geo.drawEnd",geo.event.animationPause="geo.animationPause",geo.event.animationStop="geo.animationStop",geo.event.animationComplete="geo.animationComplete",geo.time={},geo.time.incrementTime=function(e,t,i){"use strict";return"days"===t?e.setDate(e.getDate()+i):"months"===t?e.setMonth(e.getMonth()+i):"years"===t?e.setYear(e.getYear()+i):"index"===t&&(e+=i),e},geo.map=function(e){"use strict";if(!(this instanceof geo.map))return new geo.map(e);e=e||{},geo.sceneObject.call(this,e),e.layers=void 0===e.layers?[]:e.layers;var t,i,r,n,o,a=this,s=0,l=0,u=$(e.node),h=u.width(),d=u.height(),c=void 0===e.gcs?"EPSG:4326":e.gcs,g=void 0===e.uigcs?"EPSG:4326":e.uigcs,f=void 0===e.center?[0,0]:e.center,p=void 0===e.zoom?10:e.zoom,m=null,v={range:null,timestep:null,layers:null},y={};return y.milliseconds=1,y.seconds=1e3*y.milliseconds,y.minutes=60*y.seconds,y.hours=60*y.minutes,y.days=24*y.hours,y.weeks=7*y.days,y.months=4*y.weeks,y.years=12*y.months,this.on(geo.event.animationPause,function(){n=!0}),this.on(geo.event.animationStop,function(){o=!0}),t=function(e){var t=e.toLowerCase();return y[t]},i=function(e){var i,r,n,o,a,s=null,l=null,u=!1,h=Number.MAX_VALUE;for(a=0;a<e.length;a+=1)if(n=e[a].timeRange()){if("index"===n.deltaUnits)u=!0,o=n.delta;else{if(u)throw"Can't mix index timesteps with time based timesteps";o=t(n.deltaUnits)*n.delta}h>o&&(i=n.delta,r=n.deltaUnits,h=o),(null===s||n.start<s)&&(s=n.start),(null===l||n.end<l)&&(l=n.end)}return{start:s,end:l,delta:i,deltaUnits:r}},r=function(e){return e instanceof Date&&(e=new Date(e.getTime())),e},this.gcs=function(e){return void 0===e?c:(c=e,this)},this.uigcs=function(){return g},this.node=function(){return u},this.zoom=function(e){return void 0===e?p:(p=e,a.modified(),this)},this.center=function(e){return void 0===e?f:(f=e.slice,a.modified(),this)},this.createLayer=function(e,t){var i=geo.createLayer(e,a,t);return null===i&&void 0===i?null:(i._resize(s,l,h,d),(i.referenceLayer()||0===a.children().length)&&a.baseLayer(i),a.addChild(i),a.modified(),a.trigger(geo.event.layerAdd,{type:geo.event.layerAdd,target:a,layer:i}),i)},this.deleteLayer=function(e){return null!==e&&void 0!==e&&(e._exit(),a.removeChild(e),a.modified(),a.trigger(geo.event.layerRemove,{type:geo.event.layerRemove,target:a,layer:e})),e},this.toggle=function(e){return null!==e&&void 0!==e&&(e.visible(!e.visible()),a.modified(),a.trigger(geo.event.layerToggle,{type:geo.event.layerToggle,target:a,layer:e})),this},this.resize=function(e,t,i,r){var n,o=a.children();for(s=e,l=t,h=i,d=r,n=0;n<o.length;n+=1)o[n]._resize(e,t,i,r);return a.trigger(geo.event.resize,{type:geo.event.resize,target:a,x:s,y:l,width:i,height:r}),a.modified(),this},this.gcsToDisplay=function(e){var t,i;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.toLocal(e),i=m.renderer().worldToDisplay(t)},this.displayToGcs=function(e){var t;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.renderer().displayToWorld(e),t=m.fromLocal(t)},this.query=function(){},this.baseLayer=function(e){return void 0!==e?(c!==e.gcs()&&a.gcs(e.gcs()),m=e,m.referenceLayer(!0),this):m},this.draw=function(){var e,t=a.children();for(a.trigger(geo.event.draw,{type:geo.event.draw,target:a}),a._update(),e=0;e<t.length;e+=1)t[e]._draw();return a.trigger(geo.event.drawEnd,{type:geo.event.drawEnd,target:a}),this},this.animate=function(e){var t;if(e=void 0===e?a.children():e,null===v.timestep){if(t=i(e),!t.start||!t.end)throw"Animation range could not be calculated. Check that layers have ranges associated with them";v={range:t,timestep:r(t.start),layers:e}}return this._animate(),this},this.pauseAnimation=function(){return a.trigger(geo.event.animationPause),this},this.stopAnimation=function(){return a.trigger(geo.event.animationStop),v.timestep=null,this},this.stepAnimationForward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.start),layers:e}),a._stepAnimationForward(),this},this.stepAnimationBackward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.end),layers:e}),a._stepAnimationBackward(),this},this._animate=function(){function e(){v.timestep>t.end||o?(clearInterval(s),v.timestep=null,a.trigger(geo.event.animationComplete)):n?clearInterval(s):(a._animateTimestep(),v.timestep=geo.time.incrementTime(v.timestep,v.range.deltaUnits,v.range.delta))}var t,i,s;if(t=v.range,i=r(t.start),o=!1,n=!1,i=geo.time.incrementTime(i,t.deltaUnits,t.delta),i>t.end)throw"Invalid time range";return s=setInterval(e,10),this},this._animateTimestep=function(){return v&&($.each(v.layers,function(e,t){var i=v.timestep;i instanceof Date&&(i=i.getTime()),t._update({timestep:i})}),a.trigger(geo.event.animate,{timestep:v.timestep}),a.draw()),this},this._stepAnimationForward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.start)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,v.range.delta),e<=v.range.end&&(v.timestep=e,a._animateTimestep()),this},this._stepAnimationBackward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.end)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,-v.range.delta),e<v.range.start?void 0:(v.timestep=e,a._animateTimestep(),this)},this._init=function(e){var t;if(void 0===u||null===u)throw"Map require DIV node";if(void 0!==e&&void 0!==e.layers)for(t=0;t<e.layers.length;t+=1)0===t&&a.baseLayer(e.layers[t]),a.addLayer(e.layers[t]);return this},this._update=function(e){var t,i=a.children();for(t=0;t<i.length;t+=1)i[t]._update(e);return this},this._exit=function(){var e,t=a.children();for(e=0;e<t.length;e+=1)t[e]._exit()},this._init(e),this},inherit(geo.map,geo.sceneObject),geo.feature=function(e){"use strict";if(!(this instanceof geo.feature))return new geo.feature(e);geo.object.call(this),e=e||{};var t={},i=void 0===e.layer?null:e.layer,r=void 0===e.gcs?"EPSG:4326":e.gcs,n=void 0===e.visible?!0:e.visible,o=void 0===e.bin?0:e.bin,a=void 0===e.renderer?null:e.renderer,s=geo.timestamp(),l=geo.timestamp(),u=geo.timestamp();return this.style=function(e,i){return void 0===e?t:void 0===i?(t=$.extend({},t,e),this.modified(),this):(t[e]=i,this.modified(),this)},this.layer=function(){return i},this.renderer=function(){return a},this.drawables=function(){return this._drawables()},this.gcs=function(e){return void 0===e?r:(r=e,this.modified(),this)},this.visible=function(e){return void 0===e?n:(n=e,this.modified(),this)},this.bin=function(e){return void 0===e?o:(o=e,this.modified(),this)},this.dataTime=function(e){return void 0===e?s:(s=e,this.modified(),this)},this.buildTime=function(e){return void 0===e?l:(l=e,this.modified(),this)},this.updateTime=function(e){return void 0===e?u:(u=e,this.modified(),this)},this._init=function(e){if(!i)throw"Feature requires a valid layer";t=$.extend({},{opacity:1},void 0===e.style?{}:e.style)},this._build=function(){},this._drawables=function(){},this._update=function(){},this._exit=function(){},this._init(e),this},inherit(geo.feature,geo.object),geo.pointFeature=function(e){"use strict";if(!(this instanceof geo.pointFeature))return new geo.pointFeature(e);e=e||{},geo.feature.call(this,e);var t=void 0===e.positions?null:e.positions,i=this._init;return this.positions=function(e){return void 0===e?t:(t=e.slice(0),this.dataTime().modified(),this.modified(),this)},this._init=function(e){i.call(this,e);var r=$.extend({},{size:1,width:1,height:1,color:[1,1,1],point_sprites:!1,point_sprites_image:null},void 0===e.style?{}:e.style);this.style(r),t&&this.dataTime().modified()},this._init(e),this},inherit(geo.pointFeature,geo.feature),geo.lineFeature=function(e){"use strict";if(!(this instanceof geo.lineFeature))return new geo.lineFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?[]:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),this)},this._init=function(e){r.call(t,e);var n=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},this._init(e),this},inherit(geo.lineFeature,geo.feature),geo.pathFeature=function(e){"use strict";if(!(this instanceof geo.pathFeature))return new geo.pathFeature(e);e=e||{},geo.feature.call(this,e);var t=void 0===e.positions?[]:e.positions,i=this._init;return this.positions=function(e){return void 0===e?t:(t=e.slice(0),this.dataTime().modified(),this.modified(),this)},this._init=function(e){i.call(this,e);var r=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);this.style(r),t&&this.dataTime().modified()},this._init(e),this},inherit(geo.pathFeature,geo.feature),geo.polygonFeature=function(e){"use strict";if(!(this instanceof geo.polygonFeature))return new geo.polygonFeature(e);e=e||{},geo.feature.call(this,e);var t=this._init;return this._init=function(e){t.call(this,e);var i=$.extend({},{color:[1,1,1],fill_color:[1,1,1],fill:!0},void 0===e.style?{}:e.style);this.style(i)},this._init(e),this},inherit(geo.polygonFeature,geo.feature),geo.planeFeature=function(e){"use strict";if(!(this instanceof geo.planeFeature))return new geo.planeFeature(e);e=e||{},e.ul=void 0===e.ul?[0,1,0]:e.ul,e.lr=void 0===e.lr?[1,0,0]:e.lr,e.depth=void 0===e.depth?0:e.depth,geo.polygonFeature.call(this,e);var t=[e.ul.x,e.lr.y,e.depth],i=[e.ul.x,e.ul.y,e.depth],r=[e.lr.x,e.lr.y,e.depth],n=e.depth,o=void 0===e.drawOnAsyncResourceLoad?!0:!1,a=this._init;return this.origin=function(e){if(void 0===e)return t;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";t=e.slice(0),2===t.length&&(t[2]=n)}else e instanceof geo.latlng&&(t=[e.x(),e.y(),n]);return this.dataTime().modified(),this.modified(),this},this.upperLeft=function(e){if(void 0===e)return i;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";i=e.slice(0),2===i.length&&(i[2]=n)}else e instanceof geo.latlng&&(i=[e.x(),e.y(),n]);return this.dataTime().modified(),this.modified(),this},this.lowerRight=function(e){if(void 0===e)return r;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";r=e.slice(0),2===r.length&&(r[2]=n),this.dataTime().modified()}else e instanceof geo.latlng&&(r=[e.x(),e.y(),n]);return this.dataTime().modified(),this.modified(),this},this.drawOnAsyncResourceLoad=function(e){return void 0===e?o:(o=e,this)},this._init=function(e){var t=null;a.call(this,e),t=this.style(),void 0===t.image&&(t.image=null),this.style(t)},this._init(e),this},inherit(geo.planeFeature,geo.polygonFeature),geo.geomFeature=function(e){"use strict";return this instanceof geo.geomFeature?(e=e||{},geo.feature.call(this,e),e.style=void 0===e.style?$.extend({},{color:[1,1,1],point_sprites:!1,point_sprites_image:null},e.style):e.style,this.style(e.style),this):new geo.geomFeature(e)},inherit(geo.geomFeature,geo.feature),geo.graphFeature=function(e){"use strict";if(!(this instanceof geo.graphFeature))return new geo.graphFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=this.style,r=null,n=null,o=[],a=this._init;return this._init=function(e){a.call(this,e);var t=$.extend(!0,{},{nodes:{size:5,color:[0,0,1]},links:{color:[1,1,1]},linkType:"path"},void 0===e.style?{}:e.style);this.style(t),r&&this.dataTime().modified()},this.style=function(e){var t=i.call(this,e);return t!==this?t:(n.style(e.nodes),o.forEach(function(t){t.style(e.links)}),this)},this.nodes=function(e){var i,a=t.layer(),s=0;return void 0===e?r:(i=t.style(),r=e.slice(0),n.positions(r),r.forEach(function(e){(e.children||[]).forEach(function(t){s+=1,o.length<s&&o.push(a.createFeature(i.linkType).style(i.links)),o[s-1].positions([e,t])})}),o.splice(s,o.length-s).forEach(function(e){a._delete(e)}),this.dataTime().modified(),this.modified(),this)},n=this.layer().createFeature("point"),e.nodes&&this.nodes(e.nodes),this._init(e),this},inherit(geo.graphFeature,geo.feature),geo.transform={},geo.transform.osmTransformFeature=function(e,t,i){"use strict";if(!t)return void console.log("[warning] Invalid (null) feature");if(t.gcs()!==e){if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";var r,n,o=null,a=0,s=null,l=null,u=null,h=t.gcs();if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if("EPSG:4326"!==h&&geo.transform.transformFeature("EPSG:4326",t,!0),l=t.positions(),s=l.length,!(l instanceof Array))throw"Supports Array of 2D and 3D points";if(l.length>0&&l[0]instanceof geo.latlng?(o=2,a=1):(o=s%2===0?2:s%3===0?3:null,a=o),2!==o&&3!==o)throw"Transform points require points in 2D or 3D";for(u=i?l:l.slice(0),r=0;s>r;r+=a)n=l[r]instanceof geo.latlng?l[r].lat():l[r+1],n>85.0511&&(n=85.0511),-85.0511>n&&(n=-85.0511),l[r]instanceof geo.latlng?u[r]=geo.latlng(geo.mercator.lat2y(n),u[r].lng()):u[r+1]=geo.mercator.lat2y(n);return i&&(t.positions(u),t.gcs(e)),u}return null}},geo.transform.transformFeature=function(e,t,i){"use strict";if(!t)throw"Invalid (null) feature";if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";if(t.gcs()===e)return t.positions();if("EPSG:3857"===e)return geo.transform.osmTransformFeature(e,t,i);var r,n=null,o=0,a=null,s=null,l=null,u=null,h=t.gcs(),d=new proj4.Proj(h),c=new proj4.Proj(e);if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if(s=t.positions(),a=s.length,!(s instanceof Array))throw"Supports Array of 2D and 3D points";if(s.length>0&&s[0]instanceof geo.latlng?(n=2,o=1):(n=a%2===0?2:a%3===0?3:null,o=n),2!==n&&3!==n)throw"Transform points require points in 2D or 3D";for(i?l=s:(l=[],l.length=s.length),r=0;a>r;r+=o)u=2===n?new proj4.Point(s[r],s[r+1],0):new proj4.Point(s[r],s[r+1],s[r+2]),proj4.transform(d,c,u),2===n?(l[r]=u.x,l[r+1]=u.y):(l[r]=u.x,l[r+1]=u.y,l[r+2]=u.z);return i&&(t.positions(l),t.gcs(e)),l}return null},geo.transform.transformLayer=function(e,t,i){"use strict";var r,n,o;if(!t)throw"Requires valid layer for tranformation";if(!i)throw"Requires baseLayer used by the map";if(t!==i){if(!(t instanceof geo.featureLayer))throw"Only feature layer transformation is supported";for(r=t.features(),n=r.length,o=0,o=0;n>o;o+=1)"EPSG:3857"===e&&i instanceof geo.osmLayer?geo.transform.osmTransformFeature(e,r[o],!0):geo.transform.transformFeature(e,r[o],!0);t.gcs(e)}},geo.renderer=function(e){"use strict";if(!(this instanceof geo.renderer))return new geo.renderer(e);geo.sceneObject.call(this),e=e||{};var t=this,i=void 0===e.layer?null:e.layer,r=void 0===e.canvas?null:e.canvas,n=!1;return this.layer=function(){return i},this.canvas=function(e){return void 0===e?r:(r=e,void this.modified())},this.map=function(){return i?i.map():null},this.baseLayer=function(){return t.map()?t.map().baseLayer():void 0},this.initialized=function(e){return void 0===e?n:(n=e,this)},this.api=function(){throw"Should be implemented by derivied classes"},this.reset=function(){return!0},this.worldToGcs=function(){throw"Should be implemented by derivied classes"},this.displayToGcs=function(){throw"Should be implemented by derivied classes"},this.gcsToDisplay=function(){throw"Should be implemented by derivied classes"},this.worldToDisplay=function(){throw"Should be implemented by derivied classes"},this.displayToWorld=function(){throw"Should be implemented by derivied classes"},this.relMouseCoords=function(e){var t=0,i=0,r=0,n=0,o=this.canvas();do t+=o.offsetLeft-o.scrollLeft,i+=o.offsetTop-o.scrollTop,o=o.offsetParent;while(o);return r=e.pageX-t,n=e.pageY-i,{x:r,y:n}},this._init=function(){},this._resize=function(){},this._render=function(){},this._exit=function(){},this._connectMouseEvents=function(){},this},inherit(geo.renderer,geo.sceneObject),geo.osmLayer=function(e){"use strict";if(!(this instanceof geo.osmLayer))return new geo.osmLayer(e);geo.featureLayer.call(this,e);var t=this,i={},r=0,n=1e3,o=[],a=[],s=0,l=100,u=null,h="http://tile.openstreetmap.org/",d="png",c=this._init,g=this._update;return e&&void 0!==e.baseUrl&&(h=e.baseUrl),e&&void 0!==e.imageFormat&&(d=e.imageFormat),this.tileCacheSize=function(e){return void 0===e?l:(l=e,void this.modified())},this.toLocal=function(e){var t,i,r;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof geo.latlng)for(t=0;t<e.length;t+=1)i[t]=geo.latlng(e[t]),i[t].lat(geo.mercator.lat2y(i[t].lat()));else if(e[0]instanceof Array)if(r=e%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]);else for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]),i[t+2]=e[t+2];else"x"in e[0]&&"y"in e[0]&&"z"in e[0]?i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y),z:e[t].z}:"x"in e[0]&&"y"in e[0]&&"z"in e[0]&&(i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y)});else e instanceof geo.latlng?(i={},i.x=e.x(),i.y=geo.mercator.lat2y(e.y())):(i={},i.x=e.x,i.y=geo.mercator.lat2y(e.y));return i},this.fromLocal=function(e){var t,i;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof Object)for(t=0;t<e.length;t+=1)i[t]={},i[t].x=e[t].x,i[t].y=geo.mercator.y2lat(e[t].y);else if(e[0]instanceof Array)for(t=0;t<e.length;t+=1)i[t]=e[t],i[t][1]=geo.mercator.y2lat(e[t][1]);else for(t=0;t<e.length;t+=1)i[t]=e[t],i[t+1]=geo.mercator.y2lat(e[t+1]);else i={},i.x=e.x,i.y=geo.mercator.y2lat(e.y);return i},this._hasTile=function(e,t,r){return i[e]&&i[e][t]&&i[e][t][r]?!0:!1},this._addTile=function(e,t,r,n){if(i[t]||(i[t]={}),i[t][r]||(i[t][r]={}),!i[t][r][n]){var a=Math.max(1,Math.pow(2,t)),l=Math.max(1,Math.pow(2,t)),u=360,c=360/a,g=u/l,f=-180+r*c,p=.5*-u+n*g,m=-180+(r+1)*c,v=.5*-u+(n+1)*g,y=new Image;return y.LOADING=!0,y.LOADED=!1,y.REMOVED=!1,y.REMOVING=!1,y.crossOrigin="anonymous",y.zoom=t,y.index_x=r,y.index_y=n,y.llx=f,y.lly=p,y.urx=m,y.ury=v,y.lastused=new Date,y.src=h+t+"/"+r+"/"+(Math.pow(2,t)-1-n)+"."+d,i[t][r][n]=y,o.push(y),s+=1,y}},this._removeTiles=function(){var e,o,h,d,c=this.map().zoom();if(!i)return this;if(u===c)return this;u=c;for(d in i)if(c!==d)for(e in i[d])for(o in i[d][e])h=i[d][e][o],h&&(h.REMOVING=!0,a.push(h));return setTimeout(function(){var e,o;for(a.sort(function(e,t){return e.lastused-t.lastused}),o=0;s>l&&o<a.length;)e=a[o],e.zoom!==t.map().zoom()&&(t._delete(e.feature),delete i[e.zoom][e.index_x][e.index_y],a.splice(o,1),s-=1),o+=1;for(o=0;o<a.length;o+=1)e=a[o],e.zoom!==t.map().zoom()?(e.REMOVING=!1,e.REMOVED=!0,e.feature.bin(r)):(e.REMOVING=!1,e.REMOVED=!1,e.lastused=new Date,e.feature.bin(n)),e.feature._update();a=[],t._draw()},100),this},this._addTiles=function(e){function a(e){return function(){e.LOADING=!1,e.LOADED=!0,(e.REMOVING||e.REMOVED)&&e.feature&&e.zoom!==t.map().zoom()?(e.feature.bin(r),e.REMOVING=!1,e.REMOVED=!0):(e.REMOVED=!1,e.lastused=new Date,e.feature.bin(n)),e.feature._update(),t._draw()}}var s,l=this.renderer(),u=this.map().zoom(),h=0,d=this.height(),c=this.width(),g=0,f=null,p=null,m=null,v=null,y=null,w=null,_=null,M=0,x=0,b=l.displayToWorld([h,d]),T=l.displayToWorld([c,g]);for(b[0]=Math.max(b[0],-180),b[0]=Math.min(b[0],180),b[1]=Math.max(b[1],-180),b[1]=Math.min(b[1],180),T[0]=Math.max(T[0],-180),T[0]=Math.min(T[0],180),T[1]=Math.max(T[1],-180),T[1]=Math.min(T[1],180),m=geo.mercator.long2tilex(b[0],u),v=geo.mercator.lat2tiley(b[1],u),y=geo.mercator.long2tilex(T[0],u),w=geo.mercator.lat2tiley(T[1],u),m=Math.max(m,0),m=Math.min(Math.pow(2,u)-1,m),v=Math.max(v,0),v=Math.min(Math.pow(2,u)-1,v),y=Math.max(y,0),y=Math.min(Math.pow(2,u)-1,y),w=Math.max(w,0),w=Math.min(Math.pow(2,u)-1,w),m>y&&(f=m,m=y,y=f),w>v&&(f=v,m=w,w=f),M=m;y>=M;M+=1)for(x=w;v>=x;x+=1)_=Math.pow(2,u)-1-x,t._hasTile(u,M,_)?(p=i[u][M][_],p.feature.bin(n),p.lastused=new Date,p.feature._update()):t._addTile(e,u,M,_);
for(M=0;M<o.length;M+=1)p=o[M],p.onload=a(p),s=this.createFeature("plane",{drawOnAsyncResourceLoad:!1}).origin([p.llx,p.lly]).upperLeft([p.llx,p.ury]).lowerRight([p.urx,p.lly]).gcs('"EPSG:3857"').style("image",p),p.feature=s;o=[]},this._updateTiles=function(e){return this._addTiles(e),t._removeTiles(e),t._draw(),this.updateTime().modified(),this},this._init=function(){return c.call(this),this.gcs("EPSG:3857"),this},this._update=function(e){this._updateTiles(e),g.call(this,e)},this},inherit(geo.osmLayer,geo.featureLayer),geo.registerLayer("osm",geo.osmLayer),ggl=ogs.namespace("geo.gl"),ggl.renderer=function(e){"use strict";return this instanceof ggl.renderer?(geo.renderer.call(this,e),this.contextRenderer=function(){throw"Should be implemented by derived classes"},this):new ggl.renderer(e)},inherit(ggl.renderer,geo.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),ggl.pointFeature=function(e){"use strict";if(!(this instanceof ggl.pointFeature))return new ggl.pointFeature(e);e=e||{},geo.pointFeature.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this._init=function(e){r.call(this,e)},this._build=function(){var e=t.style(),r=geo.transform.transformFeature(t.renderer().map().gcs(),this,!1);if(i&&this.renderer().contextRenderer().removeActor(i),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";i=vgl.utils.createPointSprites(e.point_sprites_image,r,e.colors)}else i=vgl.utils.createPoints(r,e.colors);this.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){var e=t.style();if(n.call(this),this.dataTime().getMTime()>=this.buildTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime())if(this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";e.width&&e.height?i.material().shaderProgram().uniform("pointSize").set([e.width,e.height]):e.size&&i.material().shaderProgram().uniform("pointSize").set([e.size,e.size])}else e.size&&i.material().shaderProgram().uniform("pointSize").set(e.size);this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this._init(e),this},inherit(ggl.pointFeature,geo.pointFeature),geo.registerFeature("vgl","point",ggl.pointFeature),ggl.geomFeature=function(e){"use strict";if(!(this instanceof ggl.geomFeature))return new ggl.geomFeature(e);e=e||{},geo.geomFeature.call(this,e);var t=this,i=e.geom||null,r=vgl.actor(),n=vgl.mapper(),o=null,a=null,s=e.color||[1,1,1],l=null,u=0;return this._build=function(){var e=t.style();null!==i&&(a=i.sourceData(vgl.vertexAttributeKeys.Scalar),s=i.sourceData(vgl.vertexAttributeKeys.Color),n.setGeometryData(i)),this.setMapper(n),void 0!==e.point_sprites&&e.point_sprites&&void 0!==e.point_sprites_image&&null!==e.point_sprites_image&&1===u&&i.primitive(0).primitiveType()===gl.POINTS?o=vgl.utils.createPointSpritesMaterial(e.point_sprites_image):a?s instanceof vgl.lookupTable?(s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):(s=vgl.lookupTable(),s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):o=s?vgl.utils.createColorMaterial():vgl.utils.createSolidColorMaterial(),r.setMaterial(o)},this._update=function(){l&&l.getMTime()<this.getMTime()?s instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color):(l=vgl.timestamp(),l.modified())},this.geometry=function(e){return void 0===e?i:(i=e,this.modified(),this)},this},inherit(ggl.geomFeature,geo.geomFeature),ggl.planeFeature=function(e){"use strict";if(!(this instanceof ggl.planeFeature))return new ggl.planeFeature(e);geo.planeFeature.call(this,e);var t=this,i=null;return this.coords=function(){return[this.origin(),this.upperLeft(),this.lowerRight()]},this._build=function(){var e=this.origin(),r=this.upperLeft(),n=this.lowerRight(),o=this.style().image,a=null,s=null,l=null;i&&this.renderer().contextRenderer().removeActor(i),o&&o instanceof Image?(a=o,s=o.onload):o&&(a=new Image,a.src=o),a?(i=vgl.utils.createTexturePlane(e[0],e[1],e[2],n[0],n[1],n[2],r[0],r[1],r[2],!0),l=vgl.texture(),t.visible(!1),a.onload=function(){l.setImage(a),i.material().addAttribute(l),t.visible(!0),s&&s.call(this),t.drawOnAsyncResourceLoad()&&(t._update(),t.layer()._draw())}):i=vgl.utils.createPlane(e[0],e[1],e[2],r[0],r[1],r[2],n[0],n[1],n[2]),t.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){this.buildTime().getMTime()<=this.dataTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime()&&(i.setVisible(this.visible()),i.material().setBinNumber(this.bin())),this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this},inherit(ggl.planeFeature,geo.planeFeature),geo.registerFeature("vgl","plane",ggl.planeFeature),ggl.mapInteractorStyle=function(){"use strict";function e(){var e,t=u.position(),i=t[2]*Math.sin(u.viewAngle());for(e=0;20>e;e+=1)if(i>=360/Math.pow(2,e))return e}function t(e){var t=360/Math.pow(2,e);return t/Math.sin(u.viewAngle())}if(!(this instanceof ggl.mapInteractorStyle))return new ggl.mapInteractorStyle;vgl.interactorStyle.call(this);var i,r,n,o,a,s,l,u,h,d,c,g,f,p=this,m=!1,v=!1,y=!1,w=!1,_=!1,M={x:0,y:0},x=new vgl.picker,b=vgl.timestamp();return this.map=function(e){return void 0!==e?(i=e,p):i},this.drawRegionMode=function(e){return void 0!==e?(_=e,r&&r.setVisible(e),i.draw(),p):_},this._panCamera=function(e){var t,i,r,n,o,a=e.focusDisplayPoint();t=l.displayToWorld(d.x,d.y,a,e),i=l.displayToWorld(M.x,M.y,a,e),r=t[0]-i[0],n=t[1]-i[1],o=t[2]-i[2],e.camera().pan(-r,-n,-o)},this.handleMouseMove=function(e){var t,r,o,s,c,f;if(p.updateRenderParams(),p._computeCurrentMousePos(e),h===!0)return!0;if(m)if(_)t=i.displayToMap(d.x,d.y),p.setDrawRegion(n.lat(),n.lng(),t.y,t.x);else{for(r=u.position(),f=l.renderers(),c=0;c<f.length;c+=1)p._panCamera(f[c]);o=u.position(),s={type:geo.event.pan,last_display_pos:M,curr_display_pos:d,last_world_pos:r,curr_world_pos:o},$(p).trigger(s)}return v&&a>0&&(g=2*(d.y-M.y)/a,p.zoom()),M.x=d.x,M.y=d.y,!1},this.handleMouseDown=function(e){var t;return p.updateRenderParams(),0===e.button&&(m=!0),1===e.button&&(y=!0),2===e.button&&(v=!0),f=p.viewer().relMouseCoords(e),M.x=f.x<0?0:f.x,M.y=f.y<0?0:f.y,_&&m&&(t=i.displayToMap(M.x,M.y),n=geo.latlng(t.y,t.x),p.setDrawRegion(t.y,t.x,t.y,t.x)),!1},this.handleMouseUp=function(e){var t=null,i=null,r=null;return p.updateRenderParams(),0===e.button&&(m=!1,t=p.viewer().renderWindow().windowSize()[0],i=p.viewer().renderWindow().windowSize()[1],s=p.viewer().renderWindow().activeRenderer(),M.x>=0&&M.x<=t&&M.y>=0&&M.y<=i&&(r=x.pick(M.x,M.y,s))),1===e.button&&(y=!1),2===e.button&&(v=!1,w=!1,p.zoom()),!1},this.handleMouseOut=function(){return p.updateRenderParams(),m?m=!1:y&&(y=!1),v&&(v=!1,w=!1,p.zoom()),!1},this.handleMouseWheel=function(e){p.updateRenderParams();var t=e.originalEvent.wheelDeltaY/120;return t=Math.pow(1+Math.abs(t)/2,t>0?-1:1),p._computeCurrentMousePos(e),p.zoom(t),!1},this._syncZoom=function(e){var t,i,r,n,o;for(p.updateRenderParams(),e&&(u.zoom(e),s.resetCameraClippingRange()),r=u.position(),n=u.focalPoint(),i=l.renderers(),t=0;t<i.length;t+=1)o=i[t].camera(),o!==u&&(o.setPosition(r[0],r[1],r[2]),o.setFocalPoint(n[0],n[1],n[2]),i[t].resetCameraClippingRange(),i[t].render())},this._syncReset=function(){var e,r,n,o,a,h,d,c;p.updateRenderParams(),a=i.zoom(),h=i.center(),o=u.focalPoint(),h=i.baseLayer().toLocal(geo.latlng(h[0],h[1])),h instanceof Object&&"x"in h&&"y"in h&&i.baseLayer()instanceof geo.osmLayer&&(u.setPosition(h.x,h.y,t(a)),u.setFocalPoint(h.x,h.y,o[2]),s.resetCameraClippingRange()),o=u.focalPoint(),n=u.position(),c=u.clippingRange(),r=l.renderers();for(e=0;e<r.length;e+=1)d=r[e].camera(),d!==u&&(console.log("Setting camera for ren ",r[e].layer()),console.log("Setting pos ",n),d.setPosition(n[0],n[1],n[2]),d.setFocalPoint(o[0],o[1],o[2]),d.setClippingRange(c[0],c[1]),r[e].render())},this._syncPan=function(){},this.zoom=function(i){var r,n,o,l=u.position();p.updateRenderParams(),g=(d.y-M.y)/a,void 0===i&&(i=0>g?1-Math.abs(g):1+Math.abs(g)),o=e(),l[2]*Math.sin(u.viewAngle())>=360&&i>1?(u.setPosition(l[0],l[1],t(0)),s.resetCameraClippingRange(),n=0):(this._syncZoom(i),n=e()),l=u.position(),l[2]*Math.sin(u.viewAngle())>=360&&i>1&&(u.setPosition(l[0],l[1],t(0)),s.resetCameraClippingRange(),n=0,this._syncZoom()),r={type:geo.event.zoom,curr_zoom:n,last_zoom:o},$(p).trigger(r)},this.lastMousePosition=function(e){return void 0!==e?(M=e,p):M},this.leftMouseDown=function(e){return void 0!==e?(m=e,p):m},this.setDrawRegion=function(e,t,n,o){var a,s=geo.planeFeature(geo.latlng(e,t),geo.latlng(n,o),99);return i.removeLayer(r),r=geo.featureLayer({opacity:.5,showAttribution:1},s),i.addLayer(r),a=jQuery.Event(geo.event.updateDrawRegionEvent),$(p).trigger(geo.command.updateDrawRegionEvent,a),p},this.getDrawRegion=function(){return r.features()[0].getCoords()},this._computeCurrentMousePos=function(e){p.updateRenderParams(),h=!1,f=p.viewer().relMouseCoords(e),d={x:0,y:0},f.x<0||f.x>o?(d.x=0,h=!0):d.x=f.x,f.y<0||f.y>a?(d.y=0,h=!0):d.y=f.y},this.updateRenderParams=function(){l=p.viewer().renderWindow(),o=l.windowSize()[0],a=l.windowSize()[1],s=p.viewer().renderWindow().activeRenderer(),u=s.camera(),c=l.focusDisplayPoint(),b.modified()},this.reset=function(){var e,t;i&&(p._syncReset(),e={type:geo.event.zoom,curr_zoom:t,last_zoom:t},$(p).trigger(e))},this},inherit(ggl.mapInteractorStyle,vgl.interactorStyle),ggl._vglViewerInstance=null,ggl.vglViewerInstance=function(){"use strict";var e;return null===ggl._vglViewerInstance&&(e=$(document.createElement("canvas")),e.attr("class",".webgl-canvas"),ggl._vglViewerInstance=vgl.viewer(e.get(0)),ggl._vglViewerInstance.renderWindow().removeRenderer(ggl._vglViewerInstance.renderWindow().activeRenderer()),ggl._vglViewerInstance.setInteractorStyle(ggl.mapInteractorStyle()),ggl._vglViewerInstance.init()),ggl._vglViewerInstance},ggl.vglRenderer=function(e){"use strict";if(!(this instanceof ggl.vglRenderer))return new ggl.vglRenderer(e);ggl.renderer.call(this,e);var t=this,i=ggl.vglViewerInstance(),r=vgl.renderer(),n=0,o=0,a=this._init;return this.displayToWorld=function(e){var i,r,a,s,l,u=t.contextRenderer(),h=u.camera(),d=u.focusDisplayPoint();if(e instanceof Array&&e.length>0)if(a=[],e[0]instanceof Object)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l.x,l.y,d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a.push({x:s[0],y:s[1],z:s[2],w:s[3]});else if(e[0]instanceof Array)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l[0],l[1],d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a.push(s);else for(r=e.length%3===0?3:2,i=0;i<e.length;i+=r)s=u.displayToWorld(vec4.fromValues(e[i],e[i+1],d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]);else{if(!(e instanceof Object))throw"Display to world conversion requires array of 2D/3D points";a={},s=u.displayToWorld(vec4.fromValues(e.x,e.y,d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a={x:s[0],y:s[1],z:s[2],w:s[3]}}return a},this.worldToDisplay=function(e){var t,i,r,a=this.contextRenderer(),s=a.camera(),l=s.focalPoint(),u=[];if(e instanceof Array&&e.length>0)if(u=[],e[0]instanceof Object)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t].x,e[t].y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t]={x:i[0],y:i[1],z:i[2]};else if(e[0]instanceof Array)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t][0],e[t][1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t].push(i);else if(r=e.length%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],e[t+2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else{if(!(e instanceof Object))throw"World to display conversion requires array of 2D/3D points";i=a.worldToDisplay(vec4.fromValues(e.x,e.y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u={x:i[0],y:i[1],z:i[2]}}return u},this.contextRenderer=function(){return r},this.api=function(){return"vgl"},this.reset=function(){i.interactorStyle().reset()},this._init=function(){return this.initialized()?this:(a.call(this),this.canvas($(i.canvas())),i.renderWindow().renderers().length>0&&(r.setLayer(i.renderWindow().renderers().length),r.setResetScene(!1)),i.renderWindow().addRenderer(r),this.layer().node().append(this.canvas()),$(i.interactorStyle()).on(geo.event.pan,function(e){t.trigger(geo.event.pan,e)}),$(i.interactorStyle()).on(geo.event.zoom,function(e){t.trigger(geo.event.zoom,e)}),this)},this._connectMapEvents=function(){if(t.layer().referenceLayer()){var e=$(t.layer().map().node());e.on("mousewheel",function(e){i.handleMouseWheel(e)}),e.on("mousemove",function(e){i.handleMouseMove(e)}),e.on("mouseup",function(e){i.handleMouseUp(e)}),e.on("mousedown",function(e){i.handleMouseDown(e)}),e.on("mouseout",function(t){var r=$(e),n=r.offset(),o=r.width(),a=r.height(),s=t.pageX-n.left,l=t.pageY-n.top;(0>s||s>=o||0>l||l>=a)&&i.handleMouseOut(t)}),e.on("keypress",function(e){i.handleKeyPress(e)}),e.on("contextmenu",function(e){i.handleContextMenu(e)})}i.interactorStyle().map(this.layer().map())},this.on(geo.event.layerAdd,function(e){e.layer===t.layer()&&t._connectMapEvents()}),this._resize=function(e,t,r,a){return n=r,o=a,this.canvas().attr("width",r),this.canvas().attr("height",a),i.renderWindow().positionAndResize(e,t,r,a),this._render(),this},this._render=function(){return i.render(),this},this._exit=function(){},this},inherit(ggl.vglRenderer,ggl.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),gd3=ogs.namespace("geo.d3"),function(e){"use strict";var t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",i=8;e.uniqueID=function(){var e,r=[];for(r.length=i,e=0;i>e;e+=1)r[e]=t.charAt(Math.floor(Math.random()*t.length));return r.join("")}}(gd3),gd3.object=function(e){"use strict";if(!(this instanceof geo.object))return new gd3.object(e);var t="d3-"+gd3.uniqueID();return this._d3id=function(){return t},geo.sceneObject.call(this),this},inherit(gd3.object,geo.sceneObject),gd3.pointFeature=function(e){"use strict";function t(e,t){if(!t&&e.hasOwnProperty("_dispx")&&e.hasOwnProperty("_dispy"))return e;var r,n=i.renderer();return r=n.worldToDisplay(e),e._dispx=function(){return r.x},e._dispy=function(){return r.y},e}if(!(this instanceof gd3.pointFeature))return new gd3.pointFeature(e);e=e||{},geo.pointFeature.call(this,e),gd3.object.call(this);var i=this,r={cx:function(e){return t(e,!0)._dispx()},cy:function(e){return t(e)._dispy()},r:"1px"},n={fill:"black",stroke:"none"},o=this._init,a=this._update,s=geo.timestamp(),l={};return this._init=function(e){return o.call(this,e),this},this._drawables=function(){return d3.selectAll("."+this._d3id())},this._build=function(){var e=this.positions(),t=this.style();return a.call(this),e||(e=[]),l.id=i._d3id(),l.data=e,l.append="circle",l.style=$.extend({},n),l.attributes=$.extend({},r),l.classes=["d3PointFeature"],l.style.fill=d3.rgb(255*t.color[0],255*t.color[1],255*t.color[2]),l.attributes.r=t.size.toString()+"px",l.style["fill-opacity"]=t.opacity,this.renderer().drawFeatures(l),s.modified(),this.updateTime().modified(),this},this._update=function(){return a.call(this),this.dataTime().getMTime()>=s.getMTime()&&this._build(),this},this._init(e),this},inherit(gd3.pointFeature,geo.pointFeature),geo.registerFeature("d3","point",gd3.pointFeature),gd3.lineFeature=function(e){"use strict";function t(e){var t,r=i.renderer();return t=r.worldToDisplay(e)}if(!(this instanceof gd3.lineFeature))return new gd3.lineFeature(e);e=e||{},geo.lineFeature.call(this,e),gd3.object.call(this);var i=this,r=this._init,n=geo.timestamp(),o=this._update,a={};return this._init=function(e){return r.call(this,e),this},this._build=function(){var e=this.positions(),r=this.style(),s=d3.svg.line().x(function(e){return t(e).x}).y(function(e){return t(e).y});return o.call(this),a.data=[e],a.attributes={d:s},a.id=i._d3id(),a.append="path",a.classes=["d3LineFeature"],a.style={fill:"none",stroke:d3.rgb(255*r.color[0],255*r.color[1],255*r.color[2]),"stroke-width":r.width[0].toString()+"px","stroke-opacity":r.opacity},this.renderer().drawFeatures(a),n.modified(),this.updateTime().modified(),this},this._update=function(){return o.call(this),this.dataTime().getMTime()>=n.getMTime()&&this._build(),this},this._init(e),this},inherit(gd3.lineFeature,geo.lineFeature),geo.registerFeature("d3","line",gd3.lineFeature),gd3.pathFeature=function(e){"use strict";function t(e){var t,r=i.renderer();return t=r.worldToDisplay(e)}if(!(this instanceof gd3.pathFeature))return new gd3.pathFeature(e);e=e||{},geo.pathFeature.call(this,e),gd3.object.call(this);var i=this,r=this._init,n=geo.timestamp(),o=this._update,a={};return this._init=function(e){return r.call(this,e),this},this._build=function(){var e,r,s=this.positions(),l=this.style();return o.call(this),r=function(e){var i=t(e.source),r=t(e.target),n={source:i,target:r};return d3.svg.diagonal()(n)},e=[],s.forEach(function(t,i){var r,n;i<s.length-1&&(r=t,n=s[i+1],e.push({source:r,target:n}))}),a.data=e,a.attributes={d:r},a.id=i._d3id(),a.append="path",a.classes=["d3PathFeature"],a.style={fill:"none",stroke:d3.rgb(255*l.color[0],255*l.color[1],255*l.color[2]),"stroke-width":l.width[0].toString()+"px","stroke-opacity":l.opacity},this.renderer().drawFeatures(a),n.modified(),this.updateTime().modified(),this},this._update=function(){return o.call(this),this.dataTime().getMTime()>=n.getMTime()&&this._build(),this},this._init(e),this},inherit(gd3.pathFeature,geo.pathFeature),geo.registerFeature("d3","path",gd3.pathFeature),gd3.graphFeature=function(e){"use strict";return this instanceof gd3.graphFeature?(geo.graphFeature.call(this,e),this):new gd3.graphFeature(e)},inherit(gd3.graphFeature,geo.graphFeature),geo.registerFeature("d3","graph",gd3.graphFeature),gd3.d3Renderer=function(e){"use strict";function t(e,t){var i;for(i in t)t.hasOwnProperty(i)&&e.attr(i,t[i])}function i(){var e=o.layer();return e?e.map():null}function r(e){void 0===e?(l[0]=0,l[1]=0):(l[0]+=e.x,l[1]+=e.y),o.canvas().selectAll(".group-"+o._d3id()).attr("transform","translate("+l.join()+")")}function n(e){var t=o.canvas(),i=t.selectAll(".group-"+e).data([0]);return i.enter().append("g").attr("class","group-"+e),i}if(!(this instanceof gd3.d3Renderer))return new gd3.d3Renderer(e);geo.renderer.call(this,e),gd3.object.call(this);var o=this,a=this._init,s={},l=[0,0];return this._init=function(e){if(a.call(this,e),!this.canvas()){var t=d3.select(this.layer().node().get(0)).append("svg");t.attr("class",this._d3id()),t.attr("width",this.layer().node().width()),t.attr("height",this.layer().node().height()),this.canvas(t)}},this.displayToWorld=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";return t.displayToGcs(e)},this.worldToDisplay=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";var r=t.gcsToDisplay(e);return r.x-=l[0],r.y-=l[1],r},this.api=function(){return"d3"},this._resize=function(e,t,i,n){o.canvas().attr("width",i),o.canvas().attr("height",n),r(),o.updateFeatures()},this._render=function(){},this._exit=function(){this.canvas().remove()},this.drawFeatures=function(e){return s[e.id]={data:e.data,index:e.dataIndex,style:e.style,attributes:e.attributes,classes:e.classes,append:e.append},r(),o.updateFeatures(e.id)},this.updateFeatures=function(e){var i;if(void 0===e){for(i in s)s.hasOwnProperty(i)&&o.updateFeatures(i);return this}var r=n(o._d3id()),a=s[e].data,l=s[e].index,u=s[e].style,h=s[e].attributes,d=s[e].classes,c=s[e].append,g=r.selectAll("."+e).data(a,l);return g.enter().append(c),g.exit().remove(),t(g,h),g.attr("class",d.concat([e]).join(" ")),g.style(u),this},this.on(geo.event.pan,function(e){r({x:e.curr_display_pos.x-e.last_display_pos.x,y:e.curr_display_pos.y-e.last_display_pos.y})}),this.on(geo.event.zoom,function(){r(),o.updateFeatures()}),this.on(geo.event.resize,function(e){o._resize(e.x,e.y,e.width,e.height)}),this._init(e),this},inherit(gd3.d3Renderer,geo.renderer),geo.registerRenderer("d3Renderer",gd3.d3Renderer),geo.version="0.1.0";var ogs;ogs=window&&void 0!==window.ogs?window.ogs:{},ogs.namespace=function(e){"use strict";var t,i=e.split("."),r=ogs;for("ogs"===i[0]&&(i=i.slice(1)),t=0;t<i.length;t+=1)void 0===r[i[t]]&&(r[i[t]]={}),r=r[i[t]];return r},geo=ogs.namespace("geo"),geo.renderers={},geo.features={},inherit=function(e,t){"use strict";var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.uber=t.prototype,e.prototype.constructor=e},Object.size=function(e){"use strict";var t=0,i=null;for(i in e)e.hasOwnProperty(i)&&(t+=1);return t},geo.registerRenderer=function(e,t){"use strict";void 0===geo.renderers&&(geo.renderers={}),geo.renderers[e]=t},geo.createRenderer=function(e,t,i){"use strict";if(geo.renderers.hasOwnProperty(e)){var r=geo.renderers[e]({layer:t,canvas:i});return r._init(),r}return null},geo.registerFeature=function(e,t,i){"use strict";void 0===geo.features&&(geo.features={}),e in geo.features||(geo.features[e]={}),geo.features[e][t]=i},geo.createFeature=function(e,t,i,r){"use strict";var n=i.api(),o={layer:t,renderer:i};return n in geo.features&&e in geo.features[n]?(void 0!==r&&$.extend(!0,o,r),geo.features[n][e](o)):null},geo.registerLayer=function(e,t){"use strict";void 0===geo.layers&&(geo.layers={}),geo.layers[e]=t},geo.createLayer=function(e,t,i){"use strict";var r={map:t,renderer:"vglRenderer"},n=null;return e in geo.layers?(void 0!==i&&$.extend(!0,r,i),n=geo.layers[e](r),n._init(),n):null},geo.object=function(){"use strict";if(!(this instanceof geo.object))return new geo.object;var e=this,t={};return this.on=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.on(t,r)}),this):(t.hasOwnProperty(i)||(t[i]=[]),t[i].push(r),this)},this.trigger=function(i,r){return Array.isArray(i)?(i.forEach(function(t){e.trigger(t,r)}),this):(t.hasOwnProperty(i)&&t[i].forEach(function(e){e(r)}),this)},this.off=function(i,r){if(Array.isArray(i))return i.forEach(function(t){e.off(t,r)}),this;if(r){if(Array.isArray(r))return r.forEach(function(t){e.off(i,t)}),this}else t[i]=[];return t.hasOwnProperty(i)&&(t[i]=t[i].filter(function(e){return e!==r})),this},vgl.object.call(this),this},inherit(geo.object,vgl.object),geo.sceneObject=function(e){"use strict";if(!(this instanceof geo.sceneObject))return new geo.sceneObject;geo.object.call(this,e);var t=this,i=null,r=[],n=this.trigger;return this.parent=function(e){return void 0===e?i:(i=e,this)},this.addChild=function(e){return Array.isArray(e)?(e.forEach(this.addChild),this):(e.parent(this),r.push(e),this)},this.removeChild=function(e){return Array.isArray(e)?(e.forEach(this.removeChild),this):(r=r.filter(function(t){return t!==e}),this)},this.children=function(){return r.slice()},this.trigger=function(e,o){return o=o||{},i&&o._triggeredBy!==i?(o._triggeredBy=t,i.trigger(e,o),this):(n.call(this,e,o),r.forEach(function(i){o._triggeredBy=t,i.trigger(e,o)}),this)},this},inherit(geo.sceneObject,geo.object),geo.timestamp=function(){"use strict";return this instanceof geo.timestamp?void vgl.timestamp.call(this):new geo.timestamp},inherit(geo.timestamp,vgl.timestamp),geo.ellipsoid=function(e,t,i){"use strict";if(!(this instanceof geo.ellipsoid))return new geo.ellipsoid(e,t,i);if(e=vgl.defaultValue(e,0),t=vgl.defaultValue(t,0),i=vgl.defaultValue(i,0),0>e||0>t||0>i)return console.log("[error] Al radii components must be greater than zero");var r=new vec3.fromValues(e,t,i),n=new vec3.fromValues(e*e,t*t,i*i),o=Math.min(e,t,i),a=Math.max(e,t,i);return this.radii=function(){return r},this.radiiSquared=function(){return n},this.maximumRadius=function(){return a},this.minimumRadius=function(){return o},this.computeGeodeticSurfaceNormal=function(e,t){if("undefined"==typeof e||"undefined"==typeof t)throw"[error] Valid latitude and longitude is required";var i=Math.cos(e),r=vec3.create();return r[0]=i*Math.cos(t),r[1]=i*Math.sin(t),r[2]=Math.sin(e),vec3.normalize(r,r),r},this.transformPoint=function(e,t,i){e*=Math.PI/180,t*=Math.PI/180;var r=this.computeGeodeticSurfaceNormal(e,t),o=vec3.create(),a=Math.sqrt(vec3.dot(r,o)),s=vec3.create();return vec3.multiply(o,n,r),vec3.scale(o,o,1/a),vec3.scale(r,r,i),vec3.add(s,r,o),s},this.transformGeometry=function(e){if(!e)throw"[error] Failed to transform to cartesian. Invalid geometry.";var t=e.sourceData(vgl.vertexAttributeKeys.Position),i=t.data(),r=t.attributeNumberOfComponents(vgl.vertexAttributeKeys.Position),o=t.attributeStride(vgl.vertexAttributeKeys.Position),a=t.attributeOffset(vgl.vertexAttributeKeys.Position),s=t.sizeOfAttributeDataType(vgl.vertexAttributeKeys.Position),l=null,u=i.length*(1/r),h=null,d=null,c=0,g=vec3.create(),f=vec3.create();if(o/=s,a/=s,3!==r)throw"[error] Requires positions with three components";for(c=0;u>c;c+=1)l=c*o+a,i[l]=i[l]*(Math.PI/180),i[l+1]=i[l+1]*(Math.PI/180),d=this.computeGeodeticSurfaceNormal(i[l+1],i[l]),vec3.multiply(g,n,d),h=Math.sqrt(vec3.dot(d,g)),vec3.scale(g,g,1/h),vec3.scale(d,d,i[l+2]),vec3.add(f,d,g),i[l]=f[0],i[l+1]=f[1],i[l+2]=f[2]},this},geo.ellipsoid.WGS84=vgl.freezeObject(geo.ellipsoid(6378137,6378137,6356752.314245179)),geo.ellipsoid.UNIT_SPHERE=vgl.freezeObject(geo.ellipsoid(1,1,1)),geo.mercator={r_major:6378137},geo.mercator.r_minor=function(e){"use strict";var t;return e=void 0!==e?e:!1,t=e?6378137:6356752.314245179},geo.mercator.f=function(e){"use strict";return(geo.mercator.r_major-geo.mercator.r_minor(e))/geo.mercator.r_major},geo.mercator.long2tilex=function(e,t){"use strict";var i=(e+180)/360,r=Math.floor(i*Math.pow(2,t));return r},geo.mercator.lat2tiley=function(e,t){"use strict";var i=e*Math.PI/180;return Math.floor((1-i/Math.PI)/2*Math.pow(2,t))},geo.mercator.long2tilex2=function(e,t){"use strict";var i=(e+180)/360,r=i*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.lat2tiley2=function(e,t){"use strict";var i=e*Math.PI/180,r=(1-Math.log(Math.tan(i)+1/Math.cos(i))/Math.PI)/2*Math.pow(2,t),n=Math.floor(r),o=r-n;return[n,o]},geo.mercator.tilex2long=function(e,t){"use strict";return e/Math.pow(2,t)*360-180},geo.mercator.tiley2lat=function(e,t){"use strict";var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))},geo.mercator.y2lat=function(e){"use strict";return 180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2)},geo.mercator.lat2y=function(e){"use strict";return 180/Math.PI*Math.log(Math.tan(Math.PI/4+e*(Math.PI/180)/2))},geo.mercator.deg2rad=function(e){"use strict";var t=e*(Math.PI/180);return t},geo.mercator.rad2deg=function(e){"use strict";var t=e/(Math.PI/180);return t},geo.mercator.ll2m=function(e,t,i){"use strict";t>89.5&&(t=89.5),-89.5>t&&(t=-89.5);var r=this.r_major*this.deg2rad(e),n=this.r_minor(i)/this.r_major,o=1-n*n,a=Math.sqrt(o),s=this.deg2rad(t),l=Math.sin(s),u=a*l,h=.5*a,d=Math.pow((1-u)/(1+u),h),c=Math.tan(.5*(.5*Math.PI-s))/d,g=-this.r_major*Math.log(c),f={x:r,y:g};return f},geo.mercator.m2ll=function(e,t,i){"use strict";var r=this.rad2deg(e/this.r_major),n=this.r_minor(i)/this.r_major,o=Math.sqrt(1-n*n),a=this.rad2deg(this.pjPhi2(Math.exp(-(t/this.r_major)),o)),s={lon:r,lat:a};return s},geo.mercator.pjPhi2=function(e,t){"use strict";var i,r,n=15,o=Math.PI/2,a=1e-10,s=n,l=.5*t,u=o-2*Math.atan(e);do i=t*Math.sin(u),r=o-2*Math.atan(e*Math.pow((1-i)/(1+i),l))-u,u+=r,s-=1;while(Math.abs(r)>a&&s);return u},geo.latlng=function(e,t){"use strict";if(!(this instanceof geo.latlng))return new geo.latlng(e,t);var i=void 0===t?e.lat():e,r=void 0===t?e.lng():t;return this.lat=function(e){return void 0===e?i:void(i=e)},this.lng=function(e){return void 0===e?r:void(r=e)},this.x=function(e){return void 0===e?this.lng():void(r=e)},this.y=function(e){return void 0===e?this.lat():void(i=e)},this},geo.layerOptions=function(){"use strict";return this instanceof geo.layerOptions?(this.opacity=.5,this.showAttribution=!0,this.visible=!0,this.binNumber=vgl.material.RenderBin.Default,this):new geo.layerOptions},geo.newLayerId=function(){"use strict";var e=1;return function(){var t=e;return e+=1,t}}(),geo.layer=function(e){"use strict";if(!(this instanceof geo.layer))return new geo.layer(e);e=e||{},geo.sceneObject.call(this,e);var t=this,i=void 0===e.style?{opacity:.5,color:[.8,.8,.8],visible:!0,bin:100}:e.style,r=void 0===e.id?geo.newLayerId():e.id,n="",o="EPSG:4326",a=null,s=e.source||null,l=void 0===e.map?null:e.map,u=!1,h=0,d=0,c=0,g=0,f=null,p=null,m=null,v=!1,y=void 0===e.renderer?"vglRenderer":e.renderer,w=geo.timestamp(),_=geo.timestamp(),M=geo.timestamp();return this.node=function(){return f},this.id=function(e){return void 0===e?r:(r=geo.newLayerId(),t.modified(),this)},this.name=function(e){return void 0===e?n:(n=e,t.modified(),this)},this.opacity=function(e){return void 0===e?i.opacity:(i.opacity=e,t.modified(),this)},this.visible=function(e){return void 0===e?i.visible:(i.visible=e,t.modified(),this)},this.bin=function(e){return void 0===e?i.bin:(i.bin=e,t.modified(),this)},this.gcs=function(e){return void 0===e?o:(o=e,t.modified(),this)},this.transform=function(e){return geo.transform.transformLayer(e,t,l.baseLayer()),this},this.timeRange=function(e){return void 0===e?a:(a=e,t.modified(),this)},this.source=function(e){return void 0===e?s:(s=e,t.modified(),this)},this.map=function(e){return void 0===e?l:(l=e,l.node().append(f),t.modified(),this)},this.renderer=function(){return m},this.canvas=function(){return p},this.viewport=function(){return[h,d,c,g]},this.dataTime=function(){return w},this.updateTime=function(){return _},this.drawTime=function(){return M},this.query=function(){},this.referenceLayer=function(e){return void 0!==e?(u=e,t.modified(),this):u},this.initialized=function(e){return void 0!==e?(v=e,this):v},this.toLocal=function(e){return e},this.fromLocal=function(e){return e},this._init=function(){return v?this:(f=$(document.createElement("div")),f.attr("id",n),f.css("position","absolute"),l&&l.node().append(f),p?m=geo.createRenderer(y,t,p):(m=geo.createRenderer(y,t),p=m.canvas()),t.addChild(m),v=!0,this)},this._exit=function(){},this._update=function(){},this._resize=function(e,i,r,n){return h=e,d=i,c=r,g=n,f.width(r),f.height(n),t.modified(),t.trigger(geo.event.resize,{x:e,y:i,width:c,height:g}),this},this.width=function(){return c},this.height=function(){return g},this._draw=function(){},this},inherit(geo.layer,geo.sceneObject),geo.featureLayer=function(e){"use strict";if(!(this instanceof geo.featureLayer))return new geo.featureLayer(e);geo.layer.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this.createFeature=function(e,r){var n=geo.createFeature(e,t,this.renderer(),r);return i||(i=[]),i.push(n),this.features(i),this.modified(),n},this.deleteFeature=function(){},this.features=function(e){return this._features(e)},this._features=function(e){return void 0===e?i||[]:(i=e.slice(0),this.dataTime().modified(),this.modified(),void 0)},this._delete=function(e){var t;for(t=0;t<i.length;t+=1)if(i[t]===e)return i[t]._exit(),this.dataTime().modified(),this.modified(),i.splice(t,1);return this},this._init=function(){return this.initialized()?this:(r.call(this),this.on(geo.event.resize,function(e){t.renderer()._resize(e.x,e.y,e.width,e.height),t._update({}),t.renderer()._render()}),this.on(geo.event.pan,function(e){t._update({event:e}),t.renderer()._render()}),this.on(geo.event.zoom,function(e){t.map()&&t.map().zoom(e.curr_zoom),t._update({event:e}),t.renderer()._render()}),this)},this._update=function(e){var r,o=!1;if(!i)return this;if(n.call(this,e),!this.source()&&i&&0===i.length)return void console.log("[info] No valid data source found.");if(this.dataTime().getMTime()>this.updateTime().getMTime()){for(r=0;r<i.length;r+=1)i[r].renderer(this.renderer());
o=!0}for(r=0;r<i.length;r+=1)i[r]._update();return this.updateTime().modified(),o&&t.renderer().reset(),this},this._draw=function(){return this.renderer()._render(),this},this.clear=function(){var e;if(!i)return this;for(e=0;e<i.length;e+=1)i[e]._exit();return this.dataTime().modified(),this.modified(),i=[],this},this},inherit(geo.featureLayer,geo.layer),geo.registerLayer("feature",geo.featureLayer),geo.event=function(){"use strict";return this instanceof geo.event?(vgl.event.call(this),this):new geo.event},inherit(geo.event,vgl.event),geo.event.update="geo.update",geo.event.opacityUpdate="geo.opacityUpdate",geo.event.layerAdd="geo.layerAdd",geo.event.layerRemove="geo.layerRemove",geo.event.layerToggle="geo.layerToggle",geo.event.layerSelect="geo.layerSelect",geo.event.layerUnselect="geo.layerUnselect",geo.event.zoom="geo.zoom",geo.event.center="geo.center",geo.event.pan="geo.pan",geo.event.rotate="geo.rotate",geo.event.resize="geo.resize",geo.event.animate="geo.animate",geo.event.query="geo.query",geo.event.draw="geo.draw",geo.event.drawEnd="geo.drawEnd",geo.event.animationPause="geo.animationPause",geo.event.animationStop="geo.animationStop",geo.event.animationComplete="geo.animationComplete",geo.time={},geo.time.incrementTime=function(e,t,i){"use strict";return"days"===t?e.setDate(e.getDate()+i):"months"===t?e.setMonth(e.getMonth()+i):"years"===t?e.setYear(e.getYear()+i):"index"===t&&(e+=i),e},geo.map=function(e){"use strict";if(!(this instanceof geo.map))return new geo.map(e);e=e||{},geo.sceneObject.call(this,e),e.layers=void 0===e.layers?[]:e.layers;var t,i,r,n,o,a=this,s=0,l=0,u=$(e.node),h=u.width(),d=u.height(),c=void 0===e.gcs?"EPSG:4326":e.gcs,g=void 0===e.uigcs?"EPSG:4326":e.uigcs,f=void 0===e.center?[0,0]:e.center,p=void 0===e.zoom?10:e.zoom,m=null,v={range:null,timestep:null,layers:null},y={};return y.milliseconds=1,y.seconds=1e3*y.milliseconds,y.minutes=60*y.seconds,y.hours=60*y.minutes,y.days=24*y.hours,y.weeks=7*y.days,y.months=4*y.weeks,y.years=12*y.months,this.on(geo.event.animationPause,function(){n=!0}),this.on(geo.event.animationStop,function(){o=!0}),t=function(e){var t=e.toLowerCase();return y[t]},i=function(e){var i,r,n,o,a,s=null,l=null,u=!1,h=Number.MAX_VALUE;for(a=0;a<e.length;a+=1)if(n=e[a].timeRange()){if("index"===n.deltaUnits)u=!0,o=n.delta;else{if(u)throw"Can't mix index timesteps with time based timesteps";o=t(n.deltaUnits)*n.delta}h>o&&(i=n.delta,r=n.deltaUnits,h=o),(null===s||n.start<s)&&(s=n.start),(null===l||n.end<l)&&(l=n.end)}return{start:s,end:l,delta:i,deltaUnits:r}},r=function(e){return e instanceof Date&&(e=new Date(e.getTime())),e},this.gcs=function(e){return void 0===e?c:(c=e,this)},this.uigcs=function(){return g},this.node=function(){return u},this.zoom=function(e){return void 0===e?p:(p=e,a.modified(),this)},this.center=function(e){return void 0===e?f:(f=e.slice,a.modified(),this)},this.createLayer=function(e,t){var i=geo.createLayer(e,a,t);return null===i&&void 0===i?null:(i._resize(s,l,h,d),(i.referenceLayer()||0===a.children().length)&&a.baseLayer(i),a.addChild(i),a.modified(),a.trigger(geo.event.layerAdd,{type:geo.event.layerAdd,target:a,layer:i}),i)},this.deleteLayer=function(e){return null!==e&&void 0!==e&&(e._exit(),a.removeChild(e),a.modified(),a.trigger(geo.event.layerRemove,{type:geo.event.layerRemove,target:a,layer:e})),e},this.toggle=function(e){return null!==e&&void 0!==e&&(e.visible(!e.visible()),a.modified(),a.trigger(geo.event.layerToggle,{type:geo.event.layerToggle,target:a,layer:e})),this},this.resize=function(e,t,i,r){var n,o=a.children();for(s=e,l=t,h=i,d=r,n=0;n<o.length;n+=1)o[n]._resize(e,t,i,r);return a.trigger(geo.event.resize,{type:geo.event.resize,target:a,x:s,y:l,width:i,height:r}),a.modified(),this},this.gcsToDisplay=function(e){var t,i;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.toLocal(e),i=m.renderer().worldToDisplay(t)},this.displayToGcs=function(e){var t;if(!(e instanceof Array&&e.length>0||e instanceof Object))throw"Conversion method latLonToDisplay does not handle "+e;return t=m.renderer().displayToWorld(e),t=m.fromLocal(t)},this.query=function(){},this.baseLayer=function(e){return void 0!==e?(c!==e.gcs()&&a.gcs(e.gcs()),m=e,m.referenceLayer(!0),this):m},this.draw=function(){var e,t=a.children();for(a.trigger(geo.event.draw,{type:geo.event.draw,target:a}),a._update(),e=0;e<t.length;e+=1)t[e]._draw();return a.trigger(geo.event.drawEnd,{type:geo.event.drawEnd,target:a}),this},this.animate=function(e){var t;if(e=void 0===e?a.children():e,null===v.timestep){if(t=i(e),!t.start||!t.end)throw"Animation range could not be calculated. Check that layers have ranges associated with them";v={range:t,timestep:r(t.start),layers:e}}return this._animate(),this},this.pauseAnimation=function(){return a.trigger(geo.event.animationPause),this},this.stopAnimation=function(){return a.trigger(geo.event.animationStop),v.timestep=null,this},this.stepAnimationForward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.start),layers:e}),a._stepAnimationForward(),this},this.stepAnimationBackward=function(e){var t;return e=void 0===e?v.layers:e,null===e&&(e=a.children()),null===v.timestep&&(t=i(e),v={range:t,timestep:r(t.end),layers:e}),a._stepAnimationBackward(),this},this._animate=function(){function e(){v.timestep>t.end||o?(clearInterval(s),v.timestep=null,a.trigger(geo.event.animationComplete)):n?clearInterval(s):(a._animateTimestep(),v.timestep=geo.time.incrementTime(v.timestep,v.range.deltaUnits,v.range.delta))}var t,i,s;if(t=v.range,i=r(t.start),o=!1,n=!1,i=geo.time.incrementTime(i,t.deltaUnits,t.delta),i>t.end)throw"Invalid time range";return s=setInterval(e,10),this},this._animateTimestep=function(){return v&&($.each(v.layers,function(e,t){var i=v.timestep;i instanceof Date&&(i=i.getTime()),t._update({timestep:i})}),a.trigger(geo.event.animate,{timestep:v.timestep}),a.draw()),this},this._stepAnimationForward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.start)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,v.range.delta),e<=v.range.end&&(v.timestep=e,a._animateTimestep()),this},this._stepAnimationBackward=function(){var e;return null===v.timestep&&(v.timestep=r(v.range.end)),e=r(v.timestep),e=geo.time.incrementTime(e,v.range.deltaUnits,-v.range.delta),e<v.range.start?void 0:(v.timestep=e,a._animateTimestep(),this)},this._init=function(e){var t;if(void 0===u||null===u)throw"Map require DIV node";if(void 0!==e&&void 0!==e.layers)for(t=0;t<e.layers.length;t+=1)0===t&&a.baseLayer(e.layers[t]),a.addLayer(e.layers[t]);return this},this._update=function(e){var t,i=a.children();for(t=0;t<i.length;t+=1)i[t]._update(e);return this},this._exit=function(){var e,t=a.children();for(e=0;e<t.length;e+=1)t[e]._exit()},this._init(e),this},inherit(geo.map,geo.sceneObject),geo.feature=function(e){"use strict";if(!(this instanceof geo.feature))return new geo.feature(e);geo.object.call(this),e=e||{};var t={},i=void 0===e.layer?null:e.layer,r=void 0===e.gcs?"EPSG:4326":e.gcs,n=void 0===e.visible?!0:e.visible,o=void 0===e.bin?0:e.bin,a=void 0===e.renderer?null:e.renderer,s=geo.timestamp(),l=geo.timestamp(),u=geo.timestamp();return this.style=function(e,i){return void 0===e?t:void 0===i?(t=$.extend({},t,e),this.modified(),this):(t[e]=i,this.modified(),this)},this.layer=function(){return i},this.renderer=function(){return a},this.drawables=function(){return this._drawables()},this.gcs=function(e){return void 0===e?r:(r=e,this.modified(),this)},this.visible=function(e){return void 0===e?n:(n=e,this.modified(),this)},this.bin=function(e){return void 0===e?o:(o=e,this.modified(),this)},this.dataTime=function(e){return void 0===e?s:(s=e,this.modified(),this)},this.buildTime=function(e){return void 0===e?l:(l=e,this.modified(),this)},this.updateTime=function(e){return void 0===e?u:(u=e,this.modified(),this)},this._init=function(e){if(!i)throw"Feature requires a valid layer";t=$.extend({},{opacity:1},void 0===e.style?{}:e.style)},this._build=function(){},this._drawables=function(){},this._update=function(){},this._exit=function(){},this._init(e),this},inherit(geo.feature,geo.object),geo.pointFeature=function(e){"use strict";if(!(this instanceof geo.pointFeature))return new geo.pointFeature(e);e=e||{},geo.feature.call(this,e);var t=void 0===e.positions?null:e.positions,i=this._init;return this.positions=function(e){return void 0===e?t:(t=e.slice(0),this.dataTime().modified(),this.modified(),this)},this._init=function(e){i.call(this,e);var r=$.extend({},{size:1,width:1,height:1,color:[1,1,1],point_sprites:!1,point_sprites_image:null},void 0===e.style?{}:e.style);this.style(r),t&&this.dataTime().modified()},this._init(e),this},inherit(geo.pointFeature,geo.feature),geo.lineFeature=function(e){"use strict";if(!(this instanceof geo.lineFeature))return new geo.lineFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=void 0===e.positions?[]:e.positions,r=this._init;return this.positions=function(e){return void 0===e?i:(i=e.slice(0),t.dataTime().modified(),t.modified(),this)},this._init=function(e){r.call(t,e);var n=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);t.style(n),i&&t.dataTime().modified()},this._init(e),this},inherit(geo.lineFeature,geo.feature),geo.pathFeature=function(e){"use strict";if(!(this instanceof geo.pathFeature))return new geo.pathFeature(e);e=e||{},geo.feature.call(this,e);var t=void 0===e.positions?[]:e.positions,i=this._init;return this.positions=function(e){return void 0===e?t:(t=e.slice(0),this.dataTime().modified(),this.modified(),this)},this._init=function(e){i.call(this,e);var r=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===e.style?{}:e.style);this.style(r),t&&this.dataTime().modified()},this._init(e),this},inherit(geo.pathFeature,geo.feature),geo.polygonFeature=function(e){"use strict";if(!(this instanceof geo.polygonFeature))return new geo.polygonFeature(e);e=e||{},geo.feature.call(this,e);var t=this._init;return this._init=function(e){t.call(this,e);var i=$.extend({},{color:[1,1,1],fill_color:[1,1,1],fill:!0},void 0===e.style?{}:e.style);this.style(i)},this._init(e),this},inherit(geo.polygonFeature,geo.feature),geo.planeFeature=function(e){"use strict";if(!(this instanceof geo.planeFeature))return new geo.planeFeature(e);e=e||{},e.ul=void 0===e.ul?[0,1,0]:e.ul,e.lr=void 0===e.lr?[1,0,0]:e.lr,e.depth=void 0===e.depth?0:e.depth,geo.polygonFeature.call(this,e);var t=[e.ul.x,e.lr.y,e.depth],i=[e.ul.x,e.ul.y,e.depth],r=[e.lr.x,e.lr.y,e.depth],n=e.depth,o=void 0===e.drawOnAsyncResourceLoad?!0:!1,a=this._init;return this.origin=function(e){if(void 0===e)return t;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";t=e.slice(0),2===t.length&&(t[2]=n)}else e instanceof geo.latlng&&(t=[e.x(),e.y(),n]);return this.dataTime().modified(),this.modified(),this},this.upperLeft=function(e){if(void 0===e)return i;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";i=e.slice(0),2===i.length&&(i[2]=n)}else e instanceof geo.latlng&&(i=[e.x(),e.y(),n]);return this.dataTime().modified(),this.modified(),this},this.lowerRight=function(e){if(void 0===e)return r;if(e instanceof Array){if(e.length>3||e.length<2)throw"Upper left point requires point in 2 or 3 dimension";r=e.slice(0),2===r.length&&(r[2]=n),this.dataTime().modified()}else e instanceof geo.latlng&&(r=[e.x(),e.y(),n]);return this.dataTime().modified(),this.modified(),this},this.drawOnAsyncResourceLoad=function(e){return void 0===e?o:(o=e,this)},this._init=function(e){var t=null;a.call(this,e),t=this.style(),void 0===t.image&&(t.image=null),this.style(t)},this._init(e),this},inherit(geo.planeFeature,geo.polygonFeature),geo.geomFeature=function(e){"use strict";return this instanceof geo.geomFeature?(e=e||{},geo.feature.call(this,e),e.style=void 0===e.style?$.extend({},{color:[1,1,1],point_sprites:!1,point_sprites_image:null},e.style):e.style,this.style(e.style),this):new geo.geomFeature(e)},inherit(geo.geomFeature,geo.feature),geo.graphFeature=function(e){"use strict";if(!(this instanceof geo.graphFeature))return new geo.graphFeature(e);e=e||{},geo.feature.call(this,e);var t=this,i=this.style,r=null,n=null,o=[],a=this._init;return this._init=function(e){a.call(this,e);var t=$.extend(!0,{},{nodes:{size:5,color:[0,0,1]},links:{color:[1,1,1]},linkType:"path"},void 0===e.style?{}:e.style);this.style(t),r&&this.dataTime().modified()},this.style=function(e){var t=i.call(this,e);return t!==this?t:(n.style(e.nodes),o.forEach(function(t){t.style(e.links)}),this)},this.nodes=function(e){var i,a=t.layer(),s=0;return void 0===e?r:(i=t.style(),r=e.slice(0),n.positions(r),r.forEach(function(e){(e.children||[]).forEach(function(t){s+=1,o.length<s&&o.push(a.createFeature(i.linkType).style(i.links)),o[s-1].positions([e,t])})}),o.splice(s,o.length-s).forEach(function(e){a._delete(e)}),this.dataTime().modified(),this.modified(),this)},n=this.layer().createFeature("point"),e.nodes&&this.nodes(e.nodes),this._init(e),this},inherit(geo.graphFeature,geo.feature),geo.transform={},geo.transform.osmTransformFeature=function(e,t,i){"use strict";if(!t)return void console.log("[warning] Invalid (null) feature");if(t.gcs()!==e){if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";var r,n,o=null,a=0,s=null,l=null,u=null,h=t.gcs();if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if("EPSG:4326"!==h&&geo.transform.transformFeature("EPSG:4326",t,!0),l=t.positions(),s=l.length,!(l instanceof Array))throw"Supports Array of 2D and 3D points";if(l.length>0&&l[0]instanceof geo.latlng?(o=2,a=1):(o=s%2===0?2:s%3===0?3:null,a=o),2!==o&&3!==o)throw"Transform points require points in 2D or 3D";for(u=i?l:l.slice(0),r=0;s>r;r+=a)n=l[r]instanceof geo.latlng?l[r].lat():l[r+1],n>85.0511&&(n=85.0511),-85.0511>n&&(n=-85.0511),l[r]instanceof geo.latlng?u[r]=geo.latlng(geo.mercator.lat2y(n),u[r].lng()):u[r+1]=geo.mercator.lat2y(n);return i&&(t.positions(u),t.gcs(e)),u}return null}},geo.transform.transformFeature=function(e,t,i){"use strict";if(!t)throw"Invalid (null) feature";if(!(t instanceof geo.pointFeature||t instanceof geo.lineFeature))throw"Supports only point or line feature";if(t.gcs()===e)return t.positions();if("EPSG:3857"===e)return geo.transform.osmTransformFeature(e,t,i);var r,n=null,o=0,a=null,s=null,l=null,u=null,h=t.gcs(),d=new proj4.Proj(h),c=new proj4.Proj(e);if(i=!!i,t instanceof geo.pointFeature||t instanceof geo.lineFeature){if(s=t.positions(),a=s.length,!(s instanceof Array))throw"Supports Array of 2D and 3D points";if(s.length>0&&s[0]instanceof geo.latlng?(n=2,o=1):(n=a%2===0?2:a%3===0?3:null,o=n),2!==n&&3!==n)throw"Transform points require points in 2D or 3D";for(i?l=s:(l=[],l.length=s.length),r=0;a>r;r+=o)u=2===n?new proj4.Point(s[r],s[r+1],0):new proj4.Point(s[r],s[r+1],s[r+2]),proj4.transform(d,c,u),2===n?(l[r]=u.x,l[r+1]=u.y):(l[r]=u.x,l[r+1]=u.y,l[r+2]=u.z);return i&&(t.positions(l),t.gcs(e)),l}return null},geo.transform.transformLayer=function(e,t,i){"use strict";var r,n,o;if(!t)throw"Requires valid layer for tranformation";if(!i)throw"Requires baseLayer used by the map";if(t!==i){if(!(t instanceof geo.featureLayer))throw"Only feature layer transformation is supported";for(r=t.features(),n=r.length,o=0,o=0;n>o;o+=1)"EPSG:3857"===e&&i instanceof geo.osmLayer?geo.transform.osmTransformFeature(e,r[o],!0):geo.transform.transformFeature(e,r[o],!0);t.gcs(e)}},geo.renderer=function(e){"use strict";if(!(this instanceof geo.renderer))return new geo.renderer(e);geo.sceneObject.call(this),e=e||{};var t=this,i=void 0===e.layer?null:e.layer,r=void 0===e.canvas?null:e.canvas,n=!1;return this.layer=function(){return i},this.canvas=function(e){return void 0===e?r:(r=e,void this.modified())},this.map=function(){return i?i.map():null},this.baseLayer=function(){return t.map()?t.map().baseLayer():void 0},this.initialized=function(e){return void 0===e?n:(n=e,this)},this.api=function(){throw"Should be implemented by derivied classes"},this.reset=function(){return!0},this.worldToGcs=function(){throw"Should be implemented by derivied classes"},this.displayToGcs=function(){throw"Should be implemented by derivied classes"},this.gcsToDisplay=function(){throw"Should be implemented by derivied classes"},this.worldToDisplay=function(){throw"Should be implemented by derivied classes"},this.displayToWorld=function(){throw"Should be implemented by derivied classes"},this.relMouseCoords=function(e){var t=0,i=0,r=0,n=0,o=this.canvas();do t+=o.offsetLeft-o.scrollLeft,i+=o.offsetTop-o.scrollTop,o=o.offsetParent;while(o);return r=e.pageX-t,n=e.pageY-i,{x:r,y:n}},this._init=function(){},this._resize=function(){},this._render=function(){},this._exit=function(){},this._connectMouseEvents=function(){},this},inherit(geo.renderer,geo.sceneObject),geo.osmLayer=function(e){"use strict";if(!(this instanceof geo.osmLayer))return new geo.osmLayer(e);geo.featureLayer.call(this,e);var t=this,i={},r=0,n=1e3,o=[],a=[],s=0,l=100,u=null,h="http://tile.openstreetmap.org/",d="png",c=this._init,g=this._update;return e&&void 0!==e.baseUrl&&(h=e.baseUrl),e&&void 0!==e.imageFormat&&(d=e.imageFormat),this.tileCacheSize=function(e){return void 0===e?l:(l=e,void this.modified())},this.toLocal=function(e){var t,i,r;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof geo.latlng)for(t=0;t<e.length;t+=1)i[t]=geo.latlng(e[t]),i[t].lat(geo.mercator.lat2y(i[t].lat()));else if(e[0]instanceof Array)if(r=e%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]);else for(t=0;t<e.length;t+=r)i[t]=e[t],i[t+1]=geo.mercator.lat2y(e[t+1]),i[t+2]=e[t+2];else"x"in e[0]&&"y"in e[0]&&"z"in e[0]?i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y),z:e[t].z}:"x"in e[0]&&"y"in e[0]&&"z"in e[0]&&(i[t]={x:e[t].x,y:geo.mercator.lat2y(e[t].y)});else e instanceof geo.latlng?(i={},i.x=e.x(),i.y=geo.mercator.lat2y(e.y())):(i={},i.x=e.x,i.y=geo.mercator.lat2y(e.y));return i},this.fromLocal=function(e){var t,i;if(e instanceof Array&&e.length>0)if(i=[],i.length=e.length,e[0]instanceof Object)for(t=0;t<e.length;t+=1)i[t]={},i[t].x=e[t].x,i[t].y=geo.mercator.y2lat(e[t].y);else if(e[0]instanceof Array)for(t=0;t<e.length;t+=1)i[t]=e[t],i[t][1]=geo.mercator.y2lat(e[t][1]);else for(t=0;t<e.length;t+=1)i[t]=e[t],i[t+1]=geo.mercator.y2lat(e[t+1]);else i={},i.x=e.x,i.y=geo.mercator.y2lat(e.y);return i},this._hasTile=function(e,t,r){return i[e]&&i[e][t]&&i[e][t][r]?!0:!1},this._addTile=function(e,t,r,n){if(i[t]||(i[t]={}),i[t][r]||(i[t][r]={}),!i[t][r][n]){var a=Math.max(1,Math.pow(2,t)),l=Math.max(1,Math.pow(2,t)),u=360,c=360/a,g=u/l,f=-180+r*c,p=.5*-u+n*g,m=-180+(r+1)*c,v=.5*-u+(n+1)*g,y=new Image;return y.LOADING=!0,y.LOADED=!1,y.REMOVED=!1,y.REMOVING=!1,y.crossOrigin="anonymous",y.zoom=t,y.index_x=r,y.index_y=n,y.llx=f,y.lly=p,y.urx=m,y.ury=v,y.lastused=new Date,y.src=h+t+"/"+r+"/"+(Math.pow(2,t)-1-n)+"."+d,i[t][r][n]=y,o.push(y),s+=1,y}},this._removeTiles=function(){var e,o,h,d,c=this.map().zoom();if(!i)return this;if(u===c)return this;u=c;for(d in i)if(c!==d)for(e in i[d])for(o in i[d][e])h=i[d][e][o],h&&(h.REMOVING=!0,a.push(h));return setTimeout(function(){var e,o;for(a.sort(function(e,t){return e.lastused-t.lastused}),o=0;s>l&&o<a.length;)e=a[o],e.zoom!==t.map().zoom()&&(t._delete(e.feature),delete i[e.zoom][e.index_x][e.index_y],a.splice(o,1),s-=1),o+=1;for(o=0;o<a.length;o+=1)e=a[o],e.zoom!==t.map().zoom()?(e.REMOVING=!1,e.REMOVED=!0,e.feature.bin(r)):(e.REMOVING=!1,e.REMOVED=!1,e.lastused=new Date,e.feature.bin(n)),e.feature._update();a=[],t._draw()},100),this},this._addTiles=function(e){function a(e){return function(){e.LOADING=!1,e.LOADED=!0,(e.REMOVING||e.REMOVED)&&e.feature&&e.zoom!==t.map().zoom()?(e.feature.bin(r),e.REMOVING=!1,e.REMOVED=!0):(e.REMOVED=!1,e.lastused=new Date,e.feature.bin(n)),e.feature._update(),t._draw()}}var s,l=this.renderer(),u=this.map().zoom(),h=0,d=this.height(),c=this.width(),g=0,f=null,p=null,m=null,v=null,y=null,w=null,_=null,M=0,x=0,b=l.displayToWorld([h,d]),T=l.displayToWorld([c,g]);for(b[0]=Math.max(b[0],-180),b[0]=Math.min(b[0],180),b[1]=Math.max(b[1],-180),b[1]=Math.min(b[1],180),T[0]=Math.max(T[0],-180),T[0]=Math.min(T[0],180),T[1]=Math.max(T[1],-180),T[1]=Math.min(T[1],180),m=geo.mercator.long2tilex(b[0],u),v=geo.mercator.lat2tiley(b[1],u),y=geo.mercator.long2tilex(T[0],u),w=geo.mercator.lat2tiley(T[1],u),m=Math.max(m,0),m=Math.min(Math.pow(2,u)-1,m),v=Math.max(v,0),v=Math.min(Math.pow(2,u)-1,v),y=Math.max(y,0),y=Math.min(Math.pow(2,u)-1,y),w=Math.max(w,0),w=Math.min(Math.pow(2,u)-1,w),m>y&&(f=m,m=y,y=f),w>v&&(f=v,m=w,w=f),M=m;y>=M;M+=1)for(x=w;v>=x;x+=1)_=Math.pow(2,u)-1-x,t._hasTile(u,M,_)?(p=i[u][M][_],p.feature.bin(n),p.lastused=new Date,p.feature._update()):t._addTile(e,u,M,_);for(M=0;M<o.length;M+=1)p=o[M],p.onload=a(p),s=this.createFeature("plane",{drawOnAsyncResourceLoad:!1}).origin([p.llx,p.lly]).upperLeft([p.llx,p.ury]).lowerRight([p.urx,p.lly]).gcs('"EPSG:3857"').style("image",p),p.feature=s;o=[]},this._updateTiles=function(e){return this._addTiles(e),t._removeTiles(e),t._draw(),this.updateTime().modified(),this},this._init=function(){return c.call(this),this.gcs("EPSG:3857"),this},this._update=function(e){this._updateTiles(e),g.call(this,e)},this},inherit(geo.osmLayer,geo.featureLayer),geo.registerLayer("osm",geo.osmLayer),ggl=ogs.namespace("geo.gl"),ggl.renderer=function(e){"use strict";return this instanceof ggl.renderer?(geo.renderer.call(this,e),this.contextRenderer=function(){throw"Should be implemented by derived classes"},this):new ggl.renderer(e)},inherit(ggl.renderer,geo.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),ggl.pointFeature=function(e){"use strict";if(!(this instanceof ggl.pointFeature))return new ggl.pointFeature(e);e=e||{},geo.pointFeature.call(this,e);var t=this,i=null,r=this._init,n=this._update;return this._init=function(e){r.call(this,e)},this._build=function(){var e=t.style(),r=geo.transform.transformFeature(t.renderer().map().gcs(),this,!1);if(i&&this.renderer().contextRenderer().removeActor(i),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";i=vgl.utils.createPointSprites(e.point_sprites_image,r,e.colors)}else i=vgl.utils.createPoints(r,e.colors);this.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){var e=t.style();if(n.call(this),this.dataTime().getMTime()>=this.buildTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime())if(this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color),e.point_sprites===!0){if(null===e.point_sprites_image)throw"[error] Invalid image for point sprites";e.width&&e.height?i.material().shaderProgram().uniform("pointSize").set([e.width,e.height]):e.size&&i.material().shaderProgram().uniform("pointSize").set([e.size,e.size])}else e.size&&i.material().shaderProgram().uniform("pointSize").set(e.size);this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this._init(e),this},inherit(ggl.pointFeature,geo.pointFeature),geo.registerFeature("vgl","point",ggl.pointFeature),ggl.geomFeature=function(e){"use strict";if(!(this instanceof ggl.geomFeature))return new ggl.geomFeature(e);e=e||{},geo.geomFeature.call(this,e);var t=this,i=e.geom||null,r=vgl.actor(),n=vgl.mapper(),o=null,a=null,s=e.color||[1,1,1],l=null,u=0;return this._build=function(){var e=t.style();null!==i&&(a=i.sourceData(vgl.vertexAttributeKeys.Scalar),s=i.sourceData(vgl.vertexAttributeKeys.Color),n.setGeometryData(i)),this.setMapper(n),void 0!==e.point_sprites&&e.point_sprites&&void 0!==e.point_sprites_image&&null!==e.point_sprites_image&&1===u&&i.primitive(0).primitiveType()===gl.POINTS?o=vgl.utils.createPointSpritesMaterial(e.point_sprites_image):a?s instanceof vgl.lookupTable?(s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):(s=vgl.lookupTable(),s.updateRange(a.scalarRange()),o=vgl.utils.createColorMappedMaterial(s)):o=s?vgl.utils.createColorMaterial():vgl.utils.createSolidColorMaterial(),r.setMaterial(o)},this._update=function(){l&&l.getMTime()<this.getMTime()?s instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(this.material(),this.style.color):(l=vgl.timestamp(),l.modified())},this.geometry=function(e){return void 0===e?i:(i=e,this.modified(),this)},this},inherit(ggl.geomFeature,geo.geomFeature),ggl.planeFeature=function(e){"use strict";if(!(this instanceof ggl.planeFeature))return new ggl.planeFeature(e);geo.planeFeature.call(this,e);var t=this,i=null;return this.coords=function(){return[this.origin(),this.upperLeft(),this.lowerRight()]},this._build=function(){var e=this.origin(),r=this.upperLeft(),n=this.lowerRight(),o=this.style().image,a=null,s=null,l=null;i&&this.renderer().contextRenderer().removeActor(i),o&&o instanceof Image?(a=o,s=o.onload):o&&(a=new Image,a.src=o),a?(i=vgl.utils.createTexturePlane(e[0],e[1],e[2],n[0],n[1],n[2],r[0],r[1],r[2],!0),l=vgl.texture(),t.visible(!1),a.onload=function(){l.setImage(a),i.material().addAttribute(l),t.visible(!0),s&&s.call(this),t.drawOnAsyncResourceLoad()&&(t._update(),t.layer()._draw())}):i=vgl.utils.createPlane(e[0],e[1],e[2],r[0],r[1],r[2],n[0],n[1],n[2]),t.renderer().contextRenderer().addActor(i),this.buildTime().modified()},this._update=function(){this.buildTime().getMTime()<=this.dataTime().getMTime()&&this._build(),this.updateTime().getMTime()<=this.getMTime()&&(i.setVisible(this.visible()),i.material().setBinNumber(this.bin())),this.updateTime().modified()},this._exit=function(){t.renderer().contextRenderer().removeActor(i)},this},inherit(ggl.planeFeature,geo.planeFeature),geo.registerFeature("vgl","plane",ggl.planeFeature),ggl.mapInteractorStyle=function(){"use strict";function e(){var e,t=u.position(),i=t[2]*Math.sin(u.viewAngle());for(e=0;20>e;e+=1)if(i>=360/Math.pow(2,e))return e}function t(e){var t=360/Math.pow(2,e);return t/Math.sin(u.viewAngle())}if(!(this instanceof ggl.mapInteractorStyle))return new ggl.mapInteractorStyle;vgl.interactorStyle.call(this);var i,r,n,o,a,s,l,u,h,d,c,g,f,p=this,m=!1,v=!1,y=!1,w=!1,_=!1,M={x:0,y:0},x=new vgl.picker,b=vgl.timestamp();return this.map=function(e){return void 0!==e?(i=e,p):i},this.drawRegionMode=function(e){return void 0!==e?(_=e,r&&r.setVisible(e),i.draw(),p):_},this._panCamera=function(e){var t,i,r,n,o,a=e.focusDisplayPoint();t=l.displayToWorld(d.x,d.y,a,e),i=l.displayToWorld(M.x,M.y,a,e),r=t[0]-i[0],n=t[1]-i[1],o=t[2]-i[2],e.camera().pan(-r,-n,-o)},this.handleMouseMove=function(e){var t,r,o,s,c,f;if(p.updateRenderParams(),p._computeCurrentMousePos(e),h===!0)return!0;if(m)if(_)t=i.displayToMap(d.x,d.y),p.setDrawRegion(n.lat(),n.lng(),t.y,t.x);else{for(r=u.position(),f=l.renderers(),c=0;c<f.length;c+=1)p._panCamera(f[c]);o=u.position(),s={type:geo.event.pan,last_display_pos:M,curr_display_pos:d,last_world_pos:r,curr_world_pos:o},$(p).trigger(s)}return v&&a>0&&(g=2*(d.y-M.y)/a,p.zoom()),M.x=d.x,M.y=d.y,!1},this.handleMouseDown=function(e){var t;return p.updateRenderParams(),0===e.button&&(m=!0),1===e.button&&(y=!0),2===e.button&&(v=!0),f=p.viewer().relMouseCoords(e),M.x=f.x<0?0:f.x,M.y=f.y<0?0:f.y,_&&m&&(t=i.displayToMap(M.x,M.y),n=geo.latlng(t.y,t.x),p.setDrawRegion(t.y,t.x,t.y,t.x)),!1},this.handleMouseUp=function(e){var t=null,i=null,r=null;return p.updateRenderParams(),0===e.button&&(m=!1,t=p.viewer().renderWindow().windowSize()[0],i=p.viewer().renderWindow().windowSize()[1],s=p.viewer().renderWindow().activeRenderer(),M.x>=0&&M.x<=t&&M.y>=0&&M.y<=i&&(r=x.pick(M.x,M.y,s))),1===e.button&&(y=!1),2===e.button&&(v=!1,w=!1,p.zoom()),!1},this.handleMouseOut=function(){return p.updateRenderParams(),m?m=!1:y&&(y=!1),v&&(v=!1,w=!1,p.zoom()),!1},this.handleMouseWheel=function(e){p.updateRenderParams();var t=e.originalEvent.wheelDeltaY/120;return t=Math.pow(1+Math.abs(t)/2,t>0?-1:1),p._computeCurrentMousePos(e),p.zoom(t),!1},this._syncZoom=function(e){var t,i,r,n,o;for(p.updateRenderParams(),e&&(u.zoom(e),s.resetCameraClippingRange()),r=u.position(),n=u.focalPoint(),i=l.renderers(),t=0;t<i.length;t+=1)o=i[t].camera(),o!==u&&(o.setPosition(r[0],r[1],r[2]),o.setFocalPoint(n[0],n[1],n[2]),i[t].resetCameraClippingRange(),i[t].render())},this._syncReset=function(){var e,r,n,o,a,h,d,c;p.updateRenderParams(),a=i.zoom(),h=i.center(),o=u.focalPoint(),h=i.baseLayer().toLocal(geo.latlng(h[0],h[1])),h instanceof Object&&"x"in h&&"y"in h&&i.baseLayer()instanceof geo.osmLayer&&(u.setPosition(h.x,h.y,t(a)),u.setFocalPoint(h.x,h.y,o[2]),s.resetCameraClippingRange()),o=u.focalPoint(),n=u.position(),c=u.clippingRange(),r=l.renderers();for(e=0;e<r.length;e+=1)d=r[e].camera(),d!==u&&(console.log("Setting camera for ren ",r[e].layer()),console.log("Setting pos ",n),d.setPosition(n[0],n[1],n[2]),d.setFocalPoint(o[0],o[1],o[2]),d.setClippingRange(c[0],c[1]),r[e].render())},this._syncPan=function(){},this.zoom=function(i){var r,n,o,l=u.position();p.updateRenderParams(),g=(d.y-M.y)/a,void 0===i&&(i=0>g?1-Math.abs(g):1+Math.abs(g)),o=e(),l[2]*Math.sin(u.viewAngle())>=360&&i>1?(u.setPosition(l[0],l[1],t(0)),s.resetCameraClippingRange(),n=0):(this._syncZoom(i),n=e()),l=u.position(),l[2]*Math.sin(u.viewAngle())>=360&&i>1&&(u.setPosition(l[0],l[1],t(0)),s.resetCameraClippingRange(),n=0,this._syncZoom()),r={type:geo.event.zoom,curr_zoom:n,last_zoom:o},$(p).trigger(r)},this.lastMousePosition=function(e){return void 0!==e?(M=e,p):M},this.leftMouseDown=function(e){return void 0!==e?(m=e,p):m},this.setDrawRegion=function(e,t,n,o){var a,s=geo.planeFeature(geo.latlng(e,t),geo.latlng(n,o),99);return i.removeLayer(r),r=geo.featureLayer({opacity:.5,showAttribution:1},s),i.addLayer(r),a=jQuery.Event(geo.event.updateDrawRegionEvent),$(p).trigger(geo.command.updateDrawRegionEvent,a),p},this.getDrawRegion=function(){return r.features()[0].getCoords()},this._computeCurrentMousePos=function(e){p.updateRenderParams(),h=!1,f=p.viewer().relMouseCoords(e),d={x:0,y:0},f.x<0||f.x>o?(d.x=0,h=!0):d.x=f.x,f.y<0||f.y>a?(d.y=0,h=!0):d.y=f.y},this.updateRenderParams=function(){l=p.viewer().renderWindow(),o=l.windowSize()[0],a=l.windowSize()[1],s=p.viewer().renderWindow().activeRenderer(),u=s.camera(),c=l.focusDisplayPoint(),b.modified()},this.reset=function(){var e,t;i&&(p._syncReset(),e={type:geo.event.zoom,curr_zoom:t,last_zoom:t},$(p).trigger(e))},this},inherit(ggl.mapInteractorStyle,vgl.interactorStyle),ggl._vglViewerInstance=null,ggl.vglViewerInstance=function(){"use strict";var e;return null===ggl._vglViewerInstance&&(e=$(document.createElement("canvas")),e.attr("class",".webgl-canvas"),ggl._vglViewerInstance=vgl.viewer(e.get(0)),ggl._vglViewerInstance.renderWindow().removeRenderer(ggl._vglViewerInstance.renderWindow().activeRenderer()),ggl._vglViewerInstance.setInteractorStyle(ggl.mapInteractorStyle()),ggl._vglViewerInstance.init()),ggl._vglViewerInstance},ggl.vglRenderer=function(e){"use strict";if(!(this instanceof ggl.vglRenderer))return new ggl.vglRenderer(e);ggl.renderer.call(this,e);var t=this,i=ggl.vglViewerInstance(),r=vgl.renderer(),n=0,o=0,a=this._init;return this.displayToWorld=function(e){var i,r,a,s,l,u=t.contextRenderer(),h=u.camera(),d=u.focusDisplayPoint();if(e instanceof Array&&e.length>0)if(a=[],e[0]instanceof Object)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l.x,l.y,d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a.push({x:s[0],y:s[1],z:s[2],w:s[3]});else if(e[0]instanceof Array)for(r=1,i=0;i<e.length;i+=r)l=e[i],s=u.displayToWorld(vec4.fromValues(l[0],l[1],d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a.push(s);else for(r=e.length%3===0?3:2,i=0;i<e.length;i+=r)s=u.displayToWorld(vec4.fromValues(e[i],e[i+1],d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a.push(s[0]),a.push(s[1]),a.push(s[2]),a.push(s[3]);else{if(!(e instanceof Object))throw"Display to world conversion requires array of 2D/3D points";
a={},s=u.displayToWorld(vec4.fromValues(e.x,e.y,d[2],1),h.viewMatrix(),h.projectionMatrix(),n,o),a={x:s[0],y:s[1],z:s[2],w:s[3]}}return a},this.worldToDisplay=function(e){var t,i,r,a=this.contextRenderer(),s=a.camera(),l=s.focalPoint(),u=[];if(e instanceof Array&&e.length>0)if(u=[],e[0]instanceof Object)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t].x,e[t].y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t]={x:i[0],y:i[1],z:i[2]};else if(e[0]instanceof Array)for(r=1,t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t][0],e[t][1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u[t].push(i);else if(r=e.length%3===0?3:2,2===r)for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else for(t=0;t<e.length;t+=r)i=a.worldToDisplay(vec4.fromValues(e[t],e[t+1],e[t+2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u.push(i[0]),u.push(i[1]),u.push(i[2]);else{if(!(e instanceof Object))throw"World to display conversion requires array of 2D/3D points";i=a.worldToDisplay(vec4.fromValues(e.x,e.y,l[2],1),s.viewMatrix(),s.projectionMatrix(),n,o),u={x:i[0],y:i[1],z:i[2]}}return u},this.contextRenderer=function(){return r},this.api=function(){return"vgl"},this.reset=function(){i.interactorStyle().reset()},this._init=function(){return this.initialized()?this:(a.call(this),this.canvas($(i.canvas())),i.renderWindow().renderers().length>0&&(r.setLayer(i.renderWindow().renderers().length),r.setResetScene(!1)),i.renderWindow().addRenderer(r),this.layer().node().append(this.canvas()),$(i.interactorStyle()).on(geo.event.pan,function(e){t.trigger(geo.event.pan,e)}),$(i.interactorStyle()).on(geo.event.zoom,function(e){t.trigger(geo.event.zoom,e)}),this)},this._connectMapEvents=function(){if(t.layer().referenceLayer()){var e=$(t.layer().map().node());e.on("mousewheel",function(e){i.handleMouseWheel(e)}),e.on("mousemove",function(e){i.handleMouseMove(e)}),e.on("mouseup",function(e){i.handleMouseUp(e)}),e.on("mousedown",function(e){i.handleMouseDown(e)}),e.on("mouseout",function(t){var r=$(e),n=r.offset(),o=r.width(),a=r.height(),s=t.pageX-n.left,l=t.pageY-n.top;(0>s||s>=o||0>l||l>=a)&&i.handleMouseOut(t)}),e.on("keypress",function(e){i.handleKeyPress(e)}),e.on("contextmenu",function(e){i.handleContextMenu(e)})}i.interactorStyle().map(this.layer().map())},this.on(geo.event.layerAdd,function(e){e.layer===t.layer()&&t._connectMapEvents()}),this._resize=function(e,t,r,a){return n=r,o=a,this.canvas().attr("width",r),this.canvas().attr("height",a),i.renderWindow().positionAndResize(e,t,r,a),this._render(),this},this._render=function(){return i.render(),this},this._exit=function(){},this},inherit(ggl.vglRenderer,ggl.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),gd3=ogs.namespace("geo.d3"),function(e){"use strict";var t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",i=8;e.uniqueID=function(){var e,r=[];for(r.length=i,e=0;i>e;e+=1)r[e]=t.charAt(Math.floor(Math.random()*t.length));return r.join("")}}(gd3),gd3.object=function(e){"use strict";if(!(this instanceof geo.object))return new gd3.object(e);var t="d3-"+gd3.uniqueID();return this._d3id=function(){return t},geo.sceneObject.call(this),this},inherit(gd3.object,geo.sceneObject),gd3.pointFeature=function(e){"use strict";function t(e,t){if(!t&&e.hasOwnProperty("_dispx")&&e.hasOwnProperty("_dispy"))return e;var r,n=i.renderer();return r=n.worldToDisplay(e),e._dispx=function(){return r.x},e._dispy=function(){return r.y},e}if(!(this instanceof gd3.pointFeature))return new gd3.pointFeature(e);e=e||{},geo.pointFeature.call(this,e),gd3.object.call(this);var i=this,r={cx:function(e){return t(e,!0)._dispx()},cy:function(e){return t(e)._dispy()},r:"1px"},n={fill:"black",stroke:"none"},o=this._init,a=this._update,s=geo.timestamp(),l={};return this._init=function(e){return o.call(this,e),this},this._drawables=function(){return d3.selectAll("."+this._d3id())},this._build=function(){var e=this.positions(),t=this.style();return a.call(this),e||(e=[]),l.id=i._d3id(),l.data=e,l.append="circle",l.style=$.extend({},n),l.attributes=$.extend({},r),l.classes=["d3PointFeature"],l.style.fill=d3.rgb(255*t.color[0],255*t.color[1],255*t.color[2]),l.attributes.r=t.size.toString()+"px",l.style["fill-opacity"]=t.opacity,this.renderer().drawFeatures(l),s.modified(),this.updateTime().modified(),this},this._update=function(){return a.call(this),this.dataTime().getMTime()>=s.getMTime()&&this._build(),this},this._init(e),this},inherit(gd3.pointFeature,geo.pointFeature),geo.registerFeature("d3","point",gd3.pointFeature),gd3.lineFeature=function(e){"use strict";function t(e){var t,r=i.renderer();return t=r.worldToDisplay(e)}if(!(this instanceof gd3.lineFeature))return new gd3.lineFeature(e);e=e||{},geo.lineFeature.call(this,e),gd3.object.call(this);var i=this,r=this._init,n=geo.timestamp(),o=this._update,a={};return this._init=function(e){return r.call(this,e),this},this._build=function(){var e=this.positions(),r=this.style(),s=d3.svg.line().x(function(e){return t(e).x}).y(function(e){return t(e).y});return o.call(this),a.data=[e],a.attributes={d:s},a.id=i._d3id(),a.append="path",a.classes=["d3LineFeature"],a.style={fill:"none",stroke:d3.rgb(255*r.color[0],255*r.color[1],255*r.color[2]),"stroke-width":r.width[0].toString()+"px","stroke-opacity":r.opacity},this.renderer().drawFeatures(a),n.modified(),this.updateTime().modified(),this},this._update=function(){return o.call(this),this.dataTime().getMTime()>=n.getMTime()&&this._build(),this},this._init(e),this},inherit(gd3.lineFeature,geo.lineFeature),geo.registerFeature("d3","line",gd3.lineFeature),gd3.pathFeature=function(e){"use strict";function t(e){var t,r=i.renderer();return t=r.worldToDisplay(e)}if(!(this instanceof gd3.pathFeature))return new gd3.pathFeature(e);e=e||{},geo.pathFeature.call(this,e),gd3.object.call(this);var i=this,r=this._init,n=geo.timestamp(),o=this._update,a={};return this._init=function(e){return r.call(this,e),this},this._build=function(){var e,r,s=this.positions(),l=this.style();return o.call(this),r=function(e){var i=t(e.source),r=t(e.target),n={source:i,target:r};return d3.svg.diagonal()(n)},e=[],s.forEach(function(t,i){var r,n;i<s.length-1&&(r=t,n=s[i+1],e.push({source:r,target:n}))}),a.data=e,a.attributes={d:r},a.id=i._d3id(),a.append="path",a.classes=["d3PathFeature"],a.style={fill:"none",stroke:d3.rgb(255*l.color[0],255*l.color[1],255*l.color[2]),"stroke-width":l.width[0].toString()+"px","stroke-opacity":l.opacity},this.renderer().drawFeatures(a),n.modified(),this.updateTime().modified(),this},this._update=function(){return o.call(this),this.dataTime().getMTime()>=n.getMTime()&&this._build(),this},this._init(e),this},inherit(gd3.pathFeature,geo.pathFeature),geo.registerFeature("d3","path",gd3.pathFeature),gd3.graphFeature=function(e){"use strict";return this instanceof gd3.graphFeature?(geo.graphFeature.call(this,e),this):new gd3.graphFeature(e)},inherit(gd3.graphFeature,geo.graphFeature),geo.registerFeature("d3","graph",gd3.graphFeature),gd3.d3Renderer=function(e){"use strict";function t(e,t){var i;for(i in t)t.hasOwnProperty(i)&&e.attr(i,t[i])}function i(){var e=o.layer();return e?e.map():null}function r(e){void 0===e?(l[0]=0,l[1]=0):(l[0]+=e.x,l[1]+=e.y),o.canvas().selectAll(".group-"+o._d3id()).attr("transform","translate("+l.join()+")")}function n(e){var t=o.canvas(),i=t.selectAll(".group-"+e).data([0]);return i.enter().append("g").attr("class","group-"+e),i}if(!(this instanceof gd3.d3Renderer))return new gd3.d3Renderer(e);geo.renderer.call(this,e),gd3.object.call(this);var o=this,a=this._init,s={},l=[0,0];return this._init=function(e){if(a.call(this,e),!this.canvas()){var t=d3.select(this.layer().node().get(0)).append("svg");t.attr("class",this._d3id()),t.attr("width",this.layer().node().width()),t.attr("height",this.layer().node().height()),this.canvas(t)}},this.displayToWorld=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";return t.displayToGcs(e)},this.worldToDisplay=function(e){var t=i();if(!t)throw"Cannot project until this layer is connected to a map.";var r=t.gcsToDisplay(e);return r.x-=l[0],r.y-=l[1],r},this.api=function(){return"d3"},this._resize=function(e,t,i,n){o.canvas().attr("width",i),o.canvas().attr("height",n),r(),o.updateFeatures()},this._render=function(){},this._exit=function(){this.canvas().remove()},this.drawFeatures=function(e){return s[e.id]={data:e.data,index:e.dataIndex,style:e.style,attributes:e.attributes,classes:e.classes,append:e.append},r(),o.updateFeatures(e.id)},this.updateFeatures=function(e){var i;if(void 0===e){for(i in s)s.hasOwnProperty(i)&&o.updateFeatures(i);return this}var r=n(o._d3id()),a=s[e].data,l=s[e].index,u=s[e].style,h=s[e].attributes,d=s[e].classes,c=s[e].append,g=r.selectAll("."+e).data(a,l);return g.enter().append(c),g.exit().remove(),t(g,h),g.attr("class",d.concat([e]).join(" ")),g.style(u),this},this.on(geo.event.pan,function(e){r({x:e.curr_display_pos.x-e.last_display_pos.x,y:e.curr_display_pos.y-e.last_display_pos.y})}),this.on(geo.event.zoom,function(){r(),o.updateFeatures()}),this.on(geo.event.resize,function(e){o._resize(e.x,e.y,e.width,e.height)}),this._init(e),this},inherit(gd3.d3Renderer,geo.renderer),geo.registerRenderer("d3Renderer",gd3.d3Renderer),geo.version="0.1.0";