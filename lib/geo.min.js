var ogs;ogs=window&&void 0!==window.ogs?window.ogs:{},ogs.namespace=function(ns_string){"use strict";var i,parts=ns_string.split("."),parent=ogs;for("ogs"===parts[0]&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)void 0===parent[parts[i]]&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent};var geo=ogs.namespace("geo");window.geo=geo,geo.renderers={},geo.features={},geo.fileReaders={},inherit=function(C,P){"use strict";var F=function(){};F.prototype=P.prototype,C.prototype=new F,C.uber=P.prototype,C.prototype.constructor=C},Object.size=function(obj){"use strict";var size=0,key=null;for(key in obj)obj.hasOwnProperty(key)&&(size+=1);return size},geo.registerFileReader=function(name,func){"use strict";void 0===geo.fileReaders&&(geo.fileReaders={}),geo.fileReaders[name]=func},geo.createFileReader=function(name,opts){"use strict";return geo.fileReaders.hasOwnProperty(name)?geo.fileReaders[name](opts):null},geo.registerRenderer=function(name,func){"use strict";void 0===geo.renderers&&(geo.renderers={}),geo.renderers[name]=func},geo.createRenderer=function(name,layer,canvas){"use strict";if(geo.renderers.hasOwnProperty(name)){var ren=geo.renderers[name]({layer:layer,canvas:canvas});return ren._init(),ren}return null},geo.registerFeature=function(category,name,func){"use strict";void 0===geo.features&&(geo.features={}),category in geo.features||(geo.features[category]={}),geo.features[category][name]=func},geo.createFeature=function(name,layer,renderer,arg){"use strict";var category=renderer.api(),options={layer:layer,renderer:renderer};return category in geo.features&&name in geo.features[category]?(void 0!==arg&&$.extend(!0,options,arg),geo.features[category][name](options)):null},geo.registerLayer=function(name,func){"use strict";void 0===geo.layers&&(geo.layers={}),geo.layers[name]=func},geo.createLayer=function(name,map,arg){"use strict";var options={map:map,renderer:"vglRenderer"},layer=null;return name in geo.layers?(void 0!==arg&&$.extend(!0,options,arg),layer=geo.layers[name](options),layer._init(),layer):null},geo.object=function(){"use strict";if(!(this instanceof geo.object))return new geo.object;var m_this=this,m_eventHandlers={},m_idleHandlers=[],m_deferredCount=0;return this.onIdle=function(handler){m_deferredCount?m_idleHandlers.push(handler):handler()},this.addDeferred=function(defer){m_deferredCount+=1,defer.done(function(){m_deferredCount-=1,m_deferredCount||m_idleHandlers.splice(0,m_idleHandlers.length).forEach(function(handler){handler()})})},this.on=function(event,handler){return Array.isArray(event)?(event.forEach(function(e){m_this.on(e,handler)}),m_this):(m_eventHandlers.hasOwnProperty(event)||(m_eventHandlers[event]=[]),m_eventHandlers[event].push(handler),m_this)},this.trigger=function(event,args){return Array.isArray(event)?(event.forEach(function(e){m_this.trigger(e,args)}),m_this):(m_eventHandlers.hasOwnProperty(event)&&m_eventHandlers[event].forEach(function(handler){handler(args)}),m_this)},this.off=function(event,arg){if(Array.isArray(event))return event.forEach(function(e){m_this.off(e,arg)}),m_this;if(arg){if(Array.isArray(arg))return arg.forEach(function(handler){m_this.off(event,handler)}),m_this}else m_eventHandlers[event]=[];return m_eventHandlers.hasOwnProperty(event)&&(m_eventHandlers[event]=m_eventHandlers[event].filter(function(f){return f!==arg})),m_this},vgl.object.call(this),this},inherit(geo.object,vgl.object),geo.sceneObject=function(arg){"use strict";if(!(this instanceof geo.sceneObject))return new geo.sceneObject;geo.object.call(this,arg);var m_this=this,m_parent=null,m_children=[],s_trigger=this.trigger,s_addDeferred=this.addDeferred,s_onIdle=this.onIdle;return this.addDeferred=function(defer){m_parent?m_parent.addDeferred(defer):s_addDeferred(defer)},this.onIdle=function(handler){m_parent?m_parent.onIdle(handler):s_onIdle(handler)},this.parent=function(arg){return void 0===arg?m_parent:(m_parent=arg,m_this)},this.addChild=function(child){return Array.isArray(child)?(child.forEach(m_this.addChild),m_this):(child.parent(m_this),m_children.push(child),m_this)},this.removeChild=function(child){return Array.isArray(child)?(child.forEach(m_this.removeChild),m_this):(m_children=m_children.filter(function(c){return c!==child}),m_this)},this.children=function(){return m_children.slice()},this.draw=function(arg){return m_this.children().forEach(function(child){child.draw(arg)}),m_this},this.trigger=function(event,args,childrenOnly){var geoArgs;return args=args||{},geoArgs=args.geo||{},args.geo=geoArgs,!childrenOnly&&m_parent&&geoArgs._triggeredBy!==m_parent?(geoArgs._triggeredBy=m_this,m_parent.trigger(event,args),m_this):(s_trigger.call(m_this,event,args),geoArgs.stopPropagation?m_this:(m_children.forEach(function(child){geoArgs._triggeredBy=m_this,child.trigger(event,args)}),m_this))},this},inherit(geo.sceneObject,geo.object),geo.timestamp=function(){"use strict";return this instanceof geo.timestamp?void vgl.timestamp.call(this):new geo.timestamp},inherit(geo.timestamp,vgl.timestamp),geo.ellipsoid=function(x,y,z){"use strict";if(!(this instanceof geo.ellipsoid))return new geo.ellipsoid(x,y,z);if(x=vgl.defaultValue(x,0),y=vgl.defaultValue(y,0),z=vgl.defaultValue(z,0),0>x||0>y||0>z)return console.log("[error] Al radii components must be greater than zero");var m_this=this,m_radii=new vec3.fromValues(x,y,z),m_radiiSquared=new vec3.fromValues(x*x,y*y,z*z),m_minimumRadius=Math.min(x,y,z),m_maximumRadius=Math.max(x,y,z);return this.radii=function(){return m_radii},this.radiiSquared=function(){return m_radiiSquared},this.maximumRadius=function(){return m_maximumRadius},this.minimumRadius=function(){return m_minimumRadius},this.computeGeodeticSurfaceNormal=function(lat,lon){if("undefined"==typeof lat||"undefined"==typeof lon)throw"[error] Valid latitude and longitude is required";var cosLatitude=Math.cos(lat),result=vec3.create();return result[0]=cosLatitude*Math.cos(lon),result[1]=cosLatitude*Math.sin(lon),result[2]=Math.sin(lat),vec3.normalize(result,result),result},this.transformPoint=function(lat,lon,elev){lat*=Math.PI/180,lon*=Math.PI/180;var n=m_this.computeGeodeticSurfaceNormal(lat,lon),k=vec3.create(),gamma=Math.sqrt(vec3.dot(n,k)),result=vec3.create();return vec3.multiply(k,m_radiiSquared,n),vec3.scale(k,k,1/gamma),vec3.scale(n,n,elev),vec3.add(result,n,k),result},this.transformGeometry=function(geom){if(!geom)throw"[error] Failed to transform to cartesian. Invalid geometry.";var sourceData=geom.sourceData(vgl.vertexAttributeKeys.Position),sourceDataArray=sourceData.data(),noOfComponents=sourceData.attributeNumberOfComponents(vgl.vertexAttributeKeys.Position),stride=sourceData.attributeStride(vgl.vertexAttributeKeys.Position),offset=sourceData.attributeOffset(vgl.vertexAttributeKeys.Position),sizeOfDataType=sourceData.sizeOfAttributeDataType(vgl.vertexAttributeKeys.Position),index=null,count=sourceDataArray.length*(1/noOfComponents),gamma=null,n=null,j=0,k=vec3.create(),result=vec3.create();if(stride/=sizeOfDataType,offset/=sizeOfDataType,3!==noOfComponents)throw"[error] Requires positions with three components";for(j=0;count>j;j+=1)index=j*stride+offset,sourceDataArray[index]=sourceDataArray[index]*(Math.PI/180),sourceDataArray[index+1]=sourceDataArray[index+1]*(Math.PI/180),n=m_this.computeGeodeticSurfaceNormal(sourceDataArray[index+1],sourceDataArray[index]),vec3.multiply(k,m_radiiSquared,n),gamma=Math.sqrt(vec3.dot(n,k)),vec3.scale(k,k,1/gamma),vec3.scale(n,n,sourceDataArray[index+2]),vec3.add(result,n,k),sourceDataArray[index]=result[0],sourceDataArray[index+1]=result[1],sourceDataArray[index+2]=result[2]},m_this},geo.ellipsoid.WGS84=vgl.freezeObject(geo.ellipsoid(6378137,6378137,6356752.314245179)),geo.ellipsoid.UNIT_SPHERE=vgl.freezeObject(geo.ellipsoid(1,1,1)),geo.mercator={r_major:6378137},geo.mercator.r_minor=function(spherical){"use strict";var r_minor;return spherical=void 0!==spherical?spherical:!1,r_minor=spherical?6378137:6356752.314245179},geo.mercator.f=function(spherical){"use strict";return(geo.mercator.r_major-geo.mercator.r_minor(spherical))/geo.mercator.r_major},geo.mercator.long2tilex=function(lon,z){"use strict";var rad=(lon+180)/360,f=Math.floor(rad*Math.pow(2,z));return f},geo.mercator.lat2tiley=function(lat,z){"use strict";var rad=lat*Math.PI/180;return Math.floor((1-rad/Math.PI)/2*Math.pow(2,z))},geo.mercator.long2tilex2=function(lon,z){"use strict";var rad=(lon+180)/360,f=rad*Math.pow(2,z),ret=Math.floor(f),frac=f-ret;return[ret,frac]},geo.mercator.lat2tiley2=function(lat,z){"use strict";var rad=lat*Math.PI/180,f=(1-Math.log(Math.tan(rad)+1/Math.cos(rad))/Math.PI)/2*Math.pow(2,z),ret=Math.floor(f),frac=f-ret;return[ret,frac]},geo.mercator.tilex2long=function(x,z){"use strict";return x/Math.pow(2,z)*360-180},geo.mercator.tiley2lat=function(y,z){"use strict";var n=Math.PI-2*Math.PI*y/Math.pow(2,z);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},geo.mercator.y2lat=function(a){"use strict";return 180/Math.PI*(2*Math.atan(Math.exp(a*Math.PI/180))-Math.PI/2)},geo.mercator.lat2y=function(a){"use strict";return 180/Math.PI*Math.log(Math.tan(Math.PI/4+a*(Math.PI/180)/2))},geo.mercator.deg2rad=function(d){"use strict";var r=d*(Math.PI/180);return r},geo.mercator.rad2deg=function(r){"use strict";var d=r/(Math.PI/180);return d},geo.mercator.ll2m=function(lon,lat,spherical){"use strict";lat>89.5&&(lat=89.5),-89.5>lat&&(lat=-89.5);var x=this.r_major*this.deg2rad(lon),temp=this.r_minor(spherical)/this.r_major,es=1-temp*temp,eccent=Math.sqrt(es),phi=this.deg2rad(lat),sinphi=Math.sin(phi),con=eccent*sinphi,com=.5*eccent,con2=Math.pow((1-con)/(1+con),com),ts=Math.tan(.5*(.5*Math.PI-phi))/con2,y=-this.r_major*Math.log(ts),ret={x:x,y:y};return ret},geo.mercator.m2ll=function(x,y,spherical){"use strict";var lon=this.rad2deg(x/this.r_major),temp=this.r_minor(spherical)/this.r_major,e=Math.sqrt(1-temp*temp),lat=this.rad2deg(this.pjPhi2(Math.exp(-(y/this.r_major)),e)),ret={lon:lon,lat:lat};return ret},geo.mercator.pjPhi2=function(ts,e){"use strict";var con,dphi,N_ITER=15,HALFPI=Math.PI/2,TOL=1e-10,i=N_ITER,eccnth=.5*e,Phi=HALFPI-2*Math.atan(ts);do con=e*Math.sin(Phi),dphi=HALFPI-2*Math.atan(ts*Math.pow((1-con)/(1+con),eccnth))-Phi,Phi+=dphi,i-=1;while(Math.abs(dphi)>TOL&&i);return Phi},geo.latlng=function(arg1,arg2){"use strict";if(!(this instanceof geo.latlng))return new geo.latlng(arg1,arg2);var m_this=this,m_lat=void 0===arg2?arg1.lat():arg1,m_lng=void 0===arg2?arg1.lng():arg2;return this.lat=function(val){return void 0===val?m_lat:void(m_lat=val)},this.lng=function(val){return void 0===val?m_lng:void(m_lng=val)},this.x=function(val){return void 0===val?m_this.lng():void(m_lng=val)},this.y=function(val){return void 0===val?m_this.lat():void(m_lat=val)},this},geo.layerOptions=function(){"use strict";return this instanceof geo.layerOptions?(this.opacity=.5,this.showAttribution=!0,this.visible=!0,this.binNumber=vgl.material.RenderBin.Default,this):new geo.layerOptions},geo.newLayerId=function(){"use strict";var currentId=1;return function(){var id=currentId;return currentId+=1,id}}(),geo.layer=function(arg){"use strict";if(!(this instanceof geo.layer))return new geo.layer(arg);arg=arg||{},geo.sceneObject.call(this,arg);var m_this=this,m_style=void 0===arg.style?{opacity:.5,color:[.8,.8,.8],visible:!0,bin:100}:arg.style,m_id=void 0===arg.id?geo.newLayerId():arg.id,m_name="",m_gcs="EPSG:4326",m_timeRange=null,m_source=arg.source||null,m_map=void 0===arg.map?null:arg.map,m_isReference=!1,m_x=0,m_y=0,m_width=0,m_height=0,m_node=null,m_canvas=null,m_renderer=null,m_initialized=!1,m_rendererName=void 0===arg.renderer?"vglRenderer":arg.renderer,m_dataTime=geo.timestamp(),m_updateTime=geo.timestamp(),m_drawTime=geo.timestamp(),m_sticky=void 0===arg.sticky?!0:arg.sticky;return this.sticky=function(){return m_sticky},this.node=function(){return m_node},this.id=function(val){return void 0===val?m_id:(m_id=geo.newLayerId(),m_this.modified(),m_this)},this.name=function(val){return void 0===val?m_name:(m_name=val,m_this.modified(),m_this)},this.opacity=function(val){return void 0===val?m_style.opacity:(m_style.opacity=val,m_this.modified(),m_this)},this.visible=function(val){return void 0===val?m_style.visible:(m_style.visible=val,m_this.modified(),m_this)},this.bin=function(val){return void 0===val?m_style.bin:(m_style.bin=val,m_this.modified(),m_this)},this.gcs=function(val){return void 0===val?m_gcs:(m_gcs=val,m_this.modified(),m_this)},this.transform=function(val){return geo.transform.transformLayer(val,m_this,m_map.baseLayer()),m_this},this.timeRange=function(val){return void 0===val?m_timeRange:(m_timeRange=val,m_this.modified(),m_this)},this.source=function(val){return void 0===val?m_source:(m_source=val,m_this.modified(),m_this)},this.map=function(val){return void 0===val?m_map:(m_map=val,m_map.node().append(m_node),m_this.modified(),m_this)},this.renderer=function(){return m_renderer},this.canvas=function(){return m_canvas},this.viewport=function(){return[m_x,m_y,m_width,m_height]},this.dataTime=function(){return m_dataTime},this.updateTime=function(){return m_updateTime},this.drawTime=function(){return m_drawTime},this.query=function(){},this.referenceLayer=function(val){return void 0!==val?(m_isReference=val,m_this.modified(),m_this):m_isReference},this.initialized=function(val){return void 0!==val?(m_initialized=val,m_this):m_initialized},this.toLocal=function(input){return input},this.fromLocal=function(input){return input},this._init=function(){return m_initialized?m_this:(m_node=$(document.createElement("div")),m_node.attr("id",m_name),m_node.css("position","absolute"),m_map&&m_map.node().append(m_node),m_canvas?m_renderer=geo.createRenderer(m_rendererName,m_this,m_canvas):(m_renderer=geo.createRenderer(m_rendererName,m_this),m_canvas=m_renderer.canvas()),m_this.addChild(m_renderer),m_initialized=!0,m_this)},this._exit=function(){},this._update=function(){},this._resize=function(x,y,w,h){return m_x=x,m_y=y,m_width=w,m_height=h,m_node.width(w),m_node.height(h),m_this.modified(),m_this.trigger(geo.event.resize,{x:x,y:y,width:m_width,height:m_height}),m_this},this.width=function(){return m_width},this.height=function(){return m_height},this},inherit(geo.layer,geo.sceneObject),geo.featureLayer=function(arg){"use strict";if(!(this instanceof geo.featureLayer))return new geo.featureLayer(arg);geo.layer.call(this,arg);var m_this=this,m_features=[],s_init=this._init,s_update=this._update,s_draw=this.draw;return this.createFeature=function(featureName,arg){var newFeature=geo.createFeature(featureName,m_this,m_this.renderer(),arg);return m_this.addChild(newFeature),m_features.push(newFeature),m_this.features(m_features),m_this.modified(),newFeature},this.deleteFeature=function(feature){var i;for(i=0;i<m_features.length;i+=1)if(m_features[i]===feature)return m_features[i]._exit(),m_this.dataTime().modified(),m_this.modified(),m_features.splice(i,1),m_this;return m_this.removeChild(feature),m_this},this.features=function(val){return void 0===val?m_features:(m_features=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(){return m_this.initialized()?m_this:(s_init.call(m_this),m_this.on(geo.event.resize,function(event){m_this.renderer()._resize(event.x,event.y,event.width,event.height),m_this._update({}),m_this.renderer()._render()}),m_this.on(geo.event.pan,function(event){m_this._update({event:event}),m_this.renderer()._render()}),m_this.on(geo.event.zoom,function(event){m_this.map()&&m_this.map().zoom(event.curr_zoom),m_this._update({event:event}),m_this.renderer()._render()}),m_this)},this._update=function(request){var i;if(!m_features.length)return m_this;if(s_update.call(m_this,request),!m_this.source()&&m_features&&0===m_features.length)return void console.log("[info] No valid data source found.");if(m_this.dataTime().getMTime()>m_this.updateTime().getMTime())for(i=0;i<m_features.length;i+=1)m_features[i].renderer(m_this.renderer());for(i=0;i<m_features.length;i+=1)m_features[i]._update();return m_this.updateTime().modified(),m_this},this.draw=function(){return s_draw(),m_this.renderer()._render(),m_this},this.clear=function(){var i;if(!m_features.length)return m_this;for(i=0;i<m_features.length;i+=1)m_features[i]._exit();return m_this.dataTime().modified(),m_this.modified(),m_features=[],m_this},m_this},inherit(geo.featureLayer,geo.layer),geo.registerLayer("feature",geo.featureLayer),geo.event=function(){"use strict";return this instanceof geo.event?(vgl.event.call(this),this):new geo.event},inherit(geo.event,vgl.event),geo.event.update="geo.update",geo.event.opacityUpdate="geo.opacityUpdate",geo.event.layerAdd="geo.layerAdd",geo.event.layerRemove="geo.layerRemove",geo.event.layerToggle="geo.layerToggle",geo.event.layerSelect="geo.layerSelect",geo.event.layerUnselect="geo.layerUnselect",geo.event.zoom="geo.zoom",geo.event.center="geo.center",geo.event.pan="geo.pan",geo.event.rotate="geo.rotate",geo.event.resize="geo.resize",geo.event.animate="geo.animate",geo.event.query="geo.query",geo.event.draw="geo.draw",geo.event.drawEnd="geo.drawEnd",geo.event.animationPause="geo.animationPause",geo.event.animationStop="geo.animationStop",geo.event.animationComplete="geo.animationComplete",geo.time={},geo.time.incrementTime=function(time,unit,delta){"use strict";return"days"===unit?time.setDate(time.getDate()+delta):"months"===unit?time.setMonth(time.getMonth()+delta):"years"===unit?time.setYear(time.getYear()+delta):"index"===unit&&(time+=delta),time},geo.fileReader=function(arg){"use strict";function newFileReader(done,progress){var reader=new FileReader;return progress&&(reader.onprogress=progress),reader.onloadend=function(){reader.result||done(reader.error),done(reader.result)},reader}if(!(this instanceof geo.fileReader))return new geo.fileReader(arg);if(geo.object.call(this),arg=arg||{},!(arg.layer instanceof geo.featureLayer))throw"fileReader must be given a feature layer";var m_layer=arg.layer;return this.layer=function(){return m_layer},this.canRead=function(){return!1},this.read=function(file,done){done(!1)},this._getString=function(file,done,progress){var reader=newFileReader(done,progress);reader.readAsText(file)},this._getArrayBuffer=function(file,done,progress){var reader=newFileReader(done,progress);reader.readAsText(file)},this},inherit(geo.fileReader,geo.object),geo.jsonReader=function(arg){"use strict";if(!(this instanceof geo.jsonReader))return new geo.jsonReader(arg);var m_this=this,m_style=arg.style||{};geo.fileReader.call(this,arg),this.canRead=function(file){if(file instanceof File)return"application/json"===file.type||file.name.match(/\.json$/);if("string"==typeof file){try{JSON.parse(file)}catch(e){return!1}return!0}try{if(Array.isArray(m_this._featureArray(file)))return!0}catch(e){}return!1},this._readObject=function(file,done,progress){function onDone(fileString){"string"!=typeof fileString&&done(!1);try{object=JSON.parse(fileString)}catch(e){done(!1)}done(object)}var object;file instanceof File?m_this._getString(file,onDone,progress):"string"==typeof file?onDone(file):done(file)},this._featureArray=function(spec){if("FeatureCollection"===spec.type)return spec.features||[];if("GeometryCollection"===spec.type)throw"GeometryCollection not yet implemented.";if(Array.isArray(spec.coordinates))return spec;throw"Unsupported collection type: "+spec.type},this._featureType=function(spec){var geometry=spec.geometry||{};return"Point"===geometry.type||"MultiPoint"===geometry.type?"point":"LineString"===geometry.type?"line":null},this._getCoordinates=function(spec){var geometry=spec.geometry||{},coordinates=geometry.coordinates||[];return(2===coordinates.length||3===coordinates.length)&&isFinite(coordinates[0])&&isFinite(coordinates[1])?[geo.latlng(coordinates[1],coordinates[0])]:coordinates.map(function(c){return geo.latlng(c[1],c[0])})},this._getStyle=function(spec){return spec.properties||{}},this.read=function(file,done,progress){function _done(object){var features,allFeatures=[];features=m_this._featureArray(object),features.forEach(function(feature){var type=m_this._featureType(feature),coordinates=m_this._getCoordinates(feature),style=m_this._getStyle(feature);type?allFeatures.push(m_this._addFeature(type,coordinates,style)):console.log("unsupported feature type: "+feature.geometry.type)}),done&&done(allFeatures)}m_this._readObject(file,_done,progress)},this._addFeature=function(type,coordinates,style){var _style=$.extend({},m_style,style);return m_this.layer().createFeature(type).positions(coordinates).style(_style)}},inherit(geo.jsonReader,geo.fileReader),geo.registerFileReader("jsonReader",geo.jsonReader),geo.map=function(arg){"use strict";if(!(this instanceof geo.map))return new geo.map(arg);arg=arg||{},geo.sceneObject.call(this,arg),arg.layers=void 0===arg.layers?[]:arg.layers;var toMillis,calculateGlobalAnimationRange,cloneTimestep,m_pause,m_stop,m_this=this,m_x=0,m_y=0,m_node=$(arg.node),m_width=arg.width||m_node.width(),m_height=arg.height||m_node.height(),m_gcs=void 0===arg.gcs?"EPSG:4326":arg.gcs,m_uigcs=void 0===arg.uigcs?"EPSG:4326":arg.uigcs,m_center=void 0===arg.center?[0,0]:arg.center,m_zoom=void 0===arg.zoom?10:arg.zoom,m_baseLayer=null,m_animationState={range:null,timestep:null,layers:null},m_intervalMap={},m_fileReader=null;return m_intervalMap.milliseconds=1,m_intervalMap.seconds=1e3*m_intervalMap.milliseconds,m_intervalMap.minutes=60*m_intervalMap.seconds,m_intervalMap.hours=60*m_intervalMap.minutes,m_intervalMap.days=24*m_intervalMap.hours,m_intervalMap.weeks=7*m_intervalMap.days,m_intervalMap.months=4*m_intervalMap.weeks,m_intervalMap.years=12*m_intervalMap.months,this.on(geo.event.animationPause,function(){m_pause=!0}),this.on(geo.event.animationStop,function(){m_stop=!0}),toMillis=function(delta){var deltaLowercase=delta.toLowerCase();return m_intervalMap[deltaLowercase]},calculateGlobalAnimationRange=function(layers){var delta,deltaUnits,layerTimeRange,layerDelta,i,start=null,end=null,indexTimestep=!1,smallestDeltaInMillis=Number.MAX_VALUE;for(i=0;i<layers.length;i+=1)if(layerTimeRange=layers[i].timeRange()){if("index"===layerTimeRange.deltaUnits)indexTimestep=!0,layerDelta=layerTimeRange.delta;else{if(indexTimestep)throw"Can't mix index timesteps with time based timesteps";layerDelta=toMillis(layerTimeRange.deltaUnits)*layerTimeRange.delta}smallestDeltaInMillis>layerDelta&&(delta=layerTimeRange.delta,deltaUnits=layerTimeRange.deltaUnits,smallestDeltaInMillis=layerDelta),(null===start||layerTimeRange.start<start)&&(start=layerTimeRange.start),(null===end||layerTimeRange.end<end)&&(end=layerTimeRange.end)}return{start:start,end:end,delta:delta,deltaUnits:deltaUnits}},cloneTimestep=function(timestep){return timestep instanceof Date&&(timestep=new Date(timestep.getTime())),timestep},this.gcs=function(arg){return void 0===arg?m_gcs:(m_gcs=arg,m_this)},this.uigcs=function(){return m_uigcs},this.node=function(){return m_node},this.zoom=function(val){return void 0===val?m_zoom:(val!==m_zoom&&(m_zoom=val,m_this.modified()),m_this)},this.center=function(val){return void 0===val?m_center:(m_center=val.slice,m_this.modified(),m_this)},this.createLayer=function(layerName,arg){var newLayer=geo.createLayer(layerName,m_this,arg);return null===newLayer&&void 0===newLayer?null:(newLayer._resize(m_x,m_y,m_width,m_height),(newLayer.referenceLayer()||0===m_this.children().length)&&m_this.baseLayer(newLayer),m_this.addChild(newLayer),m_this.modified(),m_this.trigger(geo.event.layerAdd,{type:geo.event.layerAdd,target:m_this,layer:newLayer}),newLayer)},this.deleteLayer=function(layer){return null!==layer&&void 0!==layer&&(layer._exit(),m_this.removeChild(layer),m_this.modified(),m_this.trigger(geo.event.layerRemove,{type:geo.event.layerRemove,target:m_this,layer:layer})),layer},this.toggle=function(layer){return null!==layer&&void 0!==layer&&(layer.visible(!layer.visible()),m_this.modified(),m_this.trigger(geo.event.layerToggle,{type:geo.event.layerToggle,target:m_this,layer:layer})),m_this},this.resize=function(x,y,w,h){var i,layers=m_this.children();for(m_x=x,m_y=y,m_width=w,m_height=h,i=0;i<layers.length;i+=1)layers[i]._resize(x,y,w,h);return m_this.trigger(geo.event.resize,{type:geo.event.resize,target:m_this,x:m_x,y:m_y,width:w,height:h}),m_this.modified(),m_this},this.gcsToDisplay=function(input){var world,output;if(!(input instanceof Array&&input.length>0||input instanceof Object))throw"Conversion method latLonToDisplay does not handle "+input;return world=m_baseLayer.toLocal(input),output=m_baseLayer.renderer().worldToDisplay(world)},this.displayToGcs=function(input){var output;if(!(input instanceof Array&&input.length>0||input instanceof Object))throw"Conversion method latLonToDisplay does not handle "+input;return output=m_baseLayer.renderer().displayToWorld(input),output=m_baseLayer.fromLocal(output)},this.query=function(){},this.baseLayer=function(baseLayer){return void 0!==baseLayer?(m_gcs!==baseLayer.gcs()&&m_this.gcs(baseLayer.gcs()),m_baseLayer=baseLayer,m_baseLayer.referenceLayer(!0),m_this):m_baseLayer},this.draw=function(){var i,layers=m_this.children();for(m_this.trigger(geo.event.draw,{type:geo.event.draw,target:m_this}),m_this._update(),i=0;i<layers.length;i+=1)layers[i].draw();return m_this.trigger(geo.event.drawEnd,{type:geo.event.drawEnd,target:m_this}),m_this},this.animate=function(layers){var animationRange;if(layers=void 0===layers?m_this.children():layers,null===m_animationState.timestep){if(animationRange=calculateGlobalAnimationRange(layers),!animationRange.start||!animationRange.end)throw"Animation range could not be calculated. Check that layers have ranges associated with them";m_animationState={range:animationRange,timestep:cloneTimestep(animationRange.start),layers:layers}}return m_this._animate(),m_this},this.pauseAnimation=function(){return m_this.trigger(geo.event.animationPause),m_this},this.stopAnimation=function(){return m_this.trigger(geo.event.animationStop),m_animationState.timestep=null,m_this},this.stepAnimationForward=function(layers){var animationRange;return layers=void 0===layers?m_animationState.layers:layers,null===layers&&(layers=m_this.children()),null===m_animationState.timestep&&(animationRange=calculateGlobalAnimationRange(layers),m_animationState={range:animationRange,timestep:cloneTimestep(animationRange.start),layers:layers}),m_this._stepAnimationForward(),m_this},this.stepAnimationBackward=function(layers){var animationRange;return layers=void 0===layers?m_animationState.layers:layers,null===layers&&(layers=m_this.children()),null===m_animationState.timestep&&(animationRange=calculateGlobalAnimationRange(layers),m_animationState={range:animationRange,timestep:cloneTimestep(animationRange.end),layers:layers}),m_this._stepAnimationBackward(),m_this},this._animate=function(){function renderTimestep(){m_animationState.timestep>animationRange.end||m_stop?(clearInterval(id),m_animationState.timestep=null,m_this.trigger(geo.event.animationComplete)):m_pause?clearInterval(id):(m_this._animateTimestep(),m_animationState.timestep=geo.time.incrementTime(m_animationState.timestep,m_animationState.range.deltaUnits,m_animationState.range.delta))}var animationRange,nextTimestep,id;if(animationRange=m_animationState.range,nextTimestep=cloneTimestep(animationRange.start),m_stop=!1,m_pause=!1,nextTimestep=geo.time.incrementTime(nextTimestep,animationRange.deltaUnits,animationRange.delta),nextTimestep>animationRange.end)throw"Invalid time range";return id=setInterval(renderTimestep,10),m_this},this._animateTimestep=function(){return m_animationState&&($.each(m_animationState.layers,function(i,layer){var timestep=m_animationState.timestep;timestep instanceof Date&&(timestep=timestep.getTime()),layer._update({timestep:timestep})}),m_this.trigger(geo.event.animate,{timestep:m_animationState.timestep}),m_this.draw()),m_this},this._stepAnimationForward=function(){var nextTimestep;return null===m_animationState.timestep&&(m_animationState.timestep=cloneTimestep(m_animationState.range.start)),nextTimestep=cloneTimestep(m_animationState.timestep),nextTimestep=geo.time.incrementTime(nextTimestep,m_animationState.range.deltaUnits,m_animationState.range.delta),nextTimestep<=m_animationState.range.end&&(m_animationState.timestep=nextTimestep,m_this._animateTimestep()),m_this},this._stepAnimationBackward=function(){var previousTimestep;return null===m_animationState.timestep&&(m_animationState.timestep=cloneTimestep(m_animationState.range.end)),previousTimestep=cloneTimestep(m_animationState.timestep),previousTimestep=geo.time.incrementTime(previousTimestep,m_animationState.range.deltaUnits,-m_animationState.range.delta),previousTimestep<m_animationState.range.start?void 0:(m_animationState.timestep=previousTimestep,m_this._animateTimestep(),m_this)},this.fileReader=function(readerType,opts){var layer,renderer;return opts=opts||{},readerType?(layer=opts.layer,layer||(renderer=opts.renderer,renderer||(renderer="d3Renderer"),layer=m_this.createLayer("feature",{renderer:renderer})),opts.layer=layer,opts.renderer=renderer,m_fileReader=geo.createFileReader(readerType,opts),m_this):m_fileReader},this._init=function(arg){var i;if(void 0===m_node||null===m_node)throw"Map require DIV node";if(void 0!==arg&&void 0!==arg.layers)for(i=0;i<arg.layers.length;i+=1)0===i&&m_this.baseLayer(arg.layers[i]),m_this.addLayer(arg.layers[i]);return m_this},this._update=function(request){var i,layers=m_this.children();for(i=0;i<layers.length;i+=1)layers[i]._update(request);return m_this},this._exit=function(){var i,layers=m_this.children();for(i=0;i<layers.length;i+=1)layers[i]._exit()},this._init(arg),this.node().on("dragover",function(e){var evt=e.originalEvent;m_this.fileReader()&&(evt.stopPropagation(),evt.preventDefault(),evt.dataTransfer.dropEffect="copy")}).on("drop",function(e){function done(){m_this.draw()}var i,file,evt=e.originalEvent,reader=m_this.fileReader();if(reader)for(evt.stopPropagation(),evt.preventDefault(),i=0;i<evt.dataTransfer.files.length;i+=1)file=evt.dataTransfer.files[i],reader.canRead(file)&&reader.read(file,done)}),this},inherit(geo.map,geo.sceneObject),geo.feature=function(arg){"use strict";if(!(this instanceof geo.feature))return new geo.feature(arg);geo.sceneObject.call(this),arg=arg||{};var m_this=this,m_style={},m_layer=void 0===arg.layer?null:arg.layer,m_gcs=void 0===arg.gcs?"EPSG:4326":arg.gcs,m_visible=void 0===arg.visible?!0:arg.visible,m_bin=void 0===arg.bin?0:arg.bin,m_renderer=void 0===arg.renderer?null:arg.renderer,m_dataTime=geo.timestamp(),m_buildTime=geo.timestamp(),m_updateTime=geo.timestamp();return this.style=function(arg1,arg2){return void 0===arg1?m_style:void 0===arg2?(m_style=$.extend({},m_style,arg1),m_this.modified(),m_this):(m_style[arg1]=arg2,m_this.modified(),m_this)},this.layer=function(){return m_layer},this.renderer=function(){return m_renderer},this.drawables=function(){return m_this._drawables()},this.gcs=function(val){return void 0===val?m_gcs:(m_gcs=val,m_this.modified(),m_this)},this.visible=function(val){return void 0===val?m_visible:(m_visible=val,m_this.modified(),m_this)},this.bin=function(val){return void 0===val?m_bin:(m_bin=val,m_this.modified(),m_this)},this.dataTime=function(val){return void 0===val?m_dataTime:(m_dataTime=val,m_this.modified(),m_this)},this.buildTime=function(val){return void 0===val?m_buildTime:(m_buildTime=val,m_this.modified(),m_this)},this.updateTime=function(val){return void 0===val?m_updateTime:(m_updateTime=val,m_this.modified(),m_this)},this._init=function(arg){if(!m_layer)throw"Feature requires a valid layer";m_style=$.extend({},{opacity:1},void 0===arg.style?{}:arg.style)},this._build=function(){},this._drawables=function(){},this._update=function(){},this._exit=function(){},this._init(arg),this},inherit(geo.feature,geo.sceneObject),geo.pointFeature=function(arg){"use strict";if(!(this instanceof geo.pointFeature))return new geo.pointFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,m_positions=void 0===arg.positions?null:arg.positions,s_init=this._init;
return this.positions=function(val){return void 0===val?m_positions:(m_positions=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{size:1,width:1,height:1,color:[1,1,1],point_sprites:!1,point_sprites_image:null},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_positions&&m_this.dataTime().modified()},m_this._init(arg),m_this},inherit(geo.pointFeature,geo.feature),geo.lineFeature=function(arg){"use strict";if(!(this instanceof geo.lineFeature))return new geo.lineFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,m_positions=void 0===arg.positions?[]:arg.positions,s_init=this._init;return this.positions=function(val){return void 0===val?m_positions:(m_positions=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_positions&&m_this.dataTime().modified()},this._init(arg),this},inherit(geo.lineFeature,geo.feature),geo.pathFeature=function(arg){"use strict";if(!(this instanceof geo.pathFeature))return new geo.pathFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,m_positions=void 0===arg.positions?[]:arg.positions,s_init=this._init;return this.positions=function(val){return void 0===val?m_positions:(m_positions=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_positions&&m_this.dataTime().modified()},this._init(arg),this},inherit(geo.pathFeature,geo.feature),geo.polygonFeature=function(arg){"use strict";if(!(this instanceof geo.polygonFeature))return new geo.polygonFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_init=this._init;return this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{color:[1,1,1],fill_color:[1,1,1],fill:!0},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle)},m_this._init(arg),m_this},inherit(geo.polygonFeature,geo.feature),geo.planeFeature=function(arg){"use strict";if(!(this instanceof geo.planeFeature))return new geo.planeFeature(arg);arg=arg||{},arg.ul=void 0===arg.ul?[0,1,0]:arg.ul,arg.lr=void 0===arg.lr?[1,0,0]:arg.lr,arg.depth=void 0===arg.depth?0:arg.depth,geo.polygonFeature.call(this,arg);var m_this=this,m_origin=[arg.ul.x,arg.lr.y,arg.depth],m_upperLeft=[arg.ul.x,arg.ul.y,arg.depth],m_lowerRight=[arg.lr.x,arg.lr.y,arg.depth],m_defaultDepth=arg.depth,m_drawOnAsyncResourceLoad=void 0===arg.drawOnAsyncResourceLoad?!0:!1,s_init=this._init;return this.origin=function(val){if(void 0===val)return m_origin;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_origin=val.slice(0),2===m_origin.length&&(m_origin[2]=m_defaultDepth)}else val instanceof geo.latlng&&(m_origin=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.upperLeft=function(val){if(void 0===val)return m_upperLeft;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_upperLeft=val.slice(0),2===m_upperLeft.length&&(m_upperLeft[2]=m_defaultDepth)}else val instanceof geo.latlng&&(m_upperLeft=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.lowerRight=function(val){if(void 0===val)return m_lowerRight;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_lowerRight=val.slice(0),2===m_lowerRight.length&&(m_lowerRight[2]=m_defaultDepth),m_this.dataTime().modified()}else val instanceof geo.latlng&&(m_lowerRight=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.drawOnAsyncResourceLoad=function(val){return void 0===val?m_drawOnAsyncResourceLoad:(m_drawOnAsyncResourceLoad=val,m_this)},this._init=function(arg){var style=null;s_init.call(m_this,arg),style=m_this.style(),void 0===style.image&&(style.image=null),m_this.style(style)},this._init(arg),this},inherit(geo.planeFeature,geo.polygonFeature),geo.geomFeature=function(arg){"use strict";return this instanceof geo.geomFeature?(arg=arg||{},geo.feature.call(this,arg),arg.style=void 0===arg.style?$.extend({},{color:[1,1,1],point_sprites:!1,point_sprites_image:null},arg.style):arg.style,this.style(arg.style),this):new geo.geomFeature(arg)},inherit(geo.geomFeature,geo.feature),geo.graphFeature=function(arg){"use strict";if(!(this instanceof geo.graphFeature))return new geo.graphFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_style=this.style,m_nodes=null,m_points=null,m_links=[],s_init=this._init,s_exit=this._exit;return this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend(!0,{},{nodes:{size:5,color:[0,0,1]},links:{color:[1,1,1]},linkType:"path"},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_nodes&&m_this.dataTime().modified()},this._build=function(){m_this.children().forEach(function(child){child._build()})},this._update=function(){m_this.children().forEach(function(child){child._update()})},this._exit=function(){return m_this.nodes([]),m_points._exit(),m_this.removeChild(m_points),s_exit(),m_this},this.style=function(arg){var out=s_style.call(m_this,arg);return out!==m_this?out:(m_points.style(arg.nodes),m_links.forEach(function(l){l.style(arg.links)}),m_this)},this.nodes=function(val){var style,layer=m_this.layer(),nLinks=0;return void 0===val?m_nodes:(style=m_this.style(),m_nodes=val.slice(0),m_points.positions(m_nodes),m_nodes.forEach(function(source){(source.children||[]).forEach(function(target){var link;nLinks+=1,m_links.length<nLinks&&(link=geo.createFeature(style.linkType,layer,layer.renderer()).style(style.links),m_this.addChild(link),m_links.push(link)),m_links[nLinks-1].positions([source,target])})}),m_links.splice(nLinks,m_links.length-nLinks).forEach(function(l){l._exit(),m_this.removeChild(l)}),m_this.dataTime().modified(),m_this.modified(),m_this)},this.nodeFeature=function(){return m_points},this.linkFeatures=function(){return m_links},m_points=geo.createFeature("point",this.layer(),this.layer().renderer()),m_this.addChild(m_points),arg.nodes&&this.nodes(arg.nodes),this._init(arg),this},inherit(geo.graphFeature,geo.feature),geo.transform={},geo.transform.osmTransformFeature=function(destGcs,feature,inplace){"use strict";if(!feature)return void console.log("[warning] Invalid (null) feature");if(feature.gcs()!==destGcs){if(!(feature instanceof geo.pointFeature||feature instanceof geo.lineFeature))throw"Supports only point or line feature";var i,yCoord,noOfComponents=null,pointOffset=0,count=null,inPos=null,outPos=null,srcGcs=feature.gcs();if(inplace=!!inplace,feature instanceof geo.pointFeature||feature instanceof geo.lineFeature){if("EPSG:4326"!==srcGcs&&geo.transform.transformFeature("EPSG:4326",feature,!0),inPos=feature.positions(),count=inPos.length,!(inPos instanceof Array))throw"Supports Array of 2D and 3D points";if(inPos.length>0&&inPos[0]instanceof geo.latlng?(noOfComponents=2,pointOffset=1):(noOfComponents=count%2===0?2:count%3===0?3:null,pointOffset=noOfComponents),2!==noOfComponents&&3!==noOfComponents)throw"Transform points require points in 2D or 3D";for(outPos=inplace?inPos:inPos.slice(0),i=0;count>i;i+=pointOffset)yCoord=inPos[i]instanceof geo.latlng?inPos[i].lat():inPos[i+1],yCoord>85.0511&&(yCoord=85.0511),-85.0511>yCoord&&(yCoord=-85.0511),inPos[i]instanceof geo.latlng?outPos[i]=geo.latlng(geo.mercator.lat2y(yCoord),outPos[i].lng()):outPos[i+1]=geo.mercator.lat2y(yCoord);return inplace&&(feature.positions(outPos),feature.gcs(destGcs)),outPos}return null}},geo.transform.transformFeature=function(destGcs,feature,inplace){"use strict";if(!feature)throw"Invalid (null) feature";if(!(feature instanceof geo.pointFeature||feature instanceof geo.lineFeature))throw"Supports only point or line feature";if(feature.gcs()===destGcs)return feature.positions();if("EPSG:3857"===destGcs)return geo.transform.osmTransformFeature(destGcs,feature,inplace);var i,noOfComponents=null,pointOffset=0,count=null,inPos=null,outPos=null,projPoint=null,srcGcs=feature.gcs(),projSrcGcs=new proj4.Proj(srcGcs),projDestGcs=new proj4.Proj(destGcs);if(inplace=!!inplace,feature instanceof geo.pointFeature||feature instanceof geo.lineFeature){if(inPos=feature.positions(),count=inPos.length,!(inPos instanceof Array))throw"Supports Array of 2D and 3D points";if(inPos.length>0&&inPos[0]instanceof geo.latlng?(noOfComponents=2,pointOffset=1):(noOfComponents=count%2===0?2:count%3===0?3:null,pointOffset=noOfComponents),2!==noOfComponents&&3!==noOfComponents)throw"Transform points require points in 2D or 3D";for(inplace?outPos=inPos:(outPos=[],outPos.length=inPos.length),i=0;count>i;i+=pointOffset)projPoint=2===noOfComponents?new proj4.Point(inPos[i],inPos[i+1],0):new proj4.Point(inPos[i],inPos[i+1],inPos[i+2]),proj4.transform(projSrcGcs,projDestGcs,projPoint),2===noOfComponents?(outPos[i]=projPoint.x,outPos[i+1]=projPoint.y):(outPos[i]=projPoint.x,outPos[i+1]=projPoint.y,outPos[i+2]=projPoint.z);return inplace&&(feature.positions(outPos),feature.gcs(destGcs)),outPos}return null},geo.transform.transformLayer=function(destGcs,layer,baseLayer){"use strict";var features,count,i;if(!layer)throw"Requires valid layer for tranformation";if(!baseLayer)throw"Requires baseLayer used by the map";if(layer!==baseLayer){if(!(layer instanceof geo.featureLayer))throw"Only feature layer transformation is supported";for(features=layer.features(),count=features.length,i=0,i=0;count>i;i+=1)"EPSG:3857"===destGcs&&baseLayer instanceof geo.osmLayer?geo.transform.osmTransformFeature(destGcs,features[i],!0):geo.transform.transformFeature(destGcs,features[i],!0);layer.gcs(destGcs)}},geo.transform.transformCoordinates=function(srcGcs,destGcs,coordinates,numberOfComponents){"use strict";function handleLatLngCoordinates(){coordinates[0]&&coordinates[0]instanceof geo.latlng?(xAcc=function(index){return coordinates[index].x()},yAcc=function(index){return coordinates[index].y()},writer=function(index,x,y){output[index]=geo.latlng(y,x)}):(xAcc=function(){return coordinates.x()},yAcc=function(){return coordinates.y()},writer=function(index,x,y){output=geo.latlng(y,x)})}function handleArrayCoordinates(){if(coordinates[0]instanceof Array)if(2===coordinates[0].length)xAcc=function(index){return coordinates[index][0]},yAcc=function(index){return coordinates[index][1]},writer=function(index,x,y){output[index]=[x,y]};else{if(3!==coordinates[0].length)throw"Invalid coordinates. Requires two or three components per array";xAcc=function(index){return coordinates[index][0]},yAcc=function(index){return coordinates[index][1]},zAcc=function(index){return coordinates[index][2]},writer=function(index,x,y,z){output[index]=[x,y,z]}}else if(2===coordinates.length)offset=2,xAcc=function(index){return coordinates[index*offset]},yAcc=function(index){return coordinates[index*offset+1]},writer=function(index,x,y){output[index]=x,output[index+1]=y};else if(3===coordinates.length)offset=3,xAcc=function(index){return coordinates[index*offset]},yAcc=function(index){return coordinates[index*offset+1]},zAcc=function(index){return coordinates[index*offset+2]},writer=function(index,x,y,z){output[index]=x,output[index+1]=y,output[index+2]=z};else{if(!numberOfComponents)throw"Invalid coordinates";offset=numberOfComponents,xAcc=function(index){return coordinates[index]},yAcc=function(index){return coordinates[index+1]},2===numberOfComponents?writer=function(index,x,y){output[index]=x,output[index+1]=y}:(zAcc=function(index){return coordinates[index+2]},writer=function(index,x,y,z){output[index]=x,output[index+1]=y,output[index+2]=z})}}function handleObjectCoordinates(){if(coordinates[0]&&"x"in coordinates[0]&&"y"in coordinates[0])xAcc=function(index){return coordinates[index].x},yAcc=function(index){return coordinates[index].y},"z"in coordinates[0]?(zAcc=function(index){return coordinates[index].z},writer=function(index,x,y,z){output[i]={x:x,y:y,z:z}}):writer=function(index,x,y){output[index]={x:x,y:y}};else{if(!(coordinates&&"x"in coordinates&&"y"in coordinates))throw"Invalid coordinates";xAcc=function(){return coordinates.x},yAcc=function(){return coordinates.y},"z"in coordinates?(zAcc=function(){return coordinates.z},writer=function(index,x,y,z){output={x:x,y:y,z:z}}):writer=function(index,x,y){output={x:x,y:y}}}}var i,count,offset,xCoord,yCoord,zCoord,xAcc,yAcc,zAcc,writer,output,projPoint,projSrcGcs=new proj4.Proj(srcGcs),projDestGcs=new proj4.Proj(destGcs);if(zAcc=function(){return 0},destGcs===srcGcs)return coordinates;if(!destGcs||!srcGcs)throw"Invalid source or destination GCS";if(coordinates instanceof Array)output=[],output.length=coordinates.length,count=coordinates.length,coordinates[0]instanceof Array||coordinates[0]instanceof geo.latlng||coordinates[0]instanceof Object?(offset=1,coordinates[0]instanceof Array?handleArrayCoordinates():coordinates[0]instanceof geo.latlng?handleLatLngCoordinates():coordinates[0]instanceof Object&&handleObjectCoordinates()):handleArrayCoordinates();else if(coordinates&&coordinates instanceof Object)if(count=1,offset=1,coordinates instanceof geo.latlng)handleLatLngCoordinates();else{if(!(coordinates&&"x"in coordinates&&"y"in coordinates))throw"Coordinates are not valid";handleObjectCoordinates()}if("EPSG:3857"===destGcs&&"EPSG:4326"===srcGcs){for(i=0;count>i;i+=offset)xCoord=xAcc(i),yCoord=yAcc(i),zCoord=zAcc(i),yCoord>85.0511&&(yCoord=85.0511),-85.0511>yCoord&&(yCoord=-85.0511),writer(i,xCoord,geo.mercator.lat2y(yCoord),zCoord);return output}for(i=0;count>i;i+=offset)return projPoint=new proj4.Point(xAcc(i),yAcc(i),zAcc(i)),proj4.transform(projSrcGcs,projDestGcs,projPoint),writer(i,projPoint.x,projPoint.y,projPoint.z),output},geo.renderer=function(arg){"use strict";if(!(this instanceof geo.renderer))return new geo.renderer(arg);geo.sceneObject.call(this),arg=arg||{};var m_this=this,m_layer=void 0===arg.layer?null:arg.layer,m_canvas=void 0===arg.canvas?null:arg.canvas,m_initialized=!1;return this.layer=function(){return m_layer},this.canvas=function(val){return void 0===val?m_canvas:(m_canvas=val,void m_this.modified())},this.map=function(){return m_layer?m_layer.map():null},this.baseLayer=function(){return m_this.map()?m_this.map().baseLayer():void 0},this.initialized=function(val){return void 0===val?m_initialized:(m_initialized=val,m_this)},this.api=function(){throw"Should be implemented by derivied classes"},this.reset=function(){return!0},this.worldToGcs=function(){throw"Should be implemented by derivied classes"},this.displayToGcs=function(){throw"Should be implemented by derivied classes"},this.gcsToDisplay=function(){throw"Should be implemented by derivied classes"},this.worldToDisplay=function(){throw"Should be implemented by derivied classes"},this.displayToWorld=function(){throw"Should be implemented by derivied classes"},this.relMouseCoords=function(event){var totalOffsetX=0,totalOffsetY=0,canvasX=0,canvasY=0,currentElement=m_this.canvas();do totalOffsetX+=currentElement.offsetLeft-currentElement.scrollLeft,totalOffsetY+=currentElement.offsetTop-currentElement.scrollTop,currentElement=currentElement.offsetParent;while(currentElement);return canvasX=event.pageX-totalOffsetX,canvasY=event.pageY-totalOffsetY,{x:canvasX,y:canvasY}},this._init=function(){},this._resize=function(){},this._render=function(){},this._exit=function(){},this._connectMouseEvents=function(){},this},inherit(geo.renderer,geo.sceneObject),geo.osmLayer=function(arg){"use strict";function getModifiedMapZoom(){return m_this.map().zoom()<18?m_this.map().zoom()+1:m_this.map().zoom()}function isTileVisible(tile){return tile.zoom in m_visibleTilesRange&&tile.index_x>=m_visibleTilesRange[tile.zoom].startX&&tile.index_x<=m_visibleTilesRange[tile.zoom].endX&&tile.index_y>=m_visibleTilesRange[tile.zoom].startY&&tile.index_y<=m_visibleTilesRange[tile.zoom].endY?!0:!1}function drawTiles(){m_this._removeTiles(),m_this.draw(),delete m_pendingNewTilesStat[m_updateTimerId]}function updateOSMTiles(request){void 0===request&&(request={});var zoom=getModifiedMapZoom();m_lastVisibleZoom||(m_lastVisibleZoom=zoom),m_this._addTiles(request),m_lastVisibleZoom!==zoom&&(m_lastVisibleZoom=zoom),m_this.updateTime().modified()}if(!(this instanceof geo.osmLayer))return new geo.osmLayer(arg);geo.featureLayer.call(this,arg);var m_this=this,m_tiles={},m_hiddenBinNumber=0,m_lastVisibleBinNumber=999,m_visibleBinNumber=1e3,m_pendingNewTiles=[],m_pendingInactiveTiles=[],m_numberOfCachedTiles=0,m_tileCacheSize=100,m_baseUrl="http://tile.openstreetmap.org/",m_imageFormat="png",m_updateTimerId=null,m_lastVisibleZoom=null,m_visibleTilesRange={},s_init=this._init,m_pendingNewTilesStat={},s_update=this._update,m_updateDefer=null;return arg&&void 0!==arg.baseUrl&&(m_baseUrl=arg.baseUrl),arg&&void 0!==arg.imageFormat&&(m_imageFormat=arg.imageFormat),this.tileCacheSize=function(val){return void 0===val?m_tileCacheSize:(m_tileCacheSize=val,void m_this.modified())},this.toLocal=function(input){var i,output,delta;if(input instanceof Array&&input.length>0)if(output=[],output.length=input.length,input[0]instanceof geo.latlng)for(i=0;i<input.length;i+=1)output[i]=geo.latlng(input[i]),output[i].lat(geo.mercator.lat2y(output[i].lat()));else if(input[0]instanceof Array)if(delta=input%3===0?3:2,2===delta)for(i=0;i<input.length;i+=delta)output[i]=input[i],output[i+1]=geo.mercator.lat2y(input[i+1]);else for(i=0;i<input.length;i+=delta)output[i]=input[i],output[i+1]=geo.mercator.lat2y(input[i+1]),output[i+2]=input[i+2];else input[0]instanceof Object&&"x"in input[0]&&"y"in input[0]&&"z"in input[0]?output[i]={x:input[i].x,y:geo.mercator.lat2y(input[i].y),z:input[i].z}:input[0]instanceof Object&&"x"in input[0]&&"y"in input[0]&&"z"in input[0]?output[i]={x:input[i].x,y:geo.mercator.lat2y(input[i].y)}:input.length>=2&&(output=input.slice(0),output[1]=geo.mercator.lat2y(input[1]));else input instanceof geo.latlng?(output={},output.x=input.x(),output.y=geo.mercator.lat2y(input.y())):(output={},output.x=input.x,output.y=geo.mercator.lat2y(input.y));return output},this.fromLocal=function(input){var i,output;if(input instanceof Array&&input.length>0)if(output=[],output.length=input.length,input[0]instanceof Object)for(i=0;i<input.length;i+=1)output[i]={},output[i].x=input[i].x,output[i].y=geo.mercator.y2lat(input[i].y);else if(input[0]instanceof Array)for(i=0;i<input.length;i+=1)output[i]=input[i],output[i][1]=geo.mercator.y2lat(input[i][1]);else for(i=0;i<input.length;i+=1)output[i]=input[i],output[i+1]=geo.mercator.y2lat(input[i+1]);else output={},output.x=input.x,output.y=geo.mercator.y2lat(input.y);return output},this._hasTile=function(zoom,x,y){return m_tiles[zoom]&&m_tiles[zoom][x]&&m_tiles[zoom][x][y]?!0:!1},this._addTile=function(request,zoom,x,y){if(m_tiles[zoom]||(m_tiles[zoom]={}),m_tiles[zoom][x]||(m_tiles[zoom][x]={}),!m_tiles[zoom][x][y]){var noOfTilesX=Math.max(1,Math.pow(2,zoom)),noOfTilesY=Math.max(1,Math.pow(2,zoom)),totalLatDegrees=360,lonPerTile=360/noOfTilesX,latPerTile=totalLatDegrees/noOfTilesY,llx=-180+x*lonPerTile,lly=.5*-totalLatDegrees+y*latPerTile,urx=-180+(x+1)*lonPerTile,ury=.5*-totalLatDegrees+(y+1)*latPerTile,tile=new Image;return tile.LOADING=!0,tile.LOADED=!1,tile.REMOVED=!1,tile.REMOVING=!1,tile.crossOrigin="anonymous",tile.zoom=zoom,tile.index_x=x,tile.index_y=y,tile.llx=llx,tile.lly=lly,tile.urx=urx,tile.ury=ury,tile.lastused=new Date,tile.src=m_baseUrl+zoom+"/"+x+"/"+(Math.pow(2,zoom)-1-y)+"."+m_imageFormat,m_tiles[zoom][x][y]=tile,m_pendingNewTiles.push(tile),m_numberOfCachedTiles+=1,tile}},this._removeTiles=function(){var i,x,y,tile,zoom,currZoom=getModifiedMapZoom(),lastZoom=m_lastVisibleZoom;if(!m_tiles)return m_this;for(zoom in m_tiles)for(x in m_tiles[zoom])for(y in m_tiles[zoom][x])tile=m_tiles[zoom][x][y],tile&&(tile.REMOVING=!0,m_pendingInactiveTiles.push(tile));for(m_pendingInactiveTiles.sort(function(a,b){return a.lastused-b.lastused}),i=0;m_numberOfCachedTiles>m_tileCacheSize&&i<m_pendingInactiveTiles.length;)tile=m_pendingInactiveTiles[i],isTileVisible(tile)?i+=1:(m_this.deleteFeature(tile.feature),delete m_tiles[tile.zoom][tile.index_x][tile.index_y],m_pendingInactiveTiles.splice(i,1),m_numberOfCachedTiles-=1);for(i=0;i<m_pendingInactiveTiles.length;i+=1)tile=m_pendingInactiveTiles[i],tile.REMOVING=!1,tile.REMOVED=!1,tile.zoom!==currZoom&&tile.zoom===lastZoom?tile.feature.bin(m_lastVisibleBinNumber):tile.zoom!==currZoom?tile.feature.bin(m_hiddenBinNumber):(tile.lastused=new Date,tile.feature.bin(m_visibleBinNumber)),tile.feature._update();return m_pendingInactiveTiles=[],m_this},this._addTiles=function(request){function tileOnLoad(tile){var defer=$.Deferred();return m_this.addDeferred(defer),function(){tile.LOADING=!1,tile.LOADED=!0,(tile.REMOVING||tile.REMOVED)&&tile.feature&&tile.zoom!==getModifiedMapZoom()?(tile.feature.bin(m_hiddenBinNumber),tile.REMOVING=!1,tile.REMOVED=!0):(tile.REMOVED=!1,tile.lastused=new Date,tile.feature.bin(m_visibleBinNumber)),tile.updateTimerId===m_updateTimerId&&m_updateTimerId in m_pendingNewTilesStat?(tile.feature.bin(m_visibleBinNumber),m_pendingNewTilesStat[m_updateTimerId].count+=1):(tile.REMOVED=!0,tile.feature.bin(m_hiddenBinNumber)),tile.feature._update(),m_updateTimerId in m_pendingNewTilesStat&&m_pendingNewTilesStat[m_updateTimerId].count>=m_pendingNewTilesStat[m_updateTimerId].total&&drawTiles(),defer.resolve()}}var feature,lastStartX,lastStartY,lastEndX,lastEndY,currStartX,currStartY,currEndX,currEndY,ren=m_this.renderer(),zoom=getModifiedMapZoom(),llx=0,lly=m_this.height(),urx=m_this.width(),ury=0,temp=null,tile=null,tile1x=null,tile1y=null,tile2x=null,tile2y=null,invJ=null,i=0,j=0,worldPt1=ren.displayToWorld([llx,lly]),worldPt2=ren.displayToWorld([urx,ury]);for(worldPt1[0]=Math.max(worldPt1[0],-180),worldPt1[0]=Math.min(worldPt1[0],180),worldPt1[1]=Math.max(worldPt1[1],-180),worldPt1[1]=Math.min(worldPt1[1],180),worldPt2[0]=Math.max(worldPt2[0],-180),worldPt2[0]=Math.min(worldPt2[0],180),worldPt2[1]=Math.max(worldPt2[1],-180),worldPt2[1]=Math.min(worldPt2[1],180),tile1x=geo.mercator.long2tilex(worldPt1[0],zoom),tile1y=geo.mercator.lat2tiley(worldPt1[1],zoom),tile2x=geo.mercator.long2tilex(worldPt2[0],zoom),tile2y=geo.mercator.lat2tiley(worldPt2[1],zoom),tile1x=Math.max(tile1x,0),tile1x=Math.min(Math.pow(2,zoom)-1,tile1x),tile1y=Math.max(tile1y,0),tile1y=Math.min(Math.pow(2,zoom)-1,tile1y),tile2x=Math.max(tile2x,0),tile2x=Math.min(Math.pow(2,zoom)-1,tile2x),tile2y=Math.max(tile2y,0),tile2y=Math.min(Math.pow(2,zoom)-1,tile2y),tile1x>tile2x&&(temp=tile1x,tile1x=tile2x,tile2x=temp),tile2y>tile1y&&(temp=tile1y,tile1y=tile2y,tile2y=temp),currStartX=tile1x,currEndX=tile2x,currStartY=Math.pow(2,zoom)-1-tile1y,currEndY=Math.pow(2,zoom)-1-tile2y,currStartY>currEndY&&(temp=currStartY,currStartY=currEndY,currEndY=temp),lastStartX=geo.mercator.long2tilex(worldPt1[0],m_lastVisibleZoom),lastStartY=geo.mercator.lat2tiley(worldPt1[1],m_lastVisibleZoom),lastEndX=geo.mercator.long2tilex(worldPt2[0],m_lastVisibleZoom),lastEndY=geo.mercator.lat2tiley(worldPt2[1],m_lastVisibleZoom),lastStartY=Math.pow(2,m_lastVisibleZoom)-1-lastStartY,lastEndY=Math.pow(2,m_lastVisibleZoom)-1-lastEndY,lastStartY>lastEndY&&(temp=lastStartY,lastStartY=lastEndY,lastEndY=temp),m_visibleTilesRange={},m_visibleTilesRange[zoom]={startX:currStartX,endX:currEndX,startY:currStartY,endY:currEndY},m_visibleTilesRange[m_lastVisibleZoom]={startX:lastStartX,endX:lastEndX,startY:lastStartY,endY:lastEndY},m_pendingNewTilesStat[m_updateTimerId]={total:(tile2x-tile1x+1)*(tile1y-tile2y+1),count:0},i=tile1x;tile2x>=i;i+=1)for(j=tile2y;tile1y>=j;j+=1)invJ=Math.pow(2,zoom)-1-j,m_this._hasTile(zoom,i,invJ)?(tile=m_tiles[zoom][i][invJ],tile.feature.bin(m_visibleBinNumber),tile.LOADED&&m_updateTimerId in m_pendingNewTilesStat&&(m_pendingNewTilesStat[m_updateTimerId].count+=1),tile.lastused=new Date,tile.feature._update()):tile=m_this._addTile(request,zoom,i,invJ),tile.updateTimerId=m_updateTimerId;for(i=0;i<m_pendingNewTiles.length;i+=1)tile=m_pendingNewTiles[i],feature=m_this.createFeature("plane",{drawOnAsyncResourceLoad:!1,onload:tileOnLoad(tile)}).origin([tile.llx,tile.lly]).upperLeft([tile.llx,tile.ury]).lowerRight([tile.urx,tile.lly]).gcs("EPSG:3857").style("image",tile),tile.feature=feature,tile.feature._update();m_pendingNewTiles=[],m_updateTimerId in m_pendingNewTilesStat&&m_pendingNewTilesStat[m_updateTimerId].count>=m_pendingNewTilesStat[m_updateTimerId].total&&drawTiles()},this._updateTiles=function(request){var defer=$.Deferred();return m_this.addDeferred(defer),null!==m_updateTimerId?(clearTimeout(m_updateTimerId),m_updateDefer.resolve(),m_updateDefer=defer,m_updateTimerId in m_pendingNewTilesStat&&delete m_pendingNewTilesStat[m_updateTimerId],m_updateTimerId=setTimeout(function(){updateOSMTiles(request),m_updateDefer.resolve()},100)):(m_updateDefer=defer,m_updateTimerId=setTimeout(function(){updateOSMTiles(request),m_updateDefer.resolve()},0)),m_this},this._init=function(){return s_init.call(m_this),this.gcs("EPSG:3857"),m_this},this._update=function(request){m_this._updateTiles(request),s_update.call(m_this,request)},this},inherit(geo.osmLayer,geo.featureLayer),geo.registerLayer("osm",geo.osmLayer),ggl=ogs.namespace("geo.gl"),ggl.renderer=function(arg){"use strict";return this instanceof ggl.renderer?(geo.renderer.call(this,arg),this.contextRenderer=function(){throw"Should be implemented by derived classes"},this):new ggl.renderer(arg)},inherit(ggl.renderer,geo.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),ggl.lineFeature=function(arg){"use strict";if(!(this instanceof ggl.lineFeature))return new ggl.lineFeature(arg);arg=arg||{},geo.lineFeature.call(this,arg);var m_this=this,m_actor=null,s_init=this._init,s_update=this._update;return this._init=function(arg){s_init.call(m_this,arg)},this._build=function(){var style=m_this.style();m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),m_actor=vgl.utils.createLines(m_this.positions(),style.colors),m_this.renderer().contextRenderer().addActor(m_actor),m_this.buildTime().modified()},this._update=function(){var style=m_this.style();s_update.call(m_this),m_this.dataTime().getMTime()>=m_this.buildTime().getMTime()&&m_this._build(),m_this.updateTime().getMTime()<=m_this.getMTime()&&(m_this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(m_this.material(),m_this.style.color),m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin()),style.size&&m_actor.material().shaderProgram().uniform("pointSize").set(style.size)),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor)},this._init(arg),this},inherit(ggl.lineFeature,geo.lineFeature),geo.registerFeature("vgl","line",ggl.lineFeature),ggl.pointFeature=function(arg){"use strict";if(!(this instanceof ggl.pointFeature))return new ggl.pointFeature(arg);arg=arg||{},geo.pointFeature.call(this,arg);var m_this=this,m_actor=null,s_init=this._init,s_update=this._update;return this._init=function(arg){s_init.call(m_this,arg)},this._build=function(){var style=m_this.style(),positions=geo.transform.transformFeature(m_this.renderer().map().gcs(),m_this,!1);if(m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),style.point_sprites===!0){if(null===style.point_sprites_image)throw"[error] Invalid image for point sprites";m_actor=vgl.utils.createPointSprites(style.point_sprites_image,positions,style.colors)}else m_actor=vgl.utils.createPoints(positions,style.colors);m_this.renderer().contextRenderer().addActor(m_actor),m_this.buildTime().modified()},this._update=function(){var style=m_this.style();if(s_update.call(m_this),m_this.dataTime().getMTime()>=m_this.buildTime().getMTime()&&m_this._build(),m_this.updateTime().getMTime()<=m_this.getMTime())if(m_this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(m_this.material(),m_this.style.color),style.point_sprites===!0){if(null===style.point_sprites_image)throw"[error] Invalid image for point sprites";style.width&&style.height?m_actor.material().shaderProgram().uniform("pointSize").set([style.width,style.height]):style.size&&m_actor.material().shaderProgram().uniform("pointSize").set([style.size,style.size])}else style.size&&m_actor.material().shaderProgram().uniform("pointSize").set(style.size);m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor)},this._init(arg),this},inherit(ggl.pointFeature,geo.pointFeature),geo.registerFeature("vgl","point",ggl.pointFeature),ggl.geomFeature=function(arg){"use strict";if(!(this instanceof ggl.geomFeature))return new ggl.geomFeature(arg);arg=arg||{},geo.geomFeature.call(this,arg);var m_this=this,m_geom=arg.geom||null,m_actor=vgl.actor(),m_mapper=vgl.mapper(),m_material=null,m_scalar=null,m_color=arg.color||[1,1,1],m_buildTime=null,m_noOfPrimitives=0;return this._build=function(){var style=m_this.style();null!==m_geom&&(m_scalar=m_geom.sourceData(vgl.vertexAttributeKeys.Scalar),m_color=m_geom.sourceData(vgl.vertexAttributeKeys.Color),m_mapper.setGeometryData(m_geom)),this.setMapper(m_mapper),void 0!==style.point_sprites&&style.point_sprites&&void 0!==style.point_sprites_image&&null!==style.point_sprites_image&&1===m_noOfPrimitives&&m_geom.primitive(0).primitiveType()===gl.POINTS?m_material=vgl.utils.createPointSpritesMaterial(style.point_sprites_image):m_scalar?m_color instanceof vgl.lookupTable?(m_color.updateRange(m_scalar.scalarRange()),m_material=vgl.utils.createColorMappedMaterial(m_color)):(m_color=vgl.lookupTable(),m_color.updateRange(m_scalar.scalarRange()),m_material=vgl.utils.createColorMappedMaterial(m_color)):m_material=m_color?vgl.utils.createColorMaterial():vgl.utils.createSolidColorMaterial(),m_actor.setMaterial(m_material)},this._update=function(){m_buildTime&&m_buildTime.getMTime()<m_this.getMTime()?m_color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(m_this.material(),m_this.style.color):(m_buildTime=vgl.timestamp(),m_buildTime.modified())},this.geometry=function(val){return void 0===val?m_geom:(m_geom=val,m_this.modified(),m_this)},this},inherit(ggl.geomFeature,geo.geomFeature),ggl.planeFeature=function(arg){"use strict";if(!(this instanceof ggl.planeFeature))return new ggl.planeFeature(arg);geo.planeFeature.call(this,arg);var m_this=this,m_actor=null,m_onloadCallback=void 0===arg.onload?null:arg.onload;return this.coords=function(){return[m_this.origin(),m_this.upperLeft(),m_this.lowerRight()]},this._build=function(){var or=m_this.origin(),ul=m_this.upperLeft(),lr=m_this.lowerRight(),img=m_this.style().image,image=null,texture=null;or=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),or),ul=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),ul),lr=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),lr),m_this.buildTime().modified(),m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),img&&img instanceof Image?image=img:img&&(image=new Image,image.src=img),image?(m_actor=vgl.utils.createTexturePlane(or[0],or[1],or[2],lr[0],lr[1],lr[2],ul[0],ul[1],ul[2],!0),texture=vgl.texture(),m_this.visible(!1),m_this.renderer().contextRenderer().addActor(m_actor),image.complete?(texture.setImage(image),m_actor.material().addAttribute(texture),m_this.visible(!0),m_onloadCallback&&m_onloadCallback.call(m_this)):image.onload=function(){texture.setImage(image),m_actor.material().addAttribute(texture),m_this.visible(!0),m_onloadCallback&&m_onloadCallback.call(m_this),m_this.drawOnAsyncResourceLoad()&&(m_this._update(),m_this.layer()._draw())}):(m_actor=vgl.utils.createPlane(or[0],or[1],or[2],ul[0],ul[1],ul[2],lr[0],lr[1],lr[2]),m_this.renderer().contextRenderer().addActor(m_actor))
},this._update=function(){m_this.buildTime().getMTime()<=m_this.dataTime().getMTime()&&m_this._build(),m_this.updateTime().getMTime()<=m_this.getMTime()&&(m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin())),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor)},this},inherit(ggl.planeFeature,geo.planeFeature),geo.registerFeature("vgl","plane",ggl.planeFeature),ggl.mapInteractorStyle=function(){"use strict";function computeZoomLevel(){var i,pos=m_camera.position(),width=pos[2]*Math.sin(m_camera.viewAngle());for(i=0;20>i;i+=1)if(width>=360/Math.pow(2,i))return i}function computeCameraDistance(zoomLevel){var deg=360/Math.pow(2,zoomLevel);return deg/Math.sin(m_camera.viewAngle())}if(!(this instanceof ggl.mapInteractorStyle))return new ggl.mapInteractorStyle;vgl.interactorStyle.call(this);var m_map,m_drawRegionLayer,m_clickLatLng,m_width,m_height,m_renderer,m_renderWindow,m_camera,m_outsideCanvas,m_focusDisplayPoint,m_zTrans,m_coords,m_this=this,m_leftMouseButtonDown=!1,m_rightMouseButtonDown=!1,m_middileMouseButtonDown=!1,m_initRightBtnMouseDown=!1,m_drawRegionMode=!1,m_currentMousePos={x:0,y:0},m_lastMousePos={x:0,y:0},m_useLastDirection=!1,m_lastDirection=null,m_picker=new vgl.picker,m_updateRenderParamsTime=vgl.timestamp();return this.map=function(val){return void 0!==val?(m_map=val,m_this):m_map},this.drawRegionMode=function(val){return void 0!==val?(m_drawRegionMode=val,m_drawRegionLayer&&m_drawRegionLayer.setVisible(val),m_map.draw(),m_this):m_drawRegionMode},this._panCamera=function(renderer){var worldPt1,worldPt2,dx,dy,dz,focusDisplayPoint=renderer.focusDisplayPoint();worldPt1=m_renderWindow.displayToWorld(m_currentMousePos.x,m_currentMousePos.y,focusDisplayPoint,renderer),worldPt2=m_renderWindow.displayToWorld(m_lastMousePos.x,m_lastMousePos.y,focusDisplayPoint,renderer),dx=worldPt1[0]-worldPt2[0],dy=worldPt1[1]-worldPt2[1],dz=worldPt1[2]-worldPt2[2],renderer.camera().pan(-dx,-dy,-dz)},this.handleMouseMove=function(event){var mouseWorldPoint,lastWorldPos,currWorldPos,evt,i,renderers;if(m_this.updateRenderParams(),m_this._computeCurrentMousePos(event),m_outsideCanvas===!0)return!0;if(m_leftMouseButtonDown)if(m_drawRegionMode)mouseWorldPoint=m_map.displayToMap(m_currentMousePos.x,m_currentMousePos.y),m_this.setDrawRegion(m_clickLatLng.lat(),m_clickLatLng.lng(),mouseWorldPoint.y,mouseWorldPoint.x);else{for(lastWorldPos=m_camera.position(),renderers=m_renderWindow.renderers(),i=0;i<renderers.length;i+=1)m_this._panCamera(renderers[i]);currWorldPos=m_camera.position(),evt={type:geo.event.pan,last_display_pos:m_lastMousePos,curr_display_pos:m_currentMousePos,last_world_pos:lastWorldPos,curr_world_pos:currWorldPos},$(m_this).trigger(evt)}return m_rightMouseButtonDown&&m_height>0&&(null!==m_lastDirection&&(m_useLastDirection=!0),m_this.zoom()),m_lastMousePos.x=m_currentMousePos.x,m_lastMousePos.y=m_currentMousePos.y,!1},this.handleMouseDown=function(event){var point;return m_this.updateRenderParams(),m_this._computeCurrentMousePos(event),0===event.button&&(m_leftMouseButtonDown=!0),1===event.button&&(m_middileMouseButtonDown=!0),2===event.button&&(m_rightMouseButtonDown=!0),m_coords=m_this.viewer().relMouseCoords(event),m_lastMousePos.x=m_coords.x<0?0:m_coords.x,m_lastMousePos.y=m_coords.y<0?0:m_coords.y,m_drawRegionMode&&m_leftMouseButtonDown&&(point=m_map.displayToMap(m_lastMousePos.x,m_lastMousePos.y),m_clickLatLng=geo.latlng(point.y,point.x),m_this.setDrawRegion(point.y,point.x,point.y,point.x)),m_lastMousePos.x=m_currentMousePos.x,m_lastMousePos.y=m_currentMousePos.y,!1},this.handleMouseUp=function(event){var width=null,height=null,num=null;return m_this.updateRenderParams(),0===event.button&&(m_leftMouseButtonDown=!1,width=m_this.viewer().renderWindow().windowSize()[0],height=m_this.viewer().renderWindow().windowSize()[1],m_renderer=m_this.viewer().renderWindow().activeRenderer(),m_lastMousePos.x>=0&&m_lastMousePos.x<=width&&m_lastMousePos.y>=0&&m_lastMousePos.y<=height&&(num=m_picker.pick(m_lastMousePos.x,m_lastMousePos.y,m_renderer))),1===event.button&&(m_middileMouseButtonDown=!1),2===event.button&&(m_rightMouseButtonDown=!1,m_initRightBtnMouseDown=!1,m_useLastDirection=!1,m_lastDirection=null,m_this._computeCurrentMousePos(event)),!1},this.handleMouseOut=function(){return m_this.updateRenderParams(),m_leftMouseButtonDown?m_leftMouseButtonDown=!1:m_middileMouseButtonDown&&(m_middileMouseButtonDown=!1),m_rightMouseButtonDown&&(m_rightMouseButtonDown=!1,m_initRightBtnMouseDown=!1,m_this.zoom()),!1},this.handleMouseWheel=function(event){m_this.updateRenderParams();var deltaIsPositive,delta=event.originalEvent.wheelDeltaY/120,speed=.05;return deltaIsPositive=delta>=0?!0:!1,delta=Math.pow(1+Math.abs(delta)/2,delta>0?-1:1),delta*=speed,m_this._computeCurrentMousePos(event),m_this.zoom(delta,!deltaIsPositive),!1},this.handleDoubleClick=function(){return m_this.zoom(.5,!1),!1},this._syncZoom=function(val,dir){var i,renderers,pos,fp,cam,clipRange,gap,minGap=.01;for(m_this.updateRenderParams(),val&&(m_camera.zoom(val,dir),dir&&(pos=m_camera.position(),fp=m_camera.focalPoint(),m_camera.setFocalPoint(pos[0],pos[1],fp[2])),m_renderer.resetCameraClippingRange()),pos=m_camera.position(),fp=m_camera.focalPoint(),gap=vec3.distance(pos,fp),dir||(dir=m_camera.directionOfProjection()),clipRange=m_camera.clippingRange(),vec3.dot(dir,m_camera.directionOfProjection())>0&&(Math.abs(gap)<minGap||clipRange[0]<minGap)&&(pos[0]=fp[0]+minGap*dir[0],pos[1]=fp[1]+minGap*dir[1],pos[2]=fp[2]-minGap*dir[2],m_camera.setPosition(pos[0],pos[1],pos[2]),m_camera.setFocalPoint(pos[0],pos[1],fp[2]),m_renderer.resetCameraClippingRange()),pos=m_camera.position(),fp=m_camera.focalPoint(),renderers=m_renderWindow.renderers(),i=0;i<renderers.length;i+=1)cam=renderers[i].camera(),cam!==m_camera&&(cam.setPosition(pos[0],pos[1],pos[2]),cam.setFocalPoint(fp[0],fp[1],fp[2]),renderers[i].resetCameraClippingRange(),renderers[i].render())},this._syncReset=function(){var i,renderers,pos,fp,zoom,center,cam,clippingRange;m_this.updateRenderParams(),zoom=m_map.zoom(),center=m_map.center(),fp=m_camera.focalPoint(),center=m_map.baseLayer().toLocal(geo.latlng(center[0],center[1])),center instanceof Object&&"x"in center&&"y"in center&&m_map.baseLayer()instanceof geo.osmLayer&&(m_camera.setPosition(center.x,center.y,computeCameraDistance(zoom)),m_camera.setFocalPoint(center.x,center.y,fp[2]),m_renderer.resetCameraClippingRange()),fp=m_camera.focalPoint(),pos=m_camera.position(),clippingRange=m_camera.clippingRange(),renderers=m_renderWindow.renderers();for(i=0;i<renderers.length;i+=1)cam=renderers[i].camera(),cam!==m_camera&&(cam.setPosition(pos[0],pos[1],pos[2]),cam.setFocalPoint(fp[0],fp[1],fp[2]),cam.setClippingRange(clippingRange[0],clippingRange[1]),renderers[i].render())},this._syncPan=function(){},this.zoom=function(val,zoomOut){var evt,newZoomLevel,oldZoomLevel,cameraPos,cameraFp,newPos,clickedWorldPoint,direction,focusDisplayPoint,maxZoomedOutDist=0,maxZoomedOut=!1;m_this.updateRenderParams(),m_zTrans=(m_currentMousePos.y-m_lastMousePos.y)/m_height,void 0===val&&(val=2*Math.abs(m_zTrans)),oldZoomLevel=computeZoomLevel(),focusDisplayPoint=m_renderer.focusDisplayPoint(),clickedWorldPoint=m_renderWindow.displayToWorld(m_currentMousePos.x,m_currentMousePos.y,focusDisplayPoint,m_renderer),cameraPos=m_camera.position(),cameraFp=m_camera.focalPoint(),direction=[clickedWorldPoint[0]-cameraPos[0],clickedWorldPoint[1]-cameraPos[1],clickedWorldPoint[2]-cameraPos[2]],vec3.normalize(direction,direction),m_useLastDirection?direction=m_lastDirection.slice(0):m_lastDirection=direction.slice(0),(m_lastMousePos.y-m_currentMousePos.y<0||zoomOut)&&(direction[0]=-direction[0],direction[1]=-direction[1],direction[2]=-direction[2]),cameraPos[2]*Math.sin(m_camera.viewAngle())>=360&&zoomOut?maxZoomedOut=!0:(this._syncZoom(val,direction),newZoomLevel=computeZoomLevel()),cameraPos=m_camera.position(),cameraFp=m_camera.focalPoint(),(maxZoomedOut||cameraPos[2]*Math.sin(m_camera.viewAngle())>=360)&&(maxZoomedOut=!1,maxZoomedOutDist=computeCameraDistance(0),newPos=[(maxZoomedOutDist-cameraPos[2])*direction[0]/direction[2],(maxZoomedOutDist-cameraPos[2])*direction[1]/direction[2]],m_camera.setPosition(cameraPos[0]+newPos[0],cameraPos[1]+newPos[1],maxZoomedOutDist),m_camera.setFocalPoint(cameraPos[0]+newPos[0],cameraPos[1]+newPos[1],cameraFp[2]),m_renderer.resetCameraClippingRange(),newZoomLevel=0,this._syncZoom()),evt={type:geo.event.zoom,curr_zoom:newZoomLevel,last_zoom:oldZoomLevel},$(m_this).trigger(evt)},this.lastMousePosition=function(newPosition){return void 0!==newPosition?(m_lastMousePos=newPosition,m_this):m_lastMousePos},this.leftMouseDown=function(newValue){return void 0!==newValue?(m_leftMouseButtonDown=newValue,m_this):m_leftMouseButtonDown},this.setDrawRegion=function(lat1,lon1,lat2,lon2){var evt,plane=geo.planeFeature(geo.latlng(lat1,lon1),geo.latlng(lat2,lon2),99);return m_map.removeLayer(m_drawRegionLayer),m_drawRegionLayer=geo.featureLayer({opacity:.5,showAttribution:1},plane),m_map.addLayer(m_drawRegionLayer),evt=jQuery.Event(geo.event.updateDrawRegionEvent),$(m_this).trigger(geo.command.updateDrawRegionEvent,evt),m_this},this.getDrawRegion=function(){return m_drawRegionLayer.features()[0].getCoords()},this._computeCurrentMousePos=function(event){void 0!==event.pageX&&void 0!==event.pageY&&(m_this.updateRenderParams(),m_outsideCanvas=!1,m_coords=m_this.viewer().relMouseCoords(event),m_coords.x<0||m_coords.x>m_width?(m_currentMousePos.x=0,m_outsideCanvas=!0):m_currentMousePos.x=m_coords.x,m_coords.y<0||m_coords.y>m_height?(m_currentMousePos.y=0,m_outsideCanvas=!0):m_currentMousePos.y=m_coords.y)},this.updateRenderParams=function(){m_renderWindow=m_this.viewer().renderWindow(),m_width=m_renderWindow.windowSize()[0],m_height=m_renderWindow.windowSize()[1],m_renderer=m_this.viewer().renderWindow().activeRenderer(),m_camera=m_renderer.camera(),m_focusDisplayPoint=m_renderWindow.focusDisplayPoint(),m_updateRenderParamsTime.modified()},this.reset=function(){var evt,zoom;m_map&&(zoom=m_map.zoom(),m_this._syncReset(),evt={type:geo.event.zoom,curr_zoom:zoom,last_zoom:zoom},$(m_this).trigger(evt))},this},inherit(ggl.mapInteractorStyle,vgl.interactorStyle),ggl._vglViewerInstance=null,ggl.vglViewerInstance=function(){"use strict";var canvas;return null===ggl._vglViewerInstance&&(canvas=$(document.createElement("canvas")),canvas.attr("class",".webgl-canvas"),ggl._vglViewerInstance=vgl.viewer(canvas.get(0)),ggl._vglViewerInstance.renderWindow().removeRenderer(ggl._vglViewerInstance.renderWindow().activeRenderer()),ggl._vglViewerInstance.setInteractorStyle(ggl.mapInteractorStyle()),ggl._vglViewerInstance.init()),ggl._vglViewerInstance},ggl.vglRenderer=function(arg){"use strict";if(!(this instanceof ggl.vglRenderer))return new ggl.vglRenderer(arg);ggl.renderer.call(this,arg);var m_this=this,m_viewer=ggl.vglViewerInstance(),m_contextRenderer=vgl.renderer(),m_width=0,m_height=0,s_init=this._init;return m_contextRenderer.setResetScene(!1),this.displayToWorld=function(input){var i,delta,output,temp,point,ren=m_this.contextRenderer(),cam=ren.camera(),fdp=ren.focusDisplayPoint();if(input instanceof Array&&input.length>0)if(output=[],input[0]instanceof Object)for(delta=1,i=0;i<input.length;i+=delta)point=input[i],temp=ren.displayToWorld(vec4.fromValues(point.x,point.y,fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push({x:temp[0],y:temp[1],z:temp[2],w:temp[3]});else if(input[0]instanceof Array)for(delta=1,i=0;i<input.length;i+=delta)point=input[i],temp=ren.displayToWorld(vec4.fromValues(point[0],point[1],fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp);else for(delta=input.length%3===0?3:2,i=0;i<input.length;i+=delta)temp=ren.displayToWorld(vec4.fromValues(input[i],input[i+1],fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]),output.push(temp[3]);else{if(!(input instanceof Object))throw"Display to world conversion requires array of 2D/3D points";output={},temp=ren.displayToWorld(vec4.fromValues(input.x,input.y,fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output={x:temp[0],y:temp[1],z:temp[2],w:temp[3]}}return output},this.worldToDisplay=function(input){var i,temp,delta,ren=m_this.contextRenderer(),cam=ren.camera(),fp=cam.focalPoint(),output=[];if(input instanceof Array&&input.length>0)if(output=[],input[0]instanceof Object)for(delta=1,i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i].x,input[i].y,fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output[i]={x:temp[0],y:temp[1],z:temp[2]};else if(input[0]instanceof Array)for(delta=1,i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i][0],input[i][1],fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output[i].push(temp);else if(delta=input.length%3===0?3:2,2===delta)for(i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i],input[i+1],fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]);else for(i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i],input[i+1],input[i+2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]);else{if(!(input instanceof Object))throw"World to display conversion requires array of 2D/3D points";temp=ren.worldToDisplay(vec4.fromValues(input.x,input.y,fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output={x:temp[0],y:temp[1],z:temp[2]}}return output},this.contextRenderer=function(){return m_contextRenderer},this.api=function(){return"vgl"},this.reset=function(){m_viewer.interactorStyle().reset()},this._init=function(){return m_this.initialized()?m_this:(s_init.call(m_this),m_this.canvas($(m_viewer.canvas())),m_viewer.renderWindow().renderers().length>0&&(m_contextRenderer.setLayer(m_viewer.renderWindow().renderers().length),m_contextRenderer.setResetScene(!1)),m_viewer.renderWindow().addRenderer(m_contextRenderer),m_this.layer().node().append(m_this.canvas()),$(m_viewer.interactorStyle()).on(geo.event.pan,function(event){m_this.trigger(geo.event.pan,event)}),$(m_viewer.interactorStyle()).on(geo.event.zoom,function(event){m_this.trigger(geo.event.zoom,event)}),m_this)},this._connectMapEvents=function(){if(m_this.layer().referenceLayer()){var map=$(m_this.layer().map().node()),wheel="onwheel"in map?"wheel":void 0!==document.onmousewheel?"mousewheel":"MozMousePixelScroll",wheelDelta="wheel"===wheel?function(evt){return evt.originalEvent.deltaY*(evt.originalEvent.deltaMode?120:1)}:"mousewheel"===wheel?function(evt){return evt.originalEvent.wheelDelta}:function(evt){return-evt.originalEvent.detail};m_viewer.unbindEventHandlers(),map.on(wheel,function(event){event.originalEvent.wheelDeltaY=wheelDelta(event),event.originalEvent.wheelDelta=event.originalEvent.wheelDeltaY,m_viewer.handleMouseWheel(event)}),map.on("mousemove",function(event){m_viewer.handleMouseMove(event)}),map.on("mouseup",function(event){m_viewer.handleMouseUp(event)}),map.on("mousedown",function(event){m_viewer.handleMouseDown(event)}),map.on("mouseout",function(event){var selection=$(map),offset=selection.offset(),width=selection.width(),height=selection.height(),x=event.pageX-offset.left,y=event.pageY-offset.top;(0>x||x>=width||0>y||y>=height)&&m_viewer.handleMouseOut(event)}),map.on("keypress",function(event){m_viewer.handleKeyPress(event)}),map.on("contextmenu",function(event){m_viewer.handleContextMenu(event)}),map.on("click",function(event){m_viewer.handleClick(event)}),map.on("dblclick",function(event){m_viewer.handleDoubleClick(event)})}m_viewer.interactorStyle().map(m_this.layer().map()),m_viewer.interactorStyle().reset()},this.on(geo.event.layerAdd,function(event){event.layer===m_this.layer()&&m_this._connectMapEvents()}),this._resize=function(x,y,w,h){return m_width=w,m_height=h,m_this.canvas().attr("width",w),m_this.canvas().attr("height",h),m_viewer.renderWindow().positionAndResize(x,y,w,h),m_this._render(),m_this},this._render=function(){return m_viewer.render(),m_this},this._exit=function(){},this},inherit(ggl.vglRenderer,ggl.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),gd3=ogs.namespace("geo.d3"),function(gd3){"use strict";var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",strLength=8;gd3.uniqueID=function(){var i,strArray=[];for(strArray.length=strLength,i=0;strLength>i;i+=1)strArray[i]=chars.charAt(Math.floor(Math.random()*chars.length));return strArray.join("")},geo.event.d3Rescale="geo.d3.rescale"}(gd3),gd3.object=function(arg){"use strict";if(!(this instanceof geo.object))return new gd3.object(arg);geo.sceneObject.call(this);var m_id="d3-"+gd3.uniqueID(),m_this=this,s_draw=this.draw;return this._d3id=function(){return m_id},this.select=function(){return m_this.renderer().select(m_this._d3id())},this.draw=function(){return m_this._update(),s_draw(),m_this},this._exit=function(){return m_this.renderer()._removeFeature(m_this._d3id())},this},inherit(gd3.object,geo.sceneObject),gd3.pointFeature=function(arg){"use strict";if(!(this instanceof gd3.pointFeature))return new gd3.pointFeature(arg);arg=arg||{},geo.pointFeature.call(this,arg),gd3.object.call(this);var d_attr,d_style,m_sticky,m_this=this,s_init=this._init,s_update=this._update,m_buildTime=geo.timestamp(),m_style={};return d_attr={cx:function(d){return d.x},cy:function(d){return d.y},r:1},d_style={fill:"black",stroke:"none"},m_style={attributes:d_attr,style:d_style},this._init=function(arg){return s_init.call(m_this,arg),m_sticky=m_this.layer().sticky(),m_this},this._build=function(){var data=m_this.positions()||[],s_style=m_this.style(),m_renderer=m_this.renderer();return data=m_renderer.worldToDisplay(data),s_update.call(m_this),data||(data=[]),m_style.id=m_this._d3id(),m_style.data=data,m_style.append="circle",m_style.style=$.extend({},d_style),m_style.attributes=$.extend({},d_attr),m_style.classes=["d3PointFeature"],m_style.style.fill=d3.rgb(255*s_style.color[0],255*s_style.color[1],255*s_style.color[2]),m_style.attributes.r=function(){var m_scale=m_renderer.scaleFactor();return(s_style.size/m_scale).toString()+"px"},m_style.style["fill-opacity"]=s_style.opacity,m_this.renderer()._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},m_this.on(geo.event.d3Rescale,function(){m_this.renderer().select(m_this._d3id()).attr("r",m_style.attributes.r)}),this._init(arg),this},inherit(gd3.pointFeature,geo.pointFeature),geo.registerFeature("d3","point",gd3.pointFeature),gd3.lineFeature=function(arg){"use strict";if(!(this instanceof gd3.lineFeature))return new gd3.lineFeature(arg);arg=arg||{},geo.lineFeature.call(this,arg),gd3.object.call(this);var m_this=this,s_init=this._init,m_buildTime=geo.timestamp(),s_update=this._update,m_style={};return m_style.style={},this._init=function(arg){return s_init.call(m_this,arg),m_this},this._build=function(){var data=m_this.positions()||[],s_style=m_this.style(),m_renderer=m_this.renderer(),line=d3.svg.line().x(function(d){return d.x}).y(function(d){return d.y});return s_update.call(m_this),data=m_renderer.worldToDisplay(data),m_style.data=[data],m_style.attributes={d:line},m_style.id=m_this._d3id(),m_style.append="path",m_style.classes=["d3LineFeature"],m_style.style={fill:"none",stroke:d3.rgb(255*s_style.color[0],255*s_style.color[1],255*s_style.color[2]),"stroke-width":function(){var m_scale=m_renderer.scaleFactor();return(s_style.width[0]/m_scale).toString()+"px"},"stroke-opacity":s_style.opacity},m_renderer._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},m_this.on(geo.event.d3Rescale,function(){m_this.renderer().select(m_this._d3id()).style("stroke-width",m_style.style["stroke-width"])}),this._init(arg),this},inherit(gd3.lineFeature,geo.lineFeature),geo.registerFeature("d3","line",gd3.lineFeature),gd3.pathFeature=function(arg){"use strict";if(!(this instanceof gd3.pathFeature))return new gd3.pathFeature(arg);arg=arg||{},geo.pathFeature.call(this,arg),gd3.object.call(this);var m_this=this,s_init=this._init,m_buildTime=geo.timestamp(),s_update=this._update,m_style={};return m_style.style={},this._init=function(arg){return s_init.call(m_this,arg),m_this},this._build=function(){var tmp,diag,data=m_this.positions()||[],s_style=m_this.style(),m_renderer=m_this.renderer();return s_update.call(m_this),diag=function(d){var p={source:d.source,target:d.target};return d3.svg.diagonal()(p)},tmp=[],data.forEach(function(d,i){var src,trg;i<data.length-1&&(src=d,trg=data[i+1],tmp.push({source:m_renderer.worldToDisplay(src),target:m_renderer.worldToDisplay(trg)}))}),m_style.data=tmp,m_style.attributes={d:diag},m_style.id=m_this._d3id(),m_style.append="path",m_style.classes=["d3PathFeature"],m_style.style={fill:"none",stroke:d3.rgb(255*s_style.color[0],255*s_style.color[1],255*s_style.color[2]),"stroke-width":function(){var m_scale=m_renderer.scaleFactor();return(s_style.width[0]/m_scale).toString()+"px"},"stroke-opacity":s_style.opacity},m_this.renderer()._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},m_this.on(geo.event.d3Rescale,function(){m_this.renderer().select(m_this._d3id()).style("stroke-width",m_style.style["stroke-width"])}),this._init(arg),this},inherit(gd3.pathFeature,geo.pathFeature),geo.registerFeature("d3","path",gd3.pathFeature),gd3.graphFeature=function(arg){"use strict";var m_this=this;return this instanceof gd3.graphFeature?(geo.graphFeature.call(this,arg),this.select=function(){var renderer=m_this.renderer(),selection={},node=m_this.nodeFeature(),links=m_this.linkFeatures();return selection.nodes=renderer.select(node._d3id()),selection.links=links.map(function(link){return renderer.select(link._d3id())}),selection},this):new gd3.graphFeature(arg)},inherit(gd3.graphFeature,geo.graphFeature),geo.registerFeature("d3","graph",gd3.graphFeature),gd3.d3Renderer=function(arg){"use strict";function setAttrs(select,attrs){var key;for(key in attrs)attrs.hasOwnProperty(key)&&select.attr(key,attrs[key])}function getMap(){var layer=m_this.layer();return layer?layer.map():null}function getGroup(){return m_svg.select(".group-"+m_this._d3id())}function initCorners(){var layer=m_this.layer(),map=layer.map(),width=m_this.layer().width(),height=m_this.layer().height();if(m_width=width,m_height=height,!m_width||!m_height)throw"Map layer has size 0";m_corners={upperLeft:map.displayToGcs({x:0,y:0}),lowerRight:map.displayToGcs({x:width,y:height})}}function setTransform(){if(m_corners||initCorners(),m_sticky){var dx,dy,scale,layer=m_this.layer(),map=layer.map(),upperLeft=map.gcsToDisplay(m_corners.upperLeft),lowerRight=map.gcsToDisplay(m_corners.lowerRight),group=getGroup();dx=upperLeft.x,dy=upperLeft.y,scale=(lowerRight.y-upperLeft.y)/m_height,group.attr("transform","matrix("+[scale,0,0,scale,dx,dy].join()+")"),m_scale=scale,m_dx=dx,m_dy=dy}}function baseToLocal(pt){return{x:(pt.x-m_dx)/m_scale,y:(pt.y-m_dy)/m_scale}}function localToBase(pt){return{x:pt.x*m_scale+m_dx,y:pt.y*m_scale+m_dy}}if(!(this instanceof gd3.d3Renderer))return new gd3.d3Renderer(arg);geo.renderer.call(this,arg),gd3.object.call(this,arg),arg=arg||{};var m_this=this,m_sticky=null,m_features={},m_corners=null,m_width=null,m_height=null,m_scale=1,m_dx=0,m_dy=0,m_svg=null;return this._init=function(){if(!m_this.canvas()){var canvas;m_svg=d3.select(m_this.layer().node().get(0)).append("svg"),canvas=m_svg.append("g"),m_sticky=m_this.layer().sticky(),m_svg.attr("class",m_this._d3id()),m_svg.attr("width",m_this.layer().node().width()),m_svg.attr("height",m_this.layer().node().height()),canvas.attr("class","group-"+m_this._d3id()),m_this.canvas(canvas)}},this.displayToWorld=function(pt){var map=getMap();if(!map)throw"Cannot project until this layer is connected to a map.";return pt=Array.isArray(pt)?pt.map(function(x){return map.displayToGcs(localToBase(x))}):map.displayToGcs(localToBase(pt))},this.worldToDisplay=function(pt){var map=getMap();if(!map)throw"Cannot project until this layer is connected to a map.";var v;return v=Array.isArray(pt)?pt.map(function(x){return baseToLocal(map.gcsToDisplay(x))}):baseToLocal(map.gcsToDisplay(pt))},this.api=function(){return"d3"},this.scaleFactor=function(){return m_scale},this._resize=function(x,y,w,h){m_corners||initCorners(),m_svg.attr("width",w),m_svg.attr("height",h),setTransform(),m_this.layer().trigger(geo.event.d3Rescale,{scale:m_scale},!0)},this._update=function(){},this._exit=function(){m_features={},m_this.canvas().remove()},this._drawFeatures=function(arg){return m_features[arg.id]={data:arg.data,index:arg.dataIndex,style:arg.style,attributes:arg.attributes,classes:arg.classes,append:arg.append},m_this._render(arg.id)},this._render=function(id){var key;if(void 0===id){for(key in m_features)m_features.hasOwnProperty(key)&&m_this._render(key);return m_this}var data=m_features[id].data,index=m_features[id].index,style=m_features[id].style,attributes=m_features[id].attributes,classes=m_features[id].classes,append=m_features[id].append,selection=m_this.select(id).data(data,index);return selection.enter().append(append),selection.exit().remove(),setAttrs(selection,attributes),selection.attr("class",classes.concat([id]).join(" ")),selection.style(style),m_this},this.select=function(id){return getGroup().selectAll("."+id)},this._removeFeature=function(id){return m_this.select(id).remove(),delete m_features[id],m_this},this.draw=function(){},this.on(geo.event.pan,setTransform),this.on(geo.event.zoom,function(){setTransform(),m_this.layer().trigger(geo.event.d3Rescale,{scale:m_scale},!0)}),this.on(geo.event.resize,function(event){m_this._resize(event.x,event.y,event.width,event.height)}),this._init(arg),this},inherit(gd3.d3Renderer,geo.renderer),geo.registerRenderer("d3Renderer",gd3.d3Renderer),geo.version="0.1.0";var ogs;ogs=window&&void 0!==window.ogs?window.ogs:{},ogs.namespace=function(ns_string){"use strict";var i,parts=ns_string.split("."),parent=ogs;for("ogs"===parts[0]&&(parts=parts.slice(1)),i=0;i<parts.length;i+=1)void 0===parent[parts[i]]&&(parent[parts[i]]={}),parent=parent[parts[i]];return parent};var geo=ogs.namespace("geo");window.geo=geo,geo.renderers={},geo.features={},geo.fileReaders={},inherit=function(C,P){"use strict";var F=function(){};F.prototype=P.prototype,C.prototype=new F,C.uber=P.prototype,C.prototype.constructor=C},Object.size=function(obj){"use strict";var size=0,key=null;for(key in obj)obj.hasOwnProperty(key)&&(size+=1);return size},geo.registerFileReader=function(name,func){"use strict";void 0===geo.fileReaders&&(geo.fileReaders={}),geo.fileReaders[name]=func},geo.createFileReader=function(name,opts){"use strict";return geo.fileReaders.hasOwnProperty(name)?geo.fileReaders[name](opts):null},geo.registerRenderer=function(name,func){"use strict";void 0===geo.renderers&&(geo.renderers={}),geo.renderers[name]=func},geo.createRenderer=function(name,layer,canvas){"use strict";if(geo.renderers.hasOwnProperty(name)){var ren=geo.renderers[name]({layer:layer,canvas:canvas});return ren._init(),ren}return null},geo.registerFeature=function(category,name,func){"use strict";void 0===geo.features&&(geo.features={}),category in geo.features||(geo.features[category]={}),geo.features[category][name]=func},geo.createFeature=function(name,layer,renderer,arg){"use strict";var category=renderer.api(),options={layer:layer,renderer:renderer};return category in geo.features&&name in geo.features[category]?(void 0!==arg&&$.extend(!0,options,arg),geo.features[category][name](options)):null},geo.registerLayer=function(name,func){"use strict";void 0===geo.layers&&(geo.layers={}),geo.layers[name]=func},geo.createLayer=function(name,map,arg){"use strict";var options={map:map,renderer:"vglRenderer"},layer=null;return name in geo.layers?(void 0!==arg&&$.extend(!0,options,arg),layer=geo.layers[name](options),layer._init(),layer):null},geo.object=function(){"use strict";if(!(this instanceof geo.object))return new geo.object;var m_this=this,m_eventHandlers={},m_idleHandlers=[],m_deferredCount=0;return this.onIdle=function(handler){m_deferredCount?m_idleHandlers.push(handler):handler()},this.addDeferred=function(defer){m_deferredCount+=1,defer.done(function(){m_deferredCount-=1,m_deferredCount||m_idleHandlers.splice(0,m_idleHandlers.length).forEach(function(handler){handler()})})},this.on=function(event,handler){return Array.isArray(event)?(event.forEach(function(e){m_this.on(e,handler)}),m_this):(m_eventHandlers.hasOwnProperty(event)||(m_eventHandlers[event]=[]),m_eventHandlers[event].push(handler),m_this)},this.trigger=function(event,args){return Array.isArray(event)?(event.forEach(function(e){m_this.trigger(e,args)}),m_this):(m_eventHandlers.hasOwnProperty(event)&&m_eventHandlers[event].forEach(function(handler){handler(args)}),m_this)},this.off=function(event,arg){if(Array.isArray(event))return event.forEach(function(e){m_this.off(e,arg)}),m_this;if(arg){if(Array.isArray(arg))return arg.forEach(function(handler){m_this.off(event,handler)}),m_this}else m_eventHandlers[event]=[];return m_eventHandlers.hasOwnProperty(event)&&(m_eventHandlers[event]=m_eventHandlers[event].filter(function(f){return f!==arg})),m_this},vgl.object.call(this),this},inherit(geo.object,vgl.object),geo.sceneObject=function(arg){"use strict";if(!(this instanceof geo.sceneObject))return new geo.sceneObject;geo.object.call(this,arg);var m_this=this,m_parent=null,m_children=[],s_trigger=this.trigger,s_addDeferred=this.addDeferred,s_onIdle=this.onIdle;return this.addDeferred=function(defer){m_parent?m_parent.addDeferred(defer):s_addDeferred(defer)},this.onIdle=function(handler){m_parent?m_parent.onIdle(handler):s_onIdle(handler)},this.parent=function(arg){return void 0===arg?m_parent:(m_parent=arg,m_this)},this.addChild=function(child){return Array.isArray(child)?(child.forEach(m_this.addChild),m_this):(child.parent(m_this),m_children.push(child),m_this)},this.removeChild=function(child){return Array.isArray(child)?(child.forEach(m_this.removeChild),m_this):(m_children=m_children.filter(function(c){return c!==child}),m_this)},this.children=function(){return m_children.slice()},this.draw=function(arg){return m_this.children().forEach(function(child){child.draw(arg)}),m_this},this.trigger=function(event,args,childrenOnly){var geoArgs;return args=args||{},geoArgs=args.geo||{},args.geo=geoArgs,!childrenOnly&&m_parent&&geoArgs._triggeredBy!==m_parent?(geoArgs._triggeredBy=m_this,m_parent.trigger(event,args),m_this):(s_trigger.call(m_this,event,args),geoArgs.stopPropagation?m_this:(m_children.forEach(function(child){geoArgs._triggeredBy=m_this,child.trigger(event,args)}),m_this))},this},inherit(geo.sceneObject,geo.object),geo.timestamp=function(){"use strict";return this instanceof geo.timestamp?void vgl.timestamp.call(this):new geo.timestamp},inherit(geo.timestamp,vgl.timestamp),geo.ellipsoid=function(x,y,z){"use strict";if(!(this instanceof geo.ellipsoid))return new geo.ellipsoid(x,y,z);if(x=vgl.defaultValue(x,0),y=vgl.defaultValue(y,0),z=vgl.defaultValue(z,0),0>x||0>y||0>z)return console.log("[error] Al radii components must be greater than zero");var m_this=this,m_radii=new vec3.fromValues(x,y,z),m_radiiSquared=new vec3.fromValues(x*x,y*y,z*z),m_minimumRadius=Math.min(x,y,z),m_maximumRadius=Math.max(x,y,z);return this.radii=function(){return m_radii},this.radiiSquared=function(){return m_radiiSquared},this.maximumRadius=function(){return m_maximumRadius
},this.minimumRadius=function(){return m_minimumRadius},this.computeGeodeticSurfaceNormal=function(lat,lon){if("undefined"==typeof lat||"undefined"==typeof lon)throw"[error] Valid latitude and longitude is required";var cosLatitude=Math.cos(lat),result=vec3.create();return result[0]=cosLatitude*Math.cos(lon),result[1]=cosLatitude*Math.sin(lon),result[2]=Math.sin(lat),vec3.normalize(result,result),result},this.transformPoint=function(lat,lon,elev){lat*=Math.PI/180,lon*=Math.PI/180;var n=m_this.computeGeodeticSurfaceNormal(lat,lon),k=vec3.create(),gamma=Math.sqrt(vec3.dot(n,k)),result=vec3.create();return vec3.multiply(k,m_radiiSquared,n),vec3.scale(k,k,1/gamma),vec3.scale(n,n,elev),vec3.add(result,n,k),result},this.transformGeometry=function(geom){if(!geom)throw"[error] Failed to transform to cartesian. Invalid geometry.";var sourceData=geom.sourceData(vgl.vertexAttributeKeys.Position),sourceDataArray=sourceData.data(),noOfComponents=sourceData.attributeNumberOfComponents(vgl.vertexAttributeKeys.Position),stride=sourceData.attributeStride(vgl.vertexAttributeKeys.Position),offset=sourceData.attributeOffset(vgl.vertexAttributeKeys.Position),sizeOfDataType=sourceData.sizeOfAttributeDataType(vgl.vertexAttributeKeys.Position),index=null,count=sourceDataArray.length*(1/noOfComponents),gamma=null,n=null,j=0,k=vec3.create(),result=vec3.create();if(stride/=sizeOfDataType,offset/=sizeOfDataType,3!==noOfComponents)throw"[error] Requires positions with three components";for(j=0;count>j;j+=1)index=j*stride+offset,sourceDataArray[index]=sourceDataArray[index]*(Math.PI/180),sourceDataArray[index+1]=sourceDataArray[index+1]*(Math.PI/180),n=m_this.computeGeodeticSurfaceNormal(sourceDataArray[index+1],sourceDataArray[index]),vec3.multiply(k,m_radiiSquared,n),gamma=Math.sqrt(vec3.dot(n,k)),vec3.scale(k,k,1/gamma),vec3.scale(n,n,sourceDataArray[index+2]),vec3.add(result,n,k),sourceDataArray[index]=result[0],sourceDataArray[index+1]=result[1],sourceDataArray[index+2]=result[2]},m_this},geo.ellipsoid.WGS84=vgl.freezeObject(geo.ellipsoid(6378137,6378137,6356752.314245179)),geo.ellipsoid.UNIT_SPHERE=vgl.freezeObject(geo.ellipsoid(1,1,1)),geo.mercator={r_major:6378137},geo.mercator.r_minor=function(spherical){"use strict";var r_minor;return spherical=void 0!==spherical?spherical:!1,r_minor=spherical?6378137:6356752.314245179},geo.mercator.f=function(spherical){"use strict";return(geo.mercator.r_major-geo.mercator.r_minor(spherical))/geo.mercator.r_major},geo.mercator.long2tilex=function(lon,z){"use strict";var rad=(lon+180)/360,f=Math.floor(rad*Math.pow(2,z));return f},geo.mercator.lat2tiley=function(lat,z){"use strict";var rad=lat*Math.PI/180;return Math.floor((1-rad/Math.PI)/2*Math.pow(2,z))},geo.mercator.long2tilex2=function(lon,z){"use strict";var rad=(lon+180)/360,f=rad*Math.pow(2,z),ret=Math.floor(f),frac=f-ret;return[ret,frac]},geo.mercator.lat2tiley2=function(lat,z){"use strict";var rad=lat*Math.PI/180,f=(1-Math.log(Math.tan(rad)+1/Math.cos(rad))/Math.PI)/2*Math.pow(2,z),ret=Math.floor(f),frac=f-ret;return[ret,frac]},geo.mercator.tilex2long=function(x,z){"use strict";return x/Math.pow(2,z)*360-180},geo.mercator.tiley2lat=function(y,z){"use strict";var n=Math.PI-2*Math.PI*y/Math.pow(2,z);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},geo.mercator.y2lat=function(a){"use strict";return 180/Math.PI*(2*Math.atan(Math.exp(a*Math.PI/180))-Math.PI/2)},geo.mercator.lat2y=function(a){"use strict";return 180/Math.PI*Math.log(Math.tan(Math.PI/4+a*(Math.PI/180)/2))},geo.mercator.deg2rad=function(d){"use strict";var r=d*(Math.PI/180);return r},geo.mercator.rad2deg=function(r){"use strict";var d=r/(Math.PI/180);return d},geo.mercator.ll2m=function(lon,lat,spherical){"use strict";lat>89.5&&(lat=89.5),-89.5>lat&&(lat=-89.5);var x=this.r_major*this.deg2rad(lon),temp=this.r_minor(spherical)/this.r_major,es=1-temp*temp,eccent=Math.sqrt(es),phi=this.deg2rad(lat),sinphi=Math.sin(phi),con=eccent*sinphi,com=.5*eccent,con2=Math.pow((1-con)/(1+con),com),ts=Math.tan(.5*(.5*Math.PI-phi))/con2,y=-this.r_major*Math.log(ts),ret={x:x,y:y};return ret},geo.mercator.m2ll=function(x,y,spherical){"use strict";var lon=this.rad2deg(x/this.r_major),temp=this.r_minor(spherical)/this.r_major,e=Math.sqrt(1-temp*temp),lat=this.rad2deg(this.pjPhi2(Math.exp(-(y/this.r_major)),e)),ret={lon:lon,lat:lat};return ret},geo.mercator.pjPhi2=function(ts,e){"use strict";var con,dphi,N_ITER=15,HALFPI=Math.PI/2,TOL=1e-10,i=N_ITER,eccnth=.5*e,Phi=HALFPI-2*Math.atan(ts);do con=e*Math.sin(Phi),dphi=HALFPI-2*Math.atan(ts*Math.pow((1-con)/(1+con),eccnth))-Phi,Phi+=dphi,i-=1;while(Math.abs(dphi)>TOL&&i);return Phi},geo.latlng=function(arg1,arg2){"use strict";if(!(this instanceof geo.latlng))return new geo.latlng(arg1,arg2);var m_this=this,m_lat=void 0===arg2?arg1.lat():arg1,m_lng=void 0===arg2?arg1.lng():arg2;return this.lat=function(val){return void 0===val?m_lat:void(m_lat=val)},this.lng=function(val){return void 0===val?m_lng:void(m_lng=val)},this.x=function(val){return void 0===val?m_this.lng():void(m_lng=val)},this.y=function(val){return void 0===val?m_this.lat():void(m_lat=val)},this},geo.layerOptions=function(){"use strict";return this instanceof geo.layerOptions?(this.opacity=.5,this.showAttribution=!0,this.visible=!0,this.binNumber=vgl.material.RenderBin.Default,this):new geo.layerOptions},geo.newLayerId=function(){"use strict";var currentId=1;return function(){var id=currentId;return currentId+=1,id}}(),geo.layer=function(arg){"use strict";if(!(this instanceof geo.layer))return new geo.layer(arg);arg=arg||{},geo.sceneObject.call(this,arg);var m_this=this,m_style=void 0===arg.style?{opacity:.5,color:[.8,.8,.8],visible:!0,bin:100}:arg.style,m_id=void 0===arg.id?geo.newLayerId():arg.id,m_name="",m_gcs="EPSG:4326",m_timeRange=null,m_source=arg.source||null,m_map=void 0===arg.map?null:arg.map,m_isReference=!1,m_x=0,m_y=0,m_width=0,m_height=0,m_node=null,m_canvas=null,m_renderer=null,m_initialized=!1,m_rendererName=void 0===arg.renderer?"vglRenderer":arg.renderer,m_dataTime=geo.timestamp(),m_updateTime=geo.timestamp(),m_drawTime=geo.timestamp(),m_sticky=void 0===arg.sticky?!0:arg.sticky;return this.sticky=function(){return m_sticky},this.node=function(){return m_node},this.id=function(val){return void 0===val?m_id:(m_id=geo.newLayerId(),m_this.modified(),m_this)},this.name=function(val){return void 0===val?m_name:(m_name=val,m_this.modified(),m_this)},this.opacity=function(val){return void 0===val?m_style.opacity:(m_style.opacity=val,m_this.modified(),m_this)},this.visible=function(val){return void 0===val?m_style.visible:(m_style.visible=val,m_this.modified(),m_this)},this.bin=function(val){return void 0===val?m_style.bin:(m_style.bin=val,m_this.modified(),m_this)},this.gcs=function(val){return void 0===val?m_gcs:(m_gcs=val,m_this.modified(),m_this)},this.transform=function(val){return geo.transform.transformLayer(val,m_this,m_map.baseLayer()),m_this},this.timeRange=function(val){return void 0===val?m_timeRange:(m_timeRange=val,m_this.modified(),m_this)},this.source=function(val){return void 0===val?m_source:(m_source=val,m_this.modified(),m_this)},this.map=function(val){return void 0===val?m_map:(m_map=val,m_map.node().append(m_node),m_this.modified(),m_this)},this.renderer=function(){return m_renderer},this.canvas=function(){return m_canvas},this.viewport=function(){return[m_x,m_y,m_width,m_height]},this.dataTime=function(){return m_dataTime},this.updateTime=function(){return m_updateTime},this.drawTime=function(){return m_drawTime},this.query=function(){},this.referenceLayer=function(val){return void 0!==val?(m_isReference=val,m_this.modified(),m_this):m_isReference},this.initialized=function(val){return void 0!==val?(m_initialized=val,m_this):m_initialized},this.toLocal=function(input){return input},this.fromLocal=function(input){return input},this._init=function(){return m_initialized?m_this:(m_node=$(document.createElement("div")),m_node.attr("id",m_name),m_node.css("position","absolute"),m_map&&m_map.node().append(m_node),m_canvas?m_renderer=geo.createRenderer(m_rendererName,m_this,m_canvas):(m_renderer=geo.createRenderer(m_rendererName,m_this),m_canvas=m_renderer.canvas()),m_this.addChild(m_renderer),m_initialized=!0,m_this)},this._exit=function(){},this._update=function(){},this._resize=function(x,y,w,h){return m_x=x,m_y=y,m_width=w,m_height=h,m_node.width(w),m_node.height(h),m_this.modified(),m_this.trigger(geo.event.resize,{x:x,y:y,width:m_width,height:m_height}),m_this},this.width=function(){return m_width},this.height=function(){return m_height},this},inherit(geo.layer,geo.sceneObject),geo.featureLayer=function(arg){"use strict";if(!(this instanceof geo.featureLayer))return new geo.featureLayer(arg);geo.layer.call(this,arg);var m_this=this,m_features=[],s_init=this._init,s_update=this._update,s_draw=this.draw;return this.createFeature=function(featureName,arg){var newFeature=geo.createFeature(featureName,m_this,m_this.renderer(),arg);return m_this.addChild(newFeature),m_features.push(newFeature),m_this.features(m_features),m_this.modified(),newFeature},this.deleteFeature=function(feature){var i;for(i=0;i<m_features.length;i+=1)if(m_features[i]===feature)return m_features[i]._exit(),m_this.dataTime().modified(),m_this.modified(),m_features.splice(i,1),m_this;return m_this.removeChild(feature),m_this},this.features=function(val){return void 0===val?m_features:(m_features=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(){return m_this.initialized()?m_this:(s_init.call(m_this),m_this.on(geo.event.resize,function(event){m_this.renderer()._resize(event.x,event.y,event.width,event.height),m_this._update({}),m_this.renderer()._render()}),m_this.on(geo.event.pan,function(event){m_this._update({event:event}),m_this.renderer()._render()}),m_this.on(geo.event.zoom,function(event){m_this.map()&&m_this.map().zoom(event.curr_zoom),m_this._update({event:event}),m_this.renderer()._render()}),m_this)},this._update=function(request){var i;if(!m_features.length)return m_this;if(s_update.call(m_this,request),!m_this.source()&&m_features&&0===m_features.length)return void console.log("[info] No valid data source found.");if(m_this.dataTime().getMTime()>m_this.updateTime().getMTime())for(i=0;i<m_features.length;i+=1)m_features[i].renderer(m_this.renderer());for(i=0;i<m_features.length;i+=1)m_features[i]._update();return m_this.updateTime().modified(),m_this},this.draw=function(){return s_draw(),m_this.renderer()._render(),m_this},this.clear=function(){var i;if(!m_features.length)return m_this;for(i=0;i<m_features.length;i+=1)m_features[i]._exit();return m_this.dataTime().modified(),m_this.modified(),m_features=[],m_this},m_this},inherit(geo.featureLayer,geo.layer),geo.registerLayer("feature",geo.featureLayer),geo.event=function(){"use strict";return this instanceof geo.event?(vgl.event.call(this),this):new geo.event},inherit(geo.event,vgl.event),geo.event.update="geo.update",geo.event.opacityUpdate="geo.opacityUpdate",geo.event.layerAdd="geo.layerAdd",geo.event.layerRemove="geo.layerRemove",geo.event.layerToggle="geo.layerToggle",geo.event.layerSelect="geo.layerSelect",geo.event.layerUnselect="geo.layerUnselect",geo.event.zoom="geo.zoom",geo.event.center="geo.center",geo.event.pan="geo.pan",geo.event.rotate="geo.rotate",geo.event.resize="geo.resize",geo.event.animate="geo.animate",geo.event.query="geo.query",geo.event.draw="geo.draw",geo.event.drawEnd="geo.drawEnd",geo.event.animationPause="geo.animationPause",geo.event.animationStop="geo.animationStop",geo.event.animationComplete="geo.animationComplete",geo.time={},geo.time.incrementTime=function(time,unit,delta){"use strict";return"days"===unit?time.setDate(time.getDate()+delta):"months"===unit?time.setMonth(time.getMonth()+delta):"years"===unit?time.setYear(time.getYear()+delta):"index"===unit&&(time+=delta),time},geo.fileReader=function(arg){"use strict";function newFileReader(done,progress){var reader=new FileReader;return progress&&(reader.onprogress=progress),reader.onloadend=function(){reader.result||done(reader.error),done(reader.result)},reader}if(!(this instanceof geo.fileReader))return new geo.fileReader(arg);if(geo.object.call(this),arg=arg||{},!(arg.layer instanceof geo.featureLayer))throw"fileReader must be given a feature layer";var m_layer=arg.layer;return this.layer=function(){return m_layer},this.canRead=function(){return!1},this.read=function(file,done){done(!1)},this._getString=function(file,done,progress){var reader=newFileReader(done,progress);reader.readAsText(file)},this._getArrayBuffer=function(file,done,progress){var reader=newFileReader(done,progress);reader.readAsText(file)},this},inherit(geo.fileReader,geo.object),geo.jsonReader=function(arg){"use strict";if(!(this instanceof geo.jsonReader))return new geo.jsonReader(arg);var m_this=this,m_style=arg.style||{};geo.fileReader.call(this,arg),this.canRead=function(file){if(file instanceof File)return"application/json"===file.type||file.name.match(/\.json$/);if("string"==typeof file){try{JSON.parse(file)}catch(e){return!1}return!0}try{if(Array.isArray(m_this._featureArray(file)))return!0}catch(e){}return!1},this._readObject=function(file,done,progress){function onDone(fileString){"string"!=typeof fileString&&done(!1);try{object=JSON.parse(fileString)}catch(e){done(!1)}done(object)}var object;file instanceof File?m_this._getString(file,onDone,progress):"string"==typeof file?onDone(file):done(file)},this._featureArray=function(spec){if("FeatureCollection"===spec.type)return spec.features||[];if("GeometryCollection"===spec.type)throw"GeometryCollection not yet implemented.";if(Array.isArray(spec.coordinates))return spec;throw"Unsupported collection type: "+spec.type},this._featureType=function(spec){var geometry=spec.geometry||{};return"Point"===geometry.type||"MultiPoint"===geometry.type?"point":"LineString"===geometry.type?"line":null},this._getCoordinates=function(spec){var geometry=spec.geometry||{},coordinates=geometry.coordinates||[];return(2===coordinates.length||3===coordinates.length)&&isFinite(coordinates[0])&&isFinite(coordinates[1])?[geo.latlng(coordinates[1],coordinates[0])]:coordinates.map(function(c){return geo.latlng(c[1],c[0])})},this._getStyle=function(spec){return spec.properties||{}},this.read=function(file,done,progress){function _done(object){var features,allFeatures=[];features=m_this._featureArray(object),features.forEach(function(feature){var type=m_this._featureType(feature),coordinates=m_this._getCoordinates(feature),style=m_this._getStyle(feature);type?allFeatures.push(m_this._addFeature(type,coordinates,style)):console.log("unsupported feature type: "+feature.geometry.type)}),done&&done(allFeatures)}m_this._readObject(file,_done,progress)},this._addFeature=function(type,coordinates,style){var _style=$.extend({},m_style,style);return m_this.layer().createFeature(type).positions(coordinates).style(_style)}},inherit(geo.jsonReader,geo.fileReader),geo.registerFileReader("jsonReader",geo.jsonReader),geo.map=function(arg){"use strict";if(!(this instanceof geo.map))return new geo.map(arg);arg=arg||{},geo.sceneObject.call(this,arg),arg.layers=void 0===arg.layers?[]:arg.layers;var toMillis,calculateGlobalAnimationRange,cloneTimestep,m_pause,m_stop,m_this=this,m_x=0,m_y=0,m_node=$(arg.node),m_width=arg.width||m_node.width(),m_height=arg.height||m_node.height(),m_gcs=void 0===arg.gcs?"EPSG:4326":arg.gcs,m_uigcs=void 0===arg.uigcs?"EPSG:4326":arg.uigcs,m_center=void 0===arg.center?[0,0]:arg.center,m_zoom=void 0===arg.zoom?10:arg.zoom,m_baseLayer=null,m_animationState={range:null,timestep:null,layers:null},m_intervalMap={},m_fileReader=null;return m_intervalMap.milliseconds=1,m_intervalMap.seconds=1e3*m_intervalMap.milliseconds,m_intervalMap.minutes=60*m_intervalMap.seconds,m_intervalMap.hours=60*m_intervalMap.minutes,m_intervalMap.days=24*m_intervalMap.hours,m_intervalMap.weeks=7*m_intervalMap.days,m_intervalMap.months=4*m_intervalMap.weeks,m_intervalMap.years=12*m_intervalMap.months,this.on(geo.event.animationPause,function(){m_pause=!0}),this.on(geo.event.animationStop,function(){m_stop=!0}),toMillis=function(delta){var deltaLowercase=delta.toLowerCase();return m_intervalMap[deltaLowercase]},calculateGlobalAnimationRange=function(layers){var delta,deltaUnits,layerTimeRange,layerDelta,i,start=null,end=null,indexTimestep=!1,smallestDeltaInMillis=Number.MAX_VALUE;for(i=0;i<layers.length;i+=1)if(layerTimeRange=layers[i].timeRange()){if("index"===layerTimeRange.deltaUnits)indexTimestep=!0,layerDelta=layerTimeRange.delta;else{if(indexTimestep)throw"Can't mix index timesteps with time based timesteps";layerDelta=toMillis(layerTimeRange.deltaUnits)*layerTimeRange.delta}smallestDeltaInMillis>layerDelta&&(delta=layerTimeRange.delta,deltaUnits=layerTimeRange.deltaUnits,smallestDeltaInMillis=layerDelta),(null===start||layerTimeRange.start<start)&&(start=layerTimeRange.start),(null===end||layerTimeRange.end<end)&&(end=layerTimeRange.end)}return{start:start,end:end,delta:delta,deltaUnits:deltaUnits}},cloneTimestep=function(timestep){return timestep instanceof Date&&(timestep=new Date(timestep.getTime())),timestep},this.gcs=function(arg){return void 0===arg?m_gcs:(m_gcs=arg,m_this)},this.uigcs=function(){return m_uigcs},this.node=function(){return m_node},this.zoom=function(val){return void 0===val?m_zoom:(val!==m_zoom&&(m_zoom=val,m_this.modified()),m_this)},this.center=function(val){return void 0===val?m_center:(m_center=val.slice,m_this.modified(),m_this)},this.createLayer=function(layerName,arg){var newLayer=geo.createLayer(layerName,m_this,arg);return null===newLayer&&void 0===newLayer?null:(newLayer._resize(m_x,m_y,m_width,m_height),(newLayer.referenceLayer()||0===m_this.children().length)&&m_this.baseLayer(newLayer),m_this.addChild(newLayer),m_this.modified(),m_this.trigger(geo.event.layerAdd,{type:geo.event.layerAdd,target:m_this,layer:newLayer}),newLayer)},this.deleteLayer=function(layer){return null!==layer&&void 0!==layer&&(layer._exit(),m_this.removeChild(layer),m_this.modified(),m_this.trigger(geo.event.layerRemove,{type:geo.event.layerRemove,target:m_this,layer:layer})),layer},this.toggle=function(layer){return null!==layer&&void 0!==layer&&(layer.visible(!layer.visible()),m_this.modified(),m_this.trigger(geo.event.layerToggle,{type:geo.event.layerToggle,target:m_this,layer:layer})),m_this},this.resize=function(x,y,w,h){var i,layers=m_this.children();for(m_x=x,m_y=y,m_width=w,m_height=h,i=0;i<layers.length;i+=1)layers[i]._resize(x,y,w,h);return m_this.trigger(geo.event.resize,{type:geo.event.resize,target:m_this,x:m_x,y:m_y,width:w,height:h}),m_this.modified(),m_this},this.gcsToDisplay=function(input){var world,output;if(!(input instanceof Array&&input.length>0||input instanceof Object))throw"Conversion method latLonToDisplay does not handle "+input;return world=m_baseLayer.toLocal(input),output=m_baseLayer.renderer().worldToDisplay(world)},this.displayToGcs=function(input){var output;if(!(input instanceof Array&&input.length>0||input instanceof Object))throw"Conversion method latLonToDisplay does not handle "+input;return output=m_baseLayer.renderer().displayToWorld(input),output=m_baseLayer.fromLocal(output)},this.query=function(){},this.baseLayer=function(baseLayer){return void 0!==baseLayer?(m_gcs!==baseLayer.gcs()&&m_this.gcs(baseLayer.gcs()),m_baseLayer=baseLayer,m_baseLayer.referenceLayer(!0),m_this):m_baseLayer},this.draw=function(){var i,layers=m_this.children();for(m_this.trigger(geo.event.draw,{type:geo.event.draw,target:m_this}),m_this._update(),i=0;i<layers.length;i+=1)layers[i].draw();return m_this.trigger(geo.event.drawEnd,{type:geo.event.drawEnd,target:m_this}),m_this},this.animate=function(layers){var animationRange;if(layers=void 0===layers?m_this.children():layers,null===m_animationState.timestep){if(animationRange=calculateGlobalAnimationRange(layers),!animationRange.start||!animationRange.end)throw"Animation range could not be calculated. Check that layers have ranges associated with them";m_animationState={range:animationRange,timestep:cloneTimestep(animationRange.start),layers:layers}}return m_this._animate(),m_this},this.pauseAnimation=function(){return m_this.trigger(geo.event.animationPause),m_this},this.stopAnimation=function(){return m_this.trigger(geo.event.animationStop),m_animationState.timestep=null,m_this},this.stepAnimationForward=function(layers){var animationRange;return layers=void 0===layers?m_animationState.layers:layers,null===layers&&(layers=m_this.children()),null===m_animationState.timestep&&(animationRange=calculateGlobalAnimationRange(layers),m_animationState={range:animationRange,timestep:cloneTimestep(animationRange.start),layers:layers}),m_this._stepAnimationForward(),m_this},this.stepAnimationBackward=function(layers){var animationRange;return layers=void 0===layers?m_animationState.layers:layers,null===layers&&(layers=m_this.children()),null===m_animationState.timestep&&(animationRange=calculateGlobalAnimationRange(layers),m_animationState={range:animationRange,timestep:cloneTimestep(animationRange.end),layers:layers}),m_this._stepAnimationBackward(),m_this},this._animate=function(){function renderTimestep(){m_animationState.timestep>animationRange.end||m_stop?(clearInterval(id),m_animationState.timestep=null,m_this.trigger(geo.event.animationComplete)):m_pause?clearInterval(id):(m_this._animateTimestep(),m_animationState.timestep=geo.time.incrementTime(m_animationState.timestep,m_animationState.range.deltaUnits,m_animationState.range.delta))}var animationRange,nextTimestep,id;if(animationRange=m_animationState.range,nextTimestep=cloneTimestep(animationRange.start),m_stop=!1,m_pause=!1,nextTimestep=geo.time.incrementTime(nextTimestep,animationRange.deltaUnits,animationRange.delta),nextTimestep>animationRange.end)throw"Invalid time range";return id=setInterval(renderTimestep,10),m_this},this._animateTimestep=function(){return m_animationState&&($.each(m_animationState.layers,function(i,layer){var timestep=m_animationState.timestep;timestep instanceof Date&&(timestep=timestep.getTime()),layer._update({timestep:timestep})}),m_this.trigger(geo.event.animate,{timestep:m_animationState.timestep}),m_this.draw()),m_this},this._stepAnimationForward=function(){var nextTimestep;return null===m_animationState.timestep&&(m_animationState.timestep=cloneTimestep(m_animationState.range.start)),nextTimestep=cloneTimestep(m_animationState.timestep),nextTimestep=geo.time.incrementTime(nextTimestep,m_animationState.range.deltaUnits,m_animationState.range.delta),nextTimestep<=m_animationState.range.end&&(m_animationState.timestep=nextTimestep,m_this._animateTimestep()),m_this},this._stepAnimationBackward=function(){var previousTimestep;return null===m_animationState.timestep&&(m_animationState.timestep=cloneTimestep(m_animationState.range.end)),previousTimestep=cloneTimestep(m_animationState.timestep),previousTimestep=geo.time.incrementTime(previousTimestep,m_animationState.range.deltaUnits,-m_animationState.range.delta),previousTimestep<m_animationState.range.start?void 0:(m_animationState.timestep=previousTimestep,m_this._animateTimestep(),m_this)},this.fileReader=function(readerType,opts){var layer,renderer;return opts=opts||{},readerType?(layer=opts.layer,layer||(renderer=opts.renderer,renderer||(renderer="d3Renderer"),layer=m_this.createLayer("feature",{renderer:renderer})),opts.layer=layer,opts.renderer=renderer,m_fileReader=geo.createFileReader(readerType,opts),m_this):m_fileReader},this._init=function(arg){var i;if(void 0===m_node||null===m_node)throw"Map require DIV node";if(void 0!==arg&&void 0!==arg.layers)for(i=0;i<arg.layers.length;i+=1)0===i&&m_this.baseLayer(arg.layers[i]),m_this.addLayer(arg.layers[i]);return m_this},this._update=function(request){var i,layers=m_this.children();for(i=0;i<layers.length;i+=1)layers[i]._update(request);return m_this},this._exit=function(){var i,layers=m_this.children();for(i=0;i<layers.length;i+=1)layers[i]._exit()},this._init(arg),this.node().on("dragover",function(e){var evt=e.originalEvent;m_this.fileReader()&&(evt.stopPropagation(),evt.preventDefault(),evt.dataTransfer.dropEffect="copy")}).on("drop",function(e){function done(){m_this.draw()}var i,file,evt=e.originalEvent,reader=m_this.fileReader();if(reader)for(evt.stopPropagation(),evt.preventDefault(),i=0;i<evt.dataTransfer.files.length;i+=1)file=evt.dataTransfer.files[i],reader.canRead(file)&&reader.read(file,done)}),this},inherit(geo.map,geo.sceneObject),geo.feature=function(arg){"use strict";if(!(this instanceof geo.feature))return new geo.feature(arg);geo.sceneObject.call(this),arg=arg||{};var m_this=this,m_style={},m_layer=void 0===arg.layer?null:arg.layer,m_gcs=void 0===arg.gcs?"EPSG:4326":arg.gcs,m_visible=void 0===arg.visible?!0:arg.visible,m_bin=void 0===arg.bin?0:arg.bin,m_renderer=void 0===arg.renderer?null:arg.renderer,m_dataTime=geo.timestamp(),m_buildTime=geo.timestamp(),m_updateTime=geo.timestamp();return this.style=function(arg1,arg2){return void 0===arg1?m_style:void 0===arg2?(m_style=$.extend({},m_style,arg1),m_this.modified(),m_this):(m_style[arg1]=arg2,m_this.modified(),m_this)},this.layer=function(){return m_layer},this.renderer=function(){return m_renderer},this.drawables=function(){return m_this._drawables()},this.gcs=function(val){return void 0===val?m_gcs:(m_gcs=val,m_this.modified(),m_this)},this.visible=function(val){return void 0===val?m_visible:(m_visible=val,m_this.modified(),m_this)},this.bin=function(val){return void 0===val?m_bin:(m_bin=val,m_this.modified(),m_this)},this.dataTime=function(val){return void 0===val?m_dataTime:(m_dataTime=val,m_this.modified(),m_this)},this.buildTime=function(val){return void 0===val?m_buildTime:(m_buildTime=val,m_this.modified(),m_this)},this.updateTime=function(val){return void 0===val?m_updateTime:(m_updateTime=val,m_this.modified(),m_this)},this._init=function(arg){if(!m_layer)throw"Feature requires a valid layer";m_style=$.extend({},{opacity:1},void 0===arg.style?{}:arg.style)},this._build=function(){},this._drawables=function(){},this._update=function(){},this._exit=function(){},this._init(arg),this},inherit(geo.feature,geo.sceneObject),geo.pointFeature=function(arg){"use strict";if(!(this instanceof geo.pointFeature))return new geo.pointFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,m_positions=void 0===arg.positions?null:arg.positions,s_init=this._init;return this.positions=function(val){return void 0===val?m_positions:(m_positions=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{size:1,width:1,height:1,color:[1,1,1],point_sprites:!1,point_sprites_image:null},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_positions&&m_this.dataTime().modified()},m_this._init(arg),m_this},inherit(geo.pointFeature,geo.feature),geo.lineFeature=function(arg){"use strict";if(!(this instanceof geo.lineFeature))return new geo.lineFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,m_positions=void 0===arg.positions?[]:arg.positions,s_init=this._init;return this.positions=function(val){return void 0===val?m_positions:(m_positions=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_positions&&m_this.dataTime().modified()},this._init(arg),this},inherit(geo.lineFeature,geo.feature),geo.pathFeature=function(arg){"use strict";if(!(this instanceof geo.pathFeature))return new geo.pathFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,m_positions=void 0===arg.positions?[]:arg.positions,s_init=this._init;return this.positions=function(val){return void 0===val?m_positions:(m_positions=val.slice(0),m_this.dataTime().modified(),m_this.modified(),m_this)},this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{width:[1],color:[1,1,1],pattern:"solid"},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_positions&&m_this.dataTime().modified()},this._init(arg),this},inherit(geo.pathFeature,geo.feature),geo.polygonFeature=function(arg){"use strict";if(!(this instanceof geo.polygonFeature))return new geo.polygonFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_init=this._init;return this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend({},{color:[1,1,1],fill_color:[1,1,1],fill:!0},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle)},m_this._init(arg),m_this},inherit(geo.polygonFeature,geo.feature),geo.planeFeature=function(arg){"use strict";if(!(this instanceof geo.planeFeature))return new geo.planeFeature(arg);arg=arg||{},arg.ul=void 0===arg.ul?[0,1,0]:arg.ul,arg.lr=void 0===arg.lr?[1,0,0]:arg.lr,arg.depth=void 0===arg.depth?0:arg.depth,geo.polygonFeature.call(this,arg);var m_this=this,m_origin=[arg.ul.x,arg.lr.y,arg.depth],m_upperLeft=[arg.ul.x,arg.ul.y,arg.depth],m_lowerRight=[arg.lr.x,arg.lr.y,arg.depth],m_defaultDepth=arg.depth,m_drawOnAsyncResourceLoad=void 0===arg.drawOnAsyncResourceLoad?!0:!1,s_init=this._init;return this.origin=function(val){if(void 0===val)return m_origin;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_origin=val.slice(0),2===m_origin.length&&(m_origin[2]=m_defaultDepth)}else val instanceof geo.latlng&&(m_origin=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.upperLeft=function(val){if(void 0===val)return m_upperLeft;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_upperLeft=val.slice(0),2===m_upperLeft.length&&(m_upperLeft[2]=m_defaultDepth)}else val instanceof geo.latlng&&(m_upperLeft=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.lowerRight=function(val){if(void 0===val)return m_lowerRight;if(val instanceof Array){if(val.length>3||val.length<2)throw"Upper left point requires point in 2 or 3 dimension";m_lowerRight=val.slice(0),2===m_lowerRight.length&&(m_lowerRight[2]=m_defaultDepth),m_this.dataTime().modified()}else val instanceof geo.latlng&&(m_lowerRight=[val.x(),val.y(),m_defaultDepth]);return m_this.dataTime().modified(),m_this.modified(),m_this},this.drawOnAsyncResourceLoad=function(val){return void 0===val?m_drawOnAsyncResourceLoad:(m_drawOnAsyncResourceLoad=val,m_this)},this._init=function(arg){var style=null;s_init.call(m_this,arg),style=m_this.style(),void 0===style.image&&(style.image=null),m_this.style(style)},this._init(arg),this},inherit(geo.planeFeature,geo.polygonFeature),geo.geomFeature=function(arg){"use strict";return this instanceof geo.geomFeature?(arg=arg||{},geo.feature.call(this,arg),arg.style=void 0===arg.style?$.extend({},{color:[1,1,1],point_sprites:!1,point_sprites_image:null},arg.style):arg.style,this.style(arg.style),this):new geo.geomFeature(arg)},inherit(geo.geomFeature,geo.feature),geo.graphFeature=function(arg){"use strict";if(!(this instanceof geo.graphFeature))return new geo.graphFeature(arg);arg=arg||{},geo.feature.call(this,arg);var m_this=this,s_style=this.style,m_nodes=null,m_points=null,m_links=[],s_init=this._init,s_exit=this._exit;return this._init=function(arg){s_init.call(m_this,arg);var defaultStyle=$.extend(!0,{},{nodes:{size:5,color:[0,0,1]},links:{color:[1,1,1]},linkType:"path"},void 0===arg.style?{}:arg.style);m_this.style(defaultStyle),m_nodes&&m_this.dataTime().modified()},this._build=function(){m_this.children().forEach(function(child){child._build()})},this._update=function(){m_this.children().forEach(function(child){child._update()})},this._exit=function(){return m_this.nodes([]),m_points._exit(),m_this.removeChild(m_points),s_exit(),m_this},this.style=function(arg){var out=s_style.call(m_this,arg);return out!==m_this?out:(m_points.style(arg.nodes),m_links.forEach(function(l){l.style(arg.links)
}),m_this)},this.nodes=function(val){var style,layer=m_this.layer(),nLinks=0;return void 0===val?m_nodes:(style=m_this.style(),m_nodes=val.slice(0),m_points.positions(m_nodes),m_nodes.forEach(function(source){(source.children||[]).forEach(function(target){var link;nLinks+=1,m_links.length<nLinks&&(link=geo.createFeature(style.linkType,layer,layer.renderer()).style(style.links),m_this.addChild(link),m_links.push(link)),m_links[nLinks-1].positions([source,target])})}),m_links.splice(nLinks,m_links.length-nLinks).forEach(function(l){l._exit(),m_this.removeChild(l)}),m_this.dataTime().modified(),m_this.modified(),m_this)},this.nodeFeature=function(){return m_points},this.linkFeatures=function(){return m_links},m_points=geo.createFeature("point",this.layer(),this.layer().renderer()),m_this.addChild(m_points),arg.nodes&&this.nodes(arg.nodes),this._init(arg),this},inherit(geo.graphFeature,geo.feature),geo.transform={},geo.transform.osmTransformFeature=function(destGcs,feature,inplace){"use strict";if(!feature)return void console.log("[warning] Invalid (null) feature");if(feature.gcs()!==destGcs){if(!(feature instanceof geo.pointFeature||feature instanceof geo.lineFeature))throw"Supports only point or line feature";var i,yCoord,noOfComponents=null,pointOffset=0,count=null,inPos=null,outPos=null,srcGcs=feature.gcs();if(inplace=!!inplace,feature instanceof geo.pointFeature||feature instanceof geo.lineFeature){if("EPSG:4326"!==srcGcs&&geo.transform.transformFeature("EPSG:4326",feature,!0),inPos=feature.positions(),count=inPos.length,!(inPos instanceof Array))throw"Supports Array of 2D and 3D points";if(inPos.length>0&&inPos[0]instanceof geo.latlng?(noOfComponents=2,pointOffset=1):(noOfComponents=count%2===0?2:count%3===0?3:null,pointOffset=noOfComponents),2!==noOfComponents&&3!==noOfComponents)throw"Transform points require points in 2D or 3D";for(outPos=inplace?inPos:inPos.slice(0),i=0;count>i;i+=pointOffset)yCoord=inPos[i]instanceof geo.latlng?inPos[i].lat():inPos[i+1],yCoord>85.0511&&(yCoord=85.0511),-85.0511>yCoord&&(yCoord=-85.0511),inPos[i]instanceof geo.latlng?outPos[i]=geo.latlng(geo.mercator.lat2y(yCoord),outPos[i].lng()):outPos[i+1]=geo.mercator.lat2y(yCoord);return inplace&&(feature.positions(outPos),feature.gcs(destGcs)),outPos}return null}},geo.transform.transformFeature=function(destGcs,feature,inplace){"use strict";if(!feature)throw"Invalid (null) feature";if(!(feature instanceof geo.pointFeature||feature instanceof geo.lineFeature))throw"Supports only point or line feature";if(feature.gcs()===destGcs)return feature.positions();if("EPSG:3857"===destGcs)return geo.transform.osmTransformFeature(destGcs,feature,inplace);var i,noOfComponents=null,pointOffset=0,count=null,inPos=null,outPos=null,projPoint=null,srcGcs=feature.gcs(),projSrcGcs=new proj4.Proj(srcGcs),projDestGcs=new proj4.Proj(destGcs);if(inplace=!!inplace,feature instanceof geo.pointFeature||feature instanceof geo.lineFeature){if(inPos=feature.positions(),count=inPos.length,!(inPos instanceof Array))throw"Supports Array of 2D and 3D points";if(inPos.length>0&&inPos[0]instanceof geo.latlng?(noOfComponents=2,pointOffset=1):(noOfComponents=count%2===0?2:count%3===0?3:null,pointOffset=noOfComponents),2!==noOfComponents&&3!==noOfComponents)throw"Transform points require points in 2D or 3D";for(inplace?outPos=inPos:(outPos=[],outPos.length=inPos.length),i=0;count>i;i+=pointOffset)projPoint=2===noOfComponents?new proj4.Point(inPos[i],inPos[i+1],0):new proj4.Point(inPos[i],inPos[i+1],inPos[i+2]),proj4.transform(projSrcGcs,projDestGcs,projPoint),2===noOfComponents?(outPos[i]=projPoint.x,outPos[i+1]=projPoint.y):(outPos[i]=projPoint.x,outPos[i+1]=projPoint.y,outPos[i+2]=projPoint.z);return inplace&&(feature.positions(outPos),feature.gcs(destGcs)),outPos}return null},geo.transform.transformLayer=function(destGcs,layer,baseLayer){"use strict";var features,count,i;if(!layer)throw"Requires valid layer for tranformation";if(!baseLayer)throw"Requires baseLayer used by the map";if(layer!==baseLayer){if(!(layer instanceof geo.featureLayer))throw"Only feature layer transformation is supported";for(features=layer.features(),count=features.length,i=0,i=0;count>i;i+=1)"EPSG:3857"===destGcs&&baseLayer instanceof geo.osmLayer?geo.transform.osmTransformFeature(destGcs,features[i],!0):geo.transform.transformFeature(destGcs,features[i],!0);layer.gcs(destGcs)}},geo.transform.transformCoordinates=function(srcGcs,destGcs,coordinates,numberOfComponents){"use strict";function handleLatLngCoordinates(){coordinates[0]&&coordinates[0]instanceof geo.latlng?(xAcc=function(index){return coordinates[index].x()},yAcc=function(index){return coordinates[index].y()},writer=function(index,x,y){output[index]=geo.latlng(y,x)}):(xAcc=function(){return coordinates.x()},yAcc=function(){return coordinates.y()},writer=function(index,x,y){output=geo.latlng(y,x)})}function handleArrayCoordinates(){if(coordinates[0]instanceof Array)if(2===coordinates[0].length)xAcc=function(index){return coordinates[index][0]},yAcc=function(index){return coordinates[index][1]},writer=function(index,x,y){output[index]=[x,y]};else{if(3!==coordinates[0].length)throw"Invalid coordinates. Requires two or three components per array";xAcc=function(index){return coordinates[index][0]},yAcc=function(index){return coordinates[index][1]},zAcc=function(index){return coordinates[index][2]},writer=function(index,x,y,z){output[index]=[x,y,z]}}else if(2===coordinates.length)offset=2,xAcc=function(index){return coordinates[index*offset]},yAcc=function(index){return coordinates[index*offset+1]},writer=function(index,x,y){output[index]=x,output[index+1]=y};else if(3===coordinates.length)offset=3,xAcc=function(index){return coordinates[index*offset]},yAcc=function(index){return coordinates[index*offset+1]},zAcc=function(index){return coordinates[index*offset+2]},writer=function(index,x,y,z){output[index]=x,output[index+1]=y,output[index+2]=z};else{if(!numberOfComponents)throw"Invalid coordinates";offset=numberOfComponents,xAcc=function(index){return coordinates[index]},yAcc=function(index){return coordinates[index+1]},2===numberOfComponents?writer=function(index,x,y){output[index]=x,output[index+1]=y}:(zAcc=function(index){return coordinates[index+2]},writer=function(index,x,y,z){output[index]=x,output[index+1]=y,output[index+2]=z})}}function handleObjectCoordinates(){if(coordinates[0]&&"x"in coordinates[0]&&"y"in coordinates[0])xAcc=function(index){return coordinates[index].x},yAcc=function(index){return coordinates[index].y},"z"in coordinates[0]?(zAcc=function(index){return coordinates[index].z},writer=function(index,x,y,z){output[i]={x:x,y:y,z:z}}):writer=function(index,x,y){output[index]={x:x,y:y}};else{if(!(coordinates&&"x"in coordinates&&"y"in coordinates))throw"Invalid coordinates";xAcc=function(){return coordinates.x},yAcc=function(){return coordinates.y},"z"in coordinates?(zAcc=function(){return coordinates.z},writer=function(index,x,y,z){output={x:x,y:y,z:z}}):writer=function(index,x,y){output={x:x,y:y}}}}var i,count,offset,xCoord,yCoord,zCoord,xAcc,yAcc,zAcc,writer,output,projPoint,projSrcGcs=new proj4.Proj(srcGcs),projDestGcs=new proj4.Proj(destGcs);if(zAcc=function(){return 0},destGcs===srcGcs)return coordinates;if(!destGcs||!srcGcs)throw"Invalid source or destination GCS";if(coordinates instanceof Array)output=[],output.length=coordinates.length,count=coordinates.length,coordinates[0]instanceof Array||coordinates[0]instanceof geo.latlng||coordinates[0]instanceof Object?(offset=1,coordinates[0]instanceof Array?handleArrayCoordinates():coordinates[0]instanceof geo.latlng?handleLatLngCoordinates():coordinates[0]instanceof Object&&handleObjectCoordinates()):handleArrayCoordinates();else if(coordinates&&coordinates instanceof Object)if(count=1,offset=1,coordinates instanceof geo.latlng)handleLatLngCoordinates();else{if(!(coordinates&&"x"in coordinates&&"y"in coordinates))throw"Coordinates are not valid";handleObjectCoordinates()}if("EPSG:3857"===destGcs&&"EPSG:4326"===srcGcs){for(i=0;count>i;i+=offset)xCoord=xAcc(i),yCoord=yAcc(i),zCoord=zAcc(i),yCoord>85.0511&&(yCoord=85.0511),-85.0511>yCoord&&(yCoord=-85.0511),writer(i,xCoord,geo.mercator.lat2y(yCoord),zCoord);return output}for(i=0;count>i;i+=offset)return projPoint=new proj4.Point(xAcc(i),yAcc(i),zAcc(i)),proj4.transform(projSrcGcs,projDestGcs,projPoint),writer(i,projPoint.x,projPoint.y,projPoint.z),output},geo.renderer=function(arg){"use strict";if(!(this instanceof geo.renderer))return new geo.renderer(arg);geo.sceneObject.call(this),arg=arg||{};var m_this=this,m_layer=void 0===arg.layer?null:arg.layer,m_canvas=void 0===arg.canvas?null:arg.canvas,m_initialized=!1;return this.layer=function(){return m_layer},this.canvas=function(val){return void 0===val?m_canvas:(m_canvas=val,void m_this.modified())},this.map=function(){return m_layer?m_layer.map():null},this.baseLayer=function(){return m_this.map()?m_this.map().baseLayer():void 0},this.initialized=function(val){return void 0===val?m_initialized:(m_initialized=val,m_this)},this.api=function(){throw"Should be implemented by derivied classes"},this.reset=function(){return!0},this.worldToGcs=function(){throw"Should be implemented by derivied classes"},this.displayToGcs=function(){throw"Should be implemented by derivied classes"},this.gcsToDisplay=function(){throw"Should be implemented by derivied classes"},this.worldToDisplay=function(){throw"Should be implemented by derivied classes"},this.displayToWorld=function(){throw"Should be implemented by derivied classes"},this.relMouseCoords=function(event){var totalOffsetX=0,totalOffsetY=0,canvasX=0,canvasY=0,currentElement=m_this.canvas();do totalOffsetX+=currentElement.offsetLeft-currentElement.scrollLeft,totalOffsetY+=currentElement.offsetTop-currentElement.scrollTop,currentElement=currentElement.offsetParent;while(currentElement);return canvasX=event.pageX-totalOffsetX,canvasY=event.pageY-totalOffsetY,{x:canvasX,y:canvasY}},this._init=function(){},this._resize=function(){},this._render=function(){},this._exit=function(){},this._connectMouseEvents=function(){},this},inherit(geo.renderer,geo.sceneObject),geo.osmLayer=function(arg){"use strict";function getModifiedMapZoom(){return m_this.map().zoom()<18?m_this.map().zoom()+1:m_this.map().zoom()}function isTileVisible(tile){return tile.zoom in m_visibleTilesRange&&tile.index_x>=m_visibleTilesRange[tile.zoom].startX&&tile.index_x<=m_visibleTilesRange[tile.zoom].endX&&tile.index_y>=m_visibleTilesRange[tile.zoom].startY&&tile.index_y<=m_visibleTilesRange[tile.zoom].endY?!0:!1}function drawTiles(){m_this._removeTiles(),m_this.draw(),delete m_pendingNewTilesStat[m_updateTimerId]}function updateOSMTiles(request){void 0===request&&(request={});var zoom=getModifiedMapZoom();m_lastVisibleZoom||(m_lastVisibleZoom=zoom),m_this._addTiles(request),m_lastVisibleZoom!==zoom&&(m_lastVisibleZoom=zoom),m_this.updateTime().modified()}if(!(this instanceof geo.osmLayer))return new geo.osmLayer(arg);geo.featureLayer.call(this,arg);var m_this=this,m_tiles={},m_hiddenBinNumber=0,m_lastVisibleBinNumber=999,m_visibleBinNumber=1e3,m_pendingNewTiles=[],m_pendingInactiveTiles=[],m_numberOfCachedTiles=0,m_tileCacheSize=100,m_baseUrl="http://tile.openstreetmap.org/",m_imageFormat="png",m_updateTimerId=null,m_lastVisibleZoom=null,m_visibleTilesRange={},s_init=this._init,m_pendingNewTilesStat={},s_update=this._update,m_updateDefer=null;return arg&&void 0!==arg.baseUrl&&(m_baseUrl=arg.baseUrl),arg&&void 0!==arg.imageFormat&&(m_imageFormat=arg.imageFormat),this.tileCacheSize=function(val){return void 0===val?m_tileCacheSize:(m_tileCacheSize=val,void m_this.modified())},this.toLocal=function(input){var i,output,delta;if(input instanceof Array&&input.length>0)if(output=[],output.length=input.length,input[0]instanceof geo.latlng)for(i=0;i<input.length;i+=1)output[i]=geo.latlng(input[i]),output[i].lat(geo.mercator.lat2y(output[i].lat()));else if(input[0]instanceof Array)if(delta=input%3===0?3:2,2===delta)for(i=0;i<input.length;i+=delta)output[i]=input[i],output[i+1]=geo.mercator.lat2y(input[i+1]);else for(i=0;i<input.length;i+=delta)output[i]=input[i],output[i+1]=geo.mercator.lat2y(input[i+1]),output[i+2]=input[i+2];else input[0]instanceof Object&&"x"in input[0]&&"y"in input[0]&&"z"in input[0]?output[i]={x:input[i].x,y:geo.mercator.lat2y(input[i].y),z:input[i].z}:input[0]instanceof Object&&"x"in input[0]&&"y"in input[0]&&"z"in input[0]?output[i]={x:input[i].x,y:geo.mercator.lat2y(input[i].y)}:input.length>=2&&(output=input.slice(0),output[1]=geo.mercator.lat2y(input[1]));else input instanceof geo.latlng?(output={},output.x=input.x(),output.y=geo.mercator.lat2y(input.y())):(output={},output.x=input.x,output.y=geo.mercator.lat2y(input.y));return output},this.fromLocal=function(input){var i,output;if(input instanceof Array&&input.length>0)if(output=[],output.length=input.length,input[0]instanceof Object)for(i=0;i<input.length;i+=1)output[i]={},output[i].x=input[i].x,output[i].y=geo.mercator.y2lat(input[i].y);else if(input[0]instanceof Array)for(i=0;i<input.length;i+=1)output[i]=input[i],output[i][1]=geo.mercator.y2lat(input[i][1]);else for(i=0;i<input.length;i+=1)output[i]=input[i],output[i+1]=geo.mercator.y2lat(input[i+1]);else output={},output.x=input.x,output.y=geo.mercator.y2lat(input.y);return output},this._hasTile=function(zoom,x,y){return m_tiles[zoom]&&m_tiles[zoom][x]&&m_tiles[zoom][x][y]?!0:!1},this._addTile=function(request,zoom,x,y){if(m_tiles[zoom]||(m_tiles[zoom]={}),m_tiles[zoom][x]||(m_tiles[zoom][x]={}),!m_tiles[zoom][x][y]){var noOfTilesX=Math.max(1,Math.pow(2,zoom)),noOfTilesY=Math.max(1,Math.pow(2,zoom)),totalLatDegrees=360,lonPerTile=360/noOfTilesX,latPerTile=totalLatDegrees/noOfTilesY,llx=-180+x*lonPerTile,lly=.5*-totalLatDegrees+y*latPerTile,urx=-180+(x+1)*lonPerTile,ury=.5*-totalLatDegrees+(y+1)*latPerTile,tile=new Image;return tile.LOADING=!0,tile.LOADED=!1,tile.REMOVED=!1,tile.REMOVING=!1,tile.crossOrigin="anonymous",tile.zoom=zoom,tile.index_x=x,tile.index_y=y,tile.llx=llx,tile.lly=lly,tile.urx=urx,tile.ury=ury,tile.lastused=new Date,tile.src=m_baseUrl+zoom+"/"+x+"/"+(Math.pow(2,zoom)-1-y)+"."+m_imageFormat,m_tiles[zoom][x][y]=tile,m_pendingNewTiles.push(tile),m_numberOfCachedTiles+=1,tile}},this._removeTiles=function(){var i,x,y,tile,zoom,currZoom=getModifiedMapZoom(),lastZoom=m_lastVisibleZoom;if(!m_tiles)return m_this;for(zoom in m_tiles)for(x in m_tiles[zoom])for(y in m_tiles[zoom][x])tile=m_tiles[zoom][x][y],tile&&(tile.REMOVING=!0,m_pendingInactiveTiles.push(tile));for(m_pendingInactiveTiles.sort(function(a,b){return a.lastused-b.lastused}),i=0;m_numberOfCachedTiles>m_tileCacheSize&&i<m_pendingInactiveTiles.length;)tile=m_pendingInactiveTiles[i],isTileVisible(tile)?i+=1:(m_this.deleteFeature(tile.feature),delete m_tiles[tile.zoom][tile.index_x][tile.index_y],m_pendingInactiveTiles.splice(i,1),m_numberOfCachedTiles-=1);for(i=0;i<m_pendingInactiveTiles.length;i+=1)tile=m_pendingInactiveTiles[i],tile.REMOVING=!1,tile.REMOVED=!1,tile.zoom!==currZoom&&tile.zoom===lastZoom?tile.feature.bin(m_lastVisibleBinNumber):tile.zoom!==currZoom?tile.feature.bin(m_hiddenBinNumber):(tile.lastused=new Date,tile.feature.bin(m_visibleBinNumber)),tile.feature._update();return m_pendingInactiveTiles=[],m_this},this._addTiles=function(request){function tileOnLoad(tile){var defer=$.Deferred();return m_this.addDeferred(defer),function(){tile.LOADING=!1,tile.LOADED=!0,(tile.REMOVING||tile.REMOVED)&&tile.feature&&tile.zoom!==getModifiedMapZoom()?(tile.feature.bin(m_hiddenBinNumber),tile.REMOVING=!1,tile.REMOVED=!0):(tile.REMOVED=!1,tile.lastused=new Date,tile.feature.bin(m_visibleBinNumber)),tile.updateTimerId===m_updateTimerId&&m_updateTimerId in m_pendingNewTilesStat?(tile.feature.bin(m_visibleBinNumber),m_pendingNewTilesStat[m_updateTimerId].count+=1):(tile.REMOVED=!0,tile.feature.bin(m_hiddenBinNumber)),tile.feature._update(),m_updateTimerId in m_pendingNewTilesStat&&m_pendingNewTilesStat[m_updateTimerId].count>=m_pendingNewTilesStat[m_updateTimerId].total&&drawTiles(),defer.resolve()}}var feature,lastStartX,lastStartY,lastEndX,lastEndY,currStartX,currStartY,currEndX,currEndY,ren=m_this.renderer(),zoom=getModifiedMapZoom(),llx=0,lly=m_this.height(),urx=m_this.width(),ury=0,temp=null,tile=null,tile1x=null,tile1y=null,tile2x=null,tile2y=null,invJ=null,i=0,j=0,worldPt1=ren.displayToWorld([llx,lly]),worldPt2=ren.displayToWorld([urx,ury]);for(worldPt1[0]=Math.max(worldPt1[0],-180),worldPt1[0]=Math.min(worldPt1[0],180),worldPt1[1]=Math.max(worldPt1[1],-180),worldPt1[1]=Math.min(worldPt1[1],180),worldPt2[0]=Math.max(worldPt2[0],-180),worldPt2[0]=Math.min(worldPt2[0],180),worldPt2[1]=Math.max(worldPt2[1],-180),worldPt2[1]=Math.min(worldPt2[1],180),tile1x=geo.mercator.long2tilex(worldPt1[0],zoom),tile1y=geo.mercator.lat2tiley(worldPt1[1],zoom),tile2x=geo.mercator.long2tilex(worldPt2[0],zoom),tile2y=geo.mercator.lat2tiley(worldPt2[1],zoom),tile1x=Math.max(tile1x,0),tile1x=Math.min(Math.pow(2,zoom)-1,tile1x),tile1y=Math.max(tile1y,0),tile1y=Math.min(Math.pow(2,zoom)-1,tile1y),tile2x=Math.max(tile2x,0),tile2x=Math.min(Math.pow(2,zoom)-1,tile2x),tile2y=Math.max(tile2y,0),tile2y=Math.min(Math.pow(2,zoom)-1,tile2y),tile1x>tile2x&&(temp=tile1x,tile1x=tile2x,tile2x=temp),tile2y>tile1y&&(temp=tile1y,tile1y=tile2y,tile2y=temp),currStartX=tile1x,currEndX=tile2x,currStartY=Math.pow(2,zoom)-1-tile1y,currEndY=Math.pow(2,zoom)-1-tile2y,currStartY>currEndY&&(temp=currStartY,currStartY=currEndY,currEndY=temp),lastStartX=geo.mercator.long2tilex(worldPt1[0],m_lastVisibleZoom),lastStartY=geo.mercator.lat2tiley(worldPt1[1],m_lastVisibleZoom),lastEndX=geo.mercator.long2tilex(worldPt2[0],m_lastVisibleZoom),lastEndY=geo.mercator.lat2tiley(worldPt2[1],m_lastVisibleZoom),lastStartY=Math.pow(2,m_lastVisibleZoom)-1-lastStartY,lastEndY=Math.pow(2,m_lastVisibleZoom)-1-lastEndY,lastStartY>lastEndY&&(temp=lastStartY,lastStartY=lastEndY,lastEndY=temp),m_visibleTilesRange={},m_visibleTilesRange[zoom]={startX:currStartX,endX:currEndX,startY:currStartY,endY:currEndY},m_visibleTilesRange[m_lastVisibleZoom]={startX:lastStartX,endX:lastEndX,startY:lastStartY,endY:lastEndY},m_pendingNewTilesStat[m_updateTimerId]={total:(tile2x-tile1x+1)*(tile1y-tile2y+1),count:0},i=tile1x;tile2x>=i;i+=1)for(j=tile2y;tile1y>=j;j+=1)invJ=Math.pow(2,zoom)-1-j,m_this._hasTile(zoom,i,invJ)?(tile=m_tiles[zoom][i][invJ],tile.feature.bin(m_visibleBinNumber),tile.LOADED&&m_updateTimerId in m_pendingNewTilesStat&&(m_pendingNewTilesStat[m_updateTimerId].count+=1),tile.lastused=new Date,tile.feature._update()):tile=m_this._addTile(request,zoom,i,invJ),tile.updateTimerId=m_updateTimerId;for(i=0;i<m_pendingNewTiles.length;i+=1)tile=m_pendingNewTiles[i],feature=m_this.createFeature("plane",{drawOnAsyncResourceLoad:!1,onload:tileOnLoad(tile)}).origin([tile.llx,tile.lly]).upperLeft([tile.llx,tile.ury]).lowerRight([tile.urx,tile.lly]).gcs("EPSG:3857").style("image",tile),tile.feature=feature,tile.feature._update();m_pendingNewTiles=[],m_updateTimerId in m_pendingNewTilesStat&&m_pendingNewTilesStat[m_updateTimerId].count>=m_pendingNewTilesStat[m_updateTimerId].total&&drawTiles()},this._updateTiles=function(request){var defer=$.Deferred();return m_this.addDeferred(defer),null!==m_updateTimerId?(clearTimeout(m_updateTimerId),m_updateDefer.resolve(),m_updateDefer=defer,m_updateTimerId in m_pendingNewTilesStat&&delete m_pendingNewTilesStat[m_updateTimerId],m_updateTimerId=setTimeout(function(){updateOSMTiles(request),m_updateDefer.resolve()},100)):(m_updateDefer=defer,m_updateTimerId=setTimeout(function(){updateOSMTiles(request),m_updateDefer.resolve()},0)),m_this},this._init=function(){return s_init.call(m_this),this.gcs("EPSG:3857"),m_this},this._update=function(request){m_this._updateTiles(request),s_update.call(m_this,request)},this},inherit(geo.osmLayer,geo.featureLayer),geo.registerLayer("osm",geo.osmLayer),ggl=ogs.namespace("geo.gl"),ggl.renderer=function(arg){"use strict";return this instanceof ggl.renderer?(geo.renderer.call(this,arg),this.contextRenderer=function(){throw"Should be implemented by derived classes"},this):new ggl.renderer(arg)},inherit(ggl.renderer,geo.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),ggl.lineFeature=function(arg){"use strict";if(!(this instanceof ggl.lineFeature))return new ggl.lineFeature(arg);arg=arg||{},geo.lineFeature.call(this,arg);var m_this=this,m_actor=null,s_init=this._init,s_update=this._update;return this._init=function(arg){s_init.call(m_this,arg)},this._build=function(){var style=m_this.style();m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),m_actor=vgl.utils.createLines(m_this.positions(),style.colors),m_this.renderer().contextRenderer().addActor(m_actor),m_this.buildTime().modified()},this._update=function(){var style=m_this.style();s_update.call(m_this),m_this.dataTime().getMTime()>=m_this.buildTime().getMTime()&&m_this._build(),m_this.updateTime().getMTime()<=m_this.getMTime()&&(m_this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(m_this.material(),m_this.style.color),m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin()),style.size&&m_actor.material().shaderProgram().uniform("pointSize").set(style.size)),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor)},this._init(arg),this},inherit(ggl.lineFeature,geo.lineFeature),geo.registerFeature("vgl","line",ggl.lineFeature),ggl.pointFeature=function(arg){"use strict";if(!(this instanceof ggl.pointFeature))return new ggl.pointFeature(arg);arg=arg||{},geo.pointFeature.call(this,arg);var m_this=this,m_actor=null,s_init=this._init,s_update=this._update;return this._init=function(arg){s_init.call(m_this,arg)},this._build=function(){var style=m_this.style(),positions=geo.transform.transformFeature(m_this.renderer().map().gcs(),m_this,!1);if(m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),style.point_sprites===!0){if(null===style.point_sprites_image)throw"[error] Invalid image for point sprites";m_actor=vgl.utils.createPointSprites(style.point_sprites_image,positions,style.colors)}else m_actor=vgl.utils.createPoints(positions,style.colors);m_this.renderer().contextRenderer().addActor(m_actor),m_this.buildTime().modified()},this._update=function(){var style=m_this.style();if(s_update.call(m_this),m_this.dataTime().getMTime()>=m_this.buildTime().getMTime()&&m_this._build(),m_this.updateTime().getMTime()<=m_this.getMTime())if(m_this.style.color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(m_this.material(),m_this.style.color),style.point_sprites===!0){if(null===style.point_sprites_image)throw"[error] Invalid image for point sprites";style.width&&style.height?m_actor.material().shaderProgram().uniform("pointSize").set([style.width,style.height]):style.size&&m_actor.material().shaderProgram().uniform("pointSize").set([style.size,style.size])}else style.size&&m_actor.material().shaderProgram().uniform("pointSize").set(style.size);m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor)},this._init(arg),this},inherit(ggl.pointFeature,geo.pointFeature),geo.registerFeature("vgl","point",ggl.pointFeature),ggl.geomFeature=function(arg){"use strict";if(!(this instanceof ggl.geomFeature))return new ggl.geomFeature(arg);arg=arg||{},geo.geomFeature.call(this,arg);var m_this=this,m_geom=arg.geom||null,m_actor=vgl.actor(),m_mapper=vgl.mapper(),m_material=null,m_scalar=null,m_color=arg.color||[1,1,1],m_buildTime=null,m_noOfPrimitives=0;return this._build=function(){var style=m_this.style();null!==m_geom&&(m_scalar=m_geom.sourceData(vgl.vertexAttributeKeys.Scalar),m_color=m_geom.sourceData(vgl.vertexAttributeKeys.Color),m_mapper.setGeometryData(m_geom)),this.setMapper(m_mapper),void 0!==style.point_sprites&&style.point_sprites&&void 0!==style.point_sprites_image&&null!==style.point_sprites_image&&1===m_noOfPrimitives&&m_geom.primitive(0).primitiveType()===gl.POINTS?m_material=vgl.utils.createPointSpritesMaterial(style.point_sprites_image):m_scalar?m_color instanceof vgl.lookupTable?(m_color.updateRange(m_scalar.scalarRange()),m_material=vgl.utils.createColorMappedMaterial(m_color)):(m_color=vgl.lookupTable(),m_color.updateRange(m_scalar.scalarRange()),m_material=vgl.utils.createColorMappedMaterial(m_color)):m_material=m_color?vgl.utils.createColorMaterial():vgl.utils.createSolidColorMaterial(),m_actor.setMaterial(m_material)},this._update=function(){m_buildTime&&m_buildTime.getMTime()<m_this.getMTime()?m_color instanceof vgl.lookupTable&&vgl.utils.updateColorMappedMaterial(m_this.material(),m_this.style.color):(m_buildTime=vgl.timestamp(),m_buildTime.modified())},this.geometry=function(val){return void 0===val?m_geom:(m_geom=val,m_this.modified(),m_this)},this},inherit(ggl.geomFeature,geo.geomFeature),ggl.planeFeature=function(arg){"use strict";if(!(this instanceof ggl.planeFeature))return new ggl.planeFeature(arg);geo.planeFeature.call(this,arg);var m_this=this,m_actor=null,m_onloadCallback=void 0===arg.onload?null:arg.onload;return this.coords=function(){return[m_this.origin(),m_this.upperLeft(),m_this.lowerRight()]},this._build=function(){var or=m_this.origin(),ul=m_this.upperLeft(),lr=m_this.lowerRight(),img=m_this.style().image,image=null,texture=null;or=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),or),ul=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),ul),lr=geo.transform.transformCoordinates(m_this.gcs(),m_this.layer().map().gcs(),lr),m_this.buildTime().modified(),m_actor&&m_this.renderer().contextRenderer().removeActor(m_actor),img&&img instanceof Image?image=img:img&&(image=new Image,image.src=img),image?(m_actor=vgl.utils.createTexturePlane(or[0],or[1],or[2],lr[0],lr[1],lr[2],ul[0],ul[1],ul[2],!0),texture=vgl.texture(),m_this.visible(!1),m_this.renderer().contextRenderer().addActor(m_actor),image.complete?(texture.setImage(image),m_actor.material().addAttribute(texture),m_this.visible(!0),m_onloadCallback&&m_onloadCallback.call(m_this)):image.onload=function(){texture.setImage(image),m_actor.material().addAttribute(texture),m_this.visible(!0),m_onloadCallback&&m_onloadCallback.call(m_this),m_this.drawOnAsyncResourceLoad()&&(m_this._update(),m_this.layer()._draw())}):(m_actor=vgl.utils.createPlane(or[0],or[1],or[2],ul[0],ul[1],ul[2],lr[0],lr[1],lr[2]),m_this.renderer().contextRenderer().addActor(m_actor))},this._update=function(){m_this.buildTime().getMTime()<=m_this.dataTime().getMTime()&&m_this._build(),m_this.updateTime().getMTime()<=m_this.getMTime()&&(m_actor.setVisible(m_this.visible()),m_actor.material().setBinNumber(m_this.bin())),m_this.updateTime().modified()},this._exit=function(){m_this.renderer().contextRenderer().removeActor(m_actor)},this},inherit(ggl.planeFeature,geo.planeFeature),geo.registerFeature("vgl","plane",ggl.planeFeature),ggl.mapInteractorStyle=function(){"use strict";function computeZoomLevel(){var i,pos=m_camera.position(),width=pos[2]*Math.sin(m_camera.viewAngle());for(i=0;20>i;i+=1)if(width>=360/Math.pow(2,i))return i}function computeCameraDistance(zoomLevel){var deg=360/Math.pow(2,zoomLevel);return deg/Math.sin(m_camera.viewAngle())}if(!(this instanceof ggl.mapInteractorStyle))return new ggl.mapInteractorStyle;vgl.interactorStyle.call(this);var m_map,m_drawRegionLayer,m_clickLatLng,m_width,m_height,m_renderer,m_renderWindow,m_camera,m_outsideCanvas,m_focusDisplayPoint,m_zTrans,m_coords,m_this=this,m_leftMouseButtonDown=!1,m_rightMouseButtonDown=!1,m_middileMouseButtonDown=!1,m_initRightBtnMouseDown=!1,m_drawRegionMode=!1,m_currentMousePos={x:0,y:0},m_lastMousePos={x:0,y:0},m_useLastDirection=!1,m_lastDirection=null,m_picker=new vgl.picker,m_updateRenderParamsTime=vgl.timestamp();return this.map=function(val){return void 0!==val?(m_map=val,m_this):m_map},this.drawRegionMode=function(val){return void 0!==val?(m_drawRegionMode=val,m_drawRegionLayer&&m_drawRegionLayer.setVisible(val),m_map.draw(),m_this):m_drawRegionMode},this._panCamera=function(renderer){var worldPt1,worldPt2,dx,dy,dz,focusDisplayPoint=renderer.focusDisplayPoint();worldPt1=m_renderWindow.displayToWorld(m_currentMousePos.x,m_currentMousePos.y,focusDisplayPoint,renderer),worldPt2=m_renderWindow.displayToWorld(m_lastMousePos.x,m_lastMousePos.y,focusDisplayPoint,renderer),dx=worldPt1[0]-worldPt2[0],dy=worldPt1[1]-worldPt2[1],dz=worldPt1[2]-worldPt2[2],renderer.camera().pan(-dx,-dy,-dz)},this.handleMouseMove=function(event){var mouseWorldPoint,lastWorldPos,currWorldPos,evt,i,renderers;if(m_this.updateRenderParams(),m_this._computeCurrentMousePos(event),m_outsideCanvas===!0)return!0;if(m_leftMouseButtonDown)if(m_drawRegionMode)mouseWorldPoint=m_map.displayToMap(m_currentMousePos.x,m_currentMousePos.y),m_this.setDrawRegion(m_clickLatLng.lat(),m_clickLatLng.lng(),mouseWorldPoint.y,mouseWorldPoint.x);else{for(lastWorldPos=m_camera.position(),renderers=m_renderWindow.renderers(),i=0;i<renderers.length;i+=1)m_this._panCamera(renderers[i]);currWorldPos=m_camera.position(),evt={type:geo.event.pan,last_display_pos:m_lastMousePos,curr_display_pos:m_currentMousePos,last_world_pos:lastWorldPos,curr_world_pos:currWorldPos},$(m_this).trigger(evt)}return m_rightMouseButtonDown&&m_height>0&&(null!==m_lastDirection&&(m_useLastDirection=!0),m_this.zoom()),m_lastMousePos.x=m_currentMousePos.x,m_lastMousePos.y=m_currentMousePos.y,!1},this.handleMouseDown=function(event){var point;return m_this.updateRenderParams(),m_this._computeCurrentMousePos(event),0===event.button&&(m_leftMouseButtonDown=!0),1===event.button&&(m_middileMouseButtonDown=!0),2===event.button&&(m_rightMouseButtonDown=!0),m_coords=m_this.viewer().relMouseCoords(event),m_lastMousePos.x=m_coords.x<0?0:m_coords.x,m_lastMousePos.y=m_coords.y<0?0:m_coords.y,m_drawRegionMode&&m_leftMouseButtonDown&&(point=m_map.displayToMap(m_lastMousePos.x,m_lastMousePos.y),m_clickLatLng=geo.latlng(point.y,point.x),m_this.setDrawRegion(point.y,point.x,point.y,point.x)),m_lastMousePos.x=m_currentMousePos.x,m_lastMousePos.y=m_currentMousePos.y,!1},this.handleMouseUp=function(event){var width=null,height=null,num=null;return m_this.updateRenderParams(),0===event.button&&(m_leftMouseButtonDown=!1,width=m_this.viewer().renderWindow().windowSize()[0],height=m_this.viewer().renderWindow().windowSize()[1],m_renderer=m_this.viewer().renderWindow().activeRenderer(),m_lastMousePos.x>=0&&m_lastMousePos.x<=width&&m_lastMousePos.y>=0&&m_lastMousePos.y<=height&&(num=m_picker.pick(m_lastMousePos.x,m_lastMousePos.y,m_renderer))),1===event.button&&(m_middileMouseButtonDown=!1),2===event.button&&(m_rightMouseButtonDown=!1,m_initRightBtnMouseDown=!1,m_useLastDirection=!1,m_lastDirection=null,m_this._computeCurrentMousePos(event)),!1},this.handleMouseOut=function(){return m_this.updateRenderParams(),m_leftMouseButtonDown?m_leftMouseButtonDown=!1:m_middileMouseButtonDown&&(m_middileMouseButtonDown=!1),m_rightMouseButtonDown&&(m_rightMouseButtonDown=!1,m_initRightBtnMouseDown=!1,m_this.zoom()),!1},this.handleMouseWheel=function(event){m_this.updateRenderParams();var deltaIsPositive,delta=event.originalEvent.wheelDeltaY/120,speed=.05;return deltaIsPositive=delta>=0?!0:!1,delta=Math.pow(1+Math.abs(delta)/2,delta>0?-1:1),delta*=speed,m_this._computeCurrentMousePos(event),m_this.zoom(delta,!deltaIsPositive),!1},this.handleDoubleClick=function(){return m_this.zoom(.5,!1),!1},this._syncZoom=function(val,dir){var i,renderers,pos,fp,cam,clipRange,gap,minGap=.01;for(m_this.updateRenderParams(),val&&(m_camera.zoom(val,dir),dir&&(pos=m_camera.position(),fp=m_camera.focalPoint(),m_camera.setFocalPoint(pos[0],pos[1],fp[2])),m_renderer.resetCameraClippingRange()),pos=m_camera.position(),fp=m_camera.focalPoint(),gap=vec3.distance(pos,fp),dir||(dir=m_camera.directionOfProjection()),clipRange=m_camera.clippingRange(),vec3.dot(dir,m_camera.directionOfProjection())>0&&(Math.abs(gap)<minGap||clipRange[0]<minGap)&&(pos[0]=fp[0]+minGap*dir[0],pos[1]=fp[1]+minGap*dir[1],pos[2]=fp[2]-minGap*dir[2],m_camera.setPosition(pos[0],pos[1],pos[2]),m_camera.setFocalPoint(pos[0],pos[1],fp[2]),m_renderer.resetCameraClippingRange()),pos=m_camera.position(),fp=m_camera.focalPoint(),renderers=m_renderWindow.renderers(),i=0;i<renderers.length;i+=1)cam=renderers[i].camera(),cam!==m_camera&&(cam.setPosition(pos[0],pos[1],pos[2]),cam.setFocalPoint(fp[0],fp[1],fp[2]),renderers[i].resetCameraClippingRange(),renderers[i].render())
},this._syncReset=function(){var i,renderers,pos,fp,zoom,center,cam,clippingRange;m_this.updateRenderParams(),zoom=m_map.zoom(),center=m_map.center(),fp=m_camera.focalPoint(),center=m_map.baseLayer().toLocal(geo.latlng(center[0],center[1])),center instanceof Object&&"x"in center&&"y"in center&&m_map.baseLayer()instanceof geo.osmLayer&&(m_camera.setPosition(center.x,center.y,computeCameraDistance(zoom)),m_camera.setFocalPoint(center.x,center.y,fp[2]),m_renderer.resetCameraClippingRange()),fp=m_camera.focalPoint(),pos=m_camera.position(),clippingRange=m_camera.clippingRange(),renderers=m_renderWindow.renderers();for(i=0;i<renderers.length;i+=1)cam=renderers[i].camera(),cam!==m_camera&&(cam.setPosition(pos[0],pos[1],pos[2]),cam.setFocalPoint(fp[0],fp[1],fp[2]),cam.setClippingRange(clippingRange[0],clippingRange[1]),renderers[i].render())},this._syncPan=function(){},this.zoom=function(val,zoomOut){var evt,newZoomLevel,oldZoomLevel,cameraPos,cameraFp,newPos,clickedWorldPoint,direction,focusDisplayPoint,maxZoomedOutDist=0,maxZoomedOut=!1;m_this.updateRenderParams(),m_zTrans=(m_currentMousePos.y-m_lastMousePos.y)/m_height,void 0===val&&(val=2*Math.abs(m_zTrans)),oldZoomLevel=computeZoomLevel(),focusDisplayPoint=m_renderer.focusDisplayPoint(),clickedWorldPoint=m_renderWindow.displayToWorld(m_currentMousePos.x,m_currentMousePos.y,focusDisplayPoint,m_renderer),cameraPos=m_camera.position(),cameraFp=m_camera.focalPoint(),direction=[clickedWorldPoint[0]-cameraPos[0],clickedWorldPoint[1]-cameraPos[1],clickedWorldPoint[2]-cameraPos[2]],vec3.normalize(direction,direction),m_useLastDirection?direction=m_lastDirection.slice(0):m_lastDirection=direction.slice(0),(m_lastMousePos.y-m_currentMousePos.y<0||zoomOut)&&(direction[0]=-direction[0],direction[1]=-direction[1],direction[2]=-direction[2]),cameraPos[2]*Math.sin(m_camera.viewAngle())>=360&&zoomOut?maxZoomedOut=!0:(this._syncZoom(val,direction),newZoomLevel=computeZoomLevel()),cameraPos=m_camera.position(),cameraFp=m_camera.focalPoint(),(maxZoomedOut||cameraPos[2]*Math.sin(m_camera.viewAngle())>=360)&&(maxZoomedOut=!1,maxZoomedOutDist=computeCameraDistance(0),newPos=[(maxZoomedOutDist-cameraPos[2])*direction[0]/direction[2],(maxZoomedOutDist-cameraPos[2])*direction[1]/direction[2]],m_camera.setPosition(cameraPos[0]+newPos[0],cameraPos[1]+newPos[1],maxZoomedOutDist),m_camera.setFocalPoint(cameraPos[0]+newPos[0],cameraPos[1]+newPos[1],cameraFp[2]),m_renderer.resetCameraClippingRange(),newZoomLevel=0,this._syncZoom()),evt={type:geo.event.zoom,curr_zoom:newZoomLevel,last_zoom:oldZoomLevel},$(m_this).trigger(evt)},this.lastMousePosition=function(newPosition){return void 0!==newPosition?(m_lastMousePos=newPosition,m_this):m_lastMousePos},this.leftMouseDown=function(newValue){return void 0!==newValue?(m_leftMouseButtonDown=newValue,m_this):m_leftMouseButtonDown},this.setDrawRegion=function(lat1,lon1,lat2,lon2){var evt,plane=geo.planeFeature(geo.latlng(lat1,lon1),geo.latlng(lat2,lon2),99);return m_map.removeLayer(m_drawRegionLayer),m_drawRegionLayer=geo.featureLayer({opacity:.5,showAttribution:1},plane),m_map.addLayer(m_drawRegionLayer),evt=jQuery.Event(geo.event.updateDrawRegionEvent),$(m_this).trigger(geo.command.updateDrawRegionEvent,evt),m_this},this.getDrawRegion=function(){return m_drawRegionLayer.features()[0].getCoords()},this._computeCurrentMousePos=function(event){void 0!==event.pageX&&void 0!==event.pageY&&(m_this.updateRenderParams(),m_outsideCanvas=!1,m_coords=m_this.viewer().relMouseCoords(event),m_coords.x<0||m_coords.x>m_width?(m_currentMousePos.x=0,m_outsideCanvas=!0):m_currentMousePos.x=m_coords.x,m_coords.y<0||m_coords.y>m_height?(m_currentMousePos.y=0,m_outsideCanvas=!0):m_currentMousePos.y=m_coords.y)},this.updateRenderParams=function(){m_renderWindow=m_this.viewer().renderWindow(),m_width=m_renderWindow.windowSize()[0],m_height=m_renderWindow.windowSize()[1],m_renderer=m_this.viewer().renderWindow().activeRenderer(),m_camera=m_renderer.camera(),m_focusDisplayPoint=m_renderWindow.focusDisplayPoint(),m_updateRenderParamsTime.modified()},this.reset=function(){var evt,zoom;m_map&&(zoom=m_map.zoom(),m_this._syncReset(),evt={type:geo.event.zoom,curr_zoom:zoom,last_zoom:zoom},$(m_this).trigger(evt))},this},inherit(ggl.mapInteractorStyle,vgl.interactorStyle),ggl._vglViewerInstance=null,ggl.vglViewerInstance=function(){"use strict";var canvas;return null===ggl._vglViewerInstance&&(canvas=$(document.createElement("canvas")),canvas.attr("class",".webgl-canvas"),ggl._vglViewerInstance=vgl.viewer(canvas.get(0)),ggl._vglViewerInstance.renderWindow().removeRenderer(ggl._vglViewerInstance.renderWindow().activeRenderer()),ggl._vglViewerInstance.setInteractorStyle(ggl.mapInteractorStyle()),ggl._vglViewerInstance.init()),ggl._vglViewerInstance},ggl.vglRenderer=function(arg){"use strict";if(!(this instanceof ggl.vglRenderer))return new ggl.vglRenderer(arg);ggl.renderer.call(this,arg);var m_this=this,m_viewer=ggl.vglViewerInstance(),m_contextRenderer=vgl.renderer(),m_width=0,m_height=0,s_init=this._init;return m_contextRenderer.setResetScene(!1),this.displayToWorld=function(input){var i,delta,output,temp,point,ren=m_this.contextRenderer(),cam=ren.camera(),fdp=ren.focusDisplayPoint();if(input instanceof Array&&input.length>0)if(output=[],input[0]instanceof Object)for(delta=1,i=0;i<input.length;i+=delta)point=input[i],temp=ren.displayToWorld(vec4.fromValues(point.x,point.y,fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push({x:temp[0],y:temp[1],z:temp[2],w:temp[3]});else if(input[0]instanceof Array)for(delta=1,i=0;i<input.length;i+=delta)point=input[i],temp=ren.displayToWorld(vec4.fromValues(point[0],point[1],fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp);else for(delta=input.length%3===0?3:2,i=0;i<input.length;i+=delta)temp=ren.displayToWorld(vec4.fromValues(input[i],input[i+1],fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]),output.push(temp[3]);else{if(!(input instanceof Object))throw"Display to world conversion requires array of 2D/3D points";output={},temp=ren.displayToWorld(vec4.fromValues(input.x,input.y,fdp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output={x:temp[0],y:temp[1],z:temp[2],w:temp[3]}}return output},this.worldToDisplay=function(input){var i,temp,delta,ren=m_this.contextRenderer(),cam=ren.camera(),fp=cam.focalPoint(),output=[];if(input instanceof Array&&input.length>0)if(output=[],input[0]instanceof Object)for(delta=1,i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i].x,input[i].y,fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output[i]={x:temp[0],y:temp[1],z:temp[2]};else if(input[0]instanceof Array)for(delta=1,i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i][0],input[i][1],fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output[i].push(temp);else if(delta=input.length%3===0?3:2,2===delta)for(i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i],input[i+1],fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]);else for(i=0;i<input.length;i+=delta)temp=ren.worldToDisplay(vec4.fromValues(input[i],input[i+1],input[i+2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output.push(temp[0]),output.push(temp[1]),output.push(temp[2]);else{if(!(input instanceof Object))throw"World to display conversion requires array of 2D/3D points";temp=ren.worldToDisplay(vec4.fromValues(input.x,input.y,fp[2],1),cam.viewMatrix(),cam.projectionMatrix(),m_width,m_height),output={x:temp[0],y:temp[1],z:temp[2]}}return output},this.contextRenderer=function(){return m_contextRenderer},this.api=function(){return"vgl"},this.reset=function(){m_viewer.interactorStyle().reset()},this._init=function(){return m_this.initialized()?m_this:(s_init.call(m_this),m_this.canvas($(m_viewer.canvas())),m_viewer.renderWindow().renderers().length>0&&(m_contextRenderer.setLayer(m_viewer.renderWindow().renderers().length),m_contextRenderer.setResetScene(!1)),m_viewer.renderWindow().addRenderer(m_contextRenderer),m_this.layer().node().append(m_this.canvas()),$(m_viewer.interactorStyle()).on(geo.event.pan,function(event){m_this.trigger(geo.event.pan,event)}),$(m_viewer.interactorStyle()).on(geo.event.zoom,function(event){m_this.trigger(geo.event.zoom,event)}),m_this)},this._connectMapEvents=function(){if(m_this.layer().referenceLayer()){var map=$(m_this.layer().map().node()),wheel="onwheel"in map?"wheel":void 0!==document.onmousewheel?"mousewheel":"MozMousePixelScroll",wheelDelta="wheel"===wheel?function(evt){return evt.originalEvent.deltaY*(evt.originalEvent.deltaMode?120:1)}:"mousewheel"===wheel?function(evt){return evt.originalEvent.wheelDelta}:function(evt){return-evt.originalEvent.detail};m_viewer.unbindEventHandlers(),map.on(wheel,function(event){event.originalEvent.wheelDeltaY=wheelDelta(event),event.originalEvent.wheelDelta=event.originalEvent.wheelDeltaY,m_viewer.handleMouseWheel(event)}),map.on("mousemove",function(event){m_viewer.handleMouseMove(event)}),map.on("mouseup",function(event){m_viewer.handleMouseUp(event)}),map.on("mousedown",function(event){m_viewer.handleMouseDown(event)}),map.on("mouseout",function(event){var selection=$(map),offset=selection.offset(),width=selection.width(),height=selection.height(),x=event.pageX-offset.left,y=event.pageY-offset.top;(0>x||x>=width||0>y||y>=height)&&m_viewer.handleMouseOut(event)}),map.on("keypress",function(event){m_viewer.handleKeyPress(event)}),map.on("contextmenu",function(event){m_viewer.handleContextMenu(event)}),map.on("click",function(event){m_viewer.handleClick(event)}),map.on("dblclick",function(event){m_viewer.handleDoubleClick(event)})}m_viewer.interactorStyle().map(m_this.layer().map()),m_viewer.interactorStyle().reset()},this.on(geo.event.layerAdd,function(event){event.layer===m_this.layer()&&m_this._connectMapEvents()}),this._resize=function(x,y,w,h){return m_width=w,m_height=h,m_this.canvas().attr("width",w),m_this.canvas().attr("height",h),m_viewer.renderWindow().positionAndResize(x,y,w,h),m_this._render(),m_this},this._render=function(){return m_viewer.render(),m_this},this._exit=function(){},this},inherit(ggl.vglRenderer,ggl.renderer),geo.registerRenderer("vglRenderer",ggl.vglRenderer),gd3=ogs.namespace("geo.d3"),function(gd3){"use strict";var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",strLength=8;gd3.uniqueID=function(){var i,strArray=[];for(strArray.length=strLength,i=0;strLength>i;i+=1)strArray[i]=chars.charAt(Math.floor(Math.random()*chars.length));return strArray.join("")},geo.event.d3Rescale="geo.d3.rescale"}(gd3),gd3.object=function(arg){"use strict";if(!(this instanceof geo.object))return new gd3.object(arg);geo.sceneObject.call(this);var m_id="d3-"+gd3.uniqueID(),m_this=this,s_draw=this.draw;return this._d3id=function(){return m_id},this.select=function(){return m_this.renderer().select(m_this._d3id())},this.draw=function(){return m_this._update(),s_draw(),m_this},this._exit=function(){return m_this.renderer()._removeFeature(m_this._d3id())},this},inherit(gd3.object,geo.sceneObject),gd3.pointFeature=function(arg){"use strict";if(!(this instanceof gd3.pointFeature))return new gd3.pointFeature(arg);arg=arg||{},geo.pointFeature.call(this,arg),gd3.object.call(this);var d_attr,d_style,m_sticky,m_this=this,s_init=this._init,s_update=this._update,m_buildTime=geo.timestamp(),m_style={};return d_attr={cx:function(d){return d.x},cy:function(d){return d.y},r:1},d_style={fill:"black",stroke:"none"},m_style={attributes:d_attr,style:d_style},this._init=function(arg){return s_init.call(m_this,arg),m_sticky=m_this.layer().sticky(),m_this},this._build=function(){var data=m_this.positions()||[],s_style=m_this.style(),m_renderer=m_this.renderer();return data=m_renderer.worldToDisplay(data),s_update.call(m_this),data||(data=[]),m_style.id=m_this._d3id(),m_style.data=data,m_style.append="circle",m_style.style=$.extend({},d_style),m_style.attributes=$.extend({},d_attr),m_style.classes=["d3PointFeature"],m_style.style.fill=d3.rgb(255*s_style.color[0],255*s_style.color[1],255*s_style.color[2]),m_style.attributes.r=function(){var m_scale=m_renderer.scaleFactor();return(s_style.size/m_scale).toString()+"px"},m_style.style["fill-opacity"]=s_style.opacity,m_this.renderer()._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},m_this.on(geo.event.d3Rescale,function(){m_this.renderer().select(m_this._d3id()).attr("r",m_style.attributes.r)}),this._init(arg),this},inherit(gd3.pointFeature,geo.pointFeature),geo.registerFeature("d3","point",gd3.pointFeature),gd3.lineFeature=function(arg){"use strict";if(!(this instanceof gd3.lineFeature))return new gd3.lineFeature(arg);arg=arg||{},geo.lineFeature.call(this,arg),gd3.object.call(this);var m_this=this,s_init=this._init,m_buildTime=geo.timestamp(),s_update=this._update,m_style={};return m_style.style={},this._init=function(arg){return s_init.call(m_this,arg),m_this},this._build=function(){var data=m_this.positions()||[],s_style=m_this.style(),m_renderer=m_this.renderer(),line=d3.svg.line().x(function(d){return d.x}).y(function(d){return d.y});return s_update.call(m_this),data=m_renderer.worldToDisplay(data),m_style.data=[data],m_style.attributes={d:line},m_style.id=m_this._d3id(),m_style.append="path",m_style.classes=["d3LineFeature"],m_style.style={fill:"none",stroke:d3.rgb(255*s_style.color[0],255*s_style.color[1],255*s_style.color[2]),"stroke-width":function(){var m_scale=m_renderer.scaleFactor();return(s_style.width[0]/m_scale).toString()+"px"},"stroke-opacity":s_style.opacity},m_renderer._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},m_this.on(geo.event.d3Rescale,function(){m_this.renderer().select(m_this._d3id()).style("stroke-width",m_style.style["stroke-width"])}),this._init(arg),this},inherit(gd3.lineFeature,geo.lineFeature),geo.registerFeature("d3","line",gd3.lineFeature),gd3.pathFeature=function(arg){"use strict";if(!(this instanceof gd3.pathFeature))return new gd3.pathFeature(arg);arg=arg||{},geo.pathFeature.call(this,arg),gd3.object.call(this);var m_this=this,s_init=this._init,m_buildTime=geo.timestamp(),s_update=this._update,m_style={};return m_style.style={},this._init=function(arg){return s_init.call(m_this,arg),m_this},this._build=function(){var tmp,diag,data=m_this.positions()||[],s_style=m_this.style(),m_renderer=m_this.renderer();return s_update.call(m_this),diag=function(d){var p={source:d.source,target:d.target};return d3.svg.diagonal()(p)},tmp=[],data.forEach(function(d,i){var src,trg;i<data.length-1&&(src=d,trg=data[i+1],tmp.push({source:m_renderer.worldToDisplay(src),target:m_renderer.worldToDisplay(trg)}))}),m_style.data=tmp,m_style.attributes={d:diag},m_style.id=m_this._d3id(),m_style.append="path",m_style.classes=["d3PathFeature"],m_style.style={fill:"none",stroke:d3.rgb(255*s_style.color[0],255*s_style.color[1],255*s_style.color[2]),"stroke-width":function(){var m_scale=m_renderer.scaleFactor();return(s_style.width[0]/m_scale).toString()+"px"},"stroke-opacity":s_style.opacity},m_this.renderer()._drawFeatures(m_style),m_buildTime.modified(),m_this.updateTime().modified(),m_this},this._update=function(){return s_update.call(m_this),m_this.dataTime().getMTime()>=m_buildTime.getMTime()&&m_this._build(),m_this},m_this.on(geo.event.d3Rescale,function(){m_this.renderer().select(m_this._d3id()).style("stroke-width",m_style.style["stroke-width"])}),this._init(arg),this},inherit(gd3.pathFeature,geo.pathFeature),geo.registerFeature("d3","path",gd3.pathFeature),gd3.graphFeature=function(arg){"use strict";var m_this=this;return this instanceof gd3.graphFeature?(geo.graphFeature.call(this,arg),this.select=function(){var renderer=m_this.renderer(),selection={},node=m_this.nodeFeature(),links=m_this.linkFeatures();return selection.nodes=renderer.select(node._d3id()),selection.links=links.map(function(link){return renderer.select(link._d3id())}),selection},this):new gd3.graphFeature(arg)},inherit(gd3.graphFeature,geo.graphFeature),geo.registerFeature("d3","graph",gd3.graphFeature),gd3.d3Renderer=function(arg){"use strict";function setAttrs(select,attrs){var key;for(key in attrs)attrs.hasOwnProperty(key)&&select.attr(key,attrs[key])}function getMap(){var layer=m_this.layer();return layer?layer.map():null}function getGroup(){return m_svg.select(".group-"+m_this._d3id())}function initCorners(){var layer=m_this.layer(),map=layer.map(),width=m_this.layer().width(),height=m_this.layer().height();if(m_width=width,m_height=height,!m_width||!m_height)throw"Map layer has size 0";m_corners={upperLeft:map.displayToGcs({x:0,y:0}),lowerRight:map.displayToGcs({x:width,y:height})}}function setTransform(){if(m_corners||initCorners(),m_sticky){var dx,dy,scale,layer=m_this.layer(),map=layer.map(),upperLeft=map.gcsToDisplay(m_corners.upperLeft),lowerRight=map.gcsToDisplay(m_corners.lowerRight),group=getGroup();dx=upperLeft.x,dy=upperLeft.y,scale=(lowerRight.y-upperLeft.y)/m_height,group.attr("transform","matrix("+[scale,0,0,scale,dx,dy].join()+")"),m_scale=scale,m_dx=dx,m_dy=dy}}function baseToLocal(pt){return{x:(pt.x-m_dx)/m_scale,y:(pt.y-m_dy)/m_scale}}function localToBase(pt){return{x:pt.x*m_scale+m_dx,y:pt.y*m_scale+m_dy}}if(!(this instanceof gd3.d3Renderer))return new gd3.d3Renderer(arg);geo.renderer.call(this,arg),gd3.object.call(this,arg),arg=arg||{};var m_this=this,m_sticky=null,m_features={},m_corners=null,m_width=null,m_height=null,m_scale=1,m_dx=0,m_dy=0,m_svg=null;return this._init=function(){if(!m_this.canvas()){var canvas;m_svg=d3.select(m_this.layer().node().get(0)).append("svg"),canvas=m_svg.append("g"),m_sticky=m_this.layer().sticky(),m_svg.attr("class",m_this._d3id()),m_svg.attr("width",m_this.layer().node().width()),m_svg.attr("height",m_this.layer().node().height()),canvas.attr("class","group-"+m_this._d3id()),m_this.canvas(canvas)}},this.displayToWorld=function(pt){var map=getMap();if(!map)throw"Cannot project until this layer is connected to a map.";return pt=Array.isArray(pt)?pt.map(function(x){return map.displayToGcs(localToBase(x))}):map.displayToGcs(localToBase(pt))},this.worldToDisplay=function(pt){var map=getMap();if(!map)throw"Cannot project until this layer is connected to a map.";var v;return v=Array.isArray(pt)?pt.map(function(x){return baseToLocal(map.gcsToDisplay(x))}):baseToLocal(map.gcsToDisplay(pt))},this.api=function(){return"d3"},this.scaleFactor=function(){return m_scale},this._resize=function(x,y,w,h){m_corners||initCorners(),m_svg.attr("width",w),m_svg.attr("height",h),setTransform(),m_this.layer().trigger(geo.event.d3Rescale,{scale:m_scale},!0)},this._update=function(){},this._exit=function(){m_features={},m_this.canvas().remove()},this._drawFeatures=function(arg){return m_features[arg.id]={data:arg.data,index:arg.dataIndex,style:arg.style,attributes:arg.attributes,classes:arg.classes,append:arg.append},m_this._render(arg.id)},this._render=function(id){var key;if(void 0===id){for(key in m_features)m_features.hasOwnProperty(key)&&m_this._render(key);return m_this}var data=m_features[id].data,index=m_features[id].index,style=m_features[id].style,attributes=m_features[id].attributes,classes=m_features[id].classes,append=m_features[id].append,selection=m_this.select(id).data(data,index);return selection.enter().append(append),selection.exit().remove(),setAttrs(selection,attributes),selection.attr("class",classes.concat([id]).join(" ")),selection.style(style),m_this},this.select=function(id){return getGroup().selectAll("."+id)},this._removeFeature=function(id){return m_this.select(id).remove(),delete m_features[id],m_this},this.draw=function(){},this.on(geo.event.pan,setTransform),this.on(geo.event.zoom,function(){setTransform(),m_this.layer().trigger(geo.event.d3Rescale,{scale:m_scale},!0)}),this.on(geo.event.resize,function(event){m_this._resize(event.x,event.y,event.width,event.height)}),this._init(arg),this},inherit(gd3.d3Renderer,geo.renderer),geo.registerRenderer("d3Renderer",gd3.d3Renderer),geo.version="0.1.0";